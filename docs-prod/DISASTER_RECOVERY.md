# ディザスタリカバリ Runbook

**作成日**: 2026-01-31
**バージョン**: 1.0
**対象システム**: ITSM-Sec Nexus
**対象読者**: システム管理者、インシデント対応担当者

---

## 目次

1. [概要](#1-概要)
2. [RTO/RPO定義](#2-rtorpo定義)
3. [リストア手順（Web UI）](#3-リストア手順web-ui)
4. [リストア手順（CLI）](#4-リストア手順cli)
5. [緊急時対応フロー](#5-緊急時対応フロー)
6. [ロールバック手順](#6-ロールバック手順)
7. [連絡体制](#7-連絡体制)
8. [テスト計画](#8-テスト計画)

---

## 1. 概要

### 1.1 目的

本Runbookは、ITSM-Sec Nexusシステムに重大な障害が発生した際、迅速にデータベースをバックアップから復旧するための手順を定めます。

### 1.2 適用範囲

以下の障害シナリオに対応します。

| シナリオ | 重大度 | 対応 |
|---------|--------|------|
| データベースファイル完全消失 | Critical | 最新バックアップからのリストア |
| データベース破損 | Critical | 直近の正常バックアップからのリストア |
| 誤ったデータ削除 | High | 削除前の時点のバックアップからのリストア |
| アプリケーション障害によるデータ破損 | High | 正常動作時のバックアップからのリストア |
| ランサムウェア攻撃 | Critical | 感染前のバックアップからのリストア |

### 1.3 前提条件

- 有効なバックアップファイルが存在すること
- バックアップの整合性チェックが成功していること
- 管理者権限（Admin）を持つユーザーがいること
- システムへのアクセス権限（SSH/Web UI）があること

---

## 2. RTO/RPO定義

### 2.1 目標復旧時間（RTO: Recovery Time Objective）

**目標**: ≤ 15分

| フェーズ | 所要時間 | 説明 |
|---------|---------|------|
| 1. 障害検知 | 1分 | 監視アラート、ユーザー報告 |
| 2. 影響範囲確認 | 2分 | ログ確認、データベース状態確認 |
| 3. バックアップ選択 | 1分 | 最新の正常バックアップを選択 |
| 4. リストア実行 | 8分 | ファイル解凍、整合性チェック、リストア |
| 5. 動作確認 | 2分 | ヘルスチェック、基本機能確認 |
| 6. 余裕 | 1分 | 予期しない遅延への対応 |
| **合計** | **≤ 15分** | |

### 2.2 目標復旧時点（RPO: Recovery Point Objective）

**目標**: ≤ 24時間

| バックアップ種別 | RPO | 説明 |
|----------------|-----|------|
| 日次バックアップ | ≤ 24時間 | 最大1日分のデータ損失 |
| 手動バックアップ | ≤ 数時間 | デプロイ前実行で損失最小化 |

---

## 3. リストア手順（Web UI）

### 3.1 事前確認

#### ステップ1: バックアップ一覧確認

1. ブラウザで以下にアクセス:
   ```
   https://192.168.0.187:6443/views/backup.html
   ```

2. 管理者アカウントでログイン

3. バックアップ一覧テーブルを確認:
   - ステータスが「成功」のバックアップを確認
   - 最新のバックアップ日時を確認
   - ファイルサイズが妥当か確認

#### ステップ2: バックアップ詳細確認

1. リストアしたいバックアップ行をクリック
2. 詳細情報を確認:
   - バックアップID
   - 作成日時
   - ファイルパス
   - チェックサム
   - 整合性チェック結果

### 3.2 リストア実行

#### ステップ3: リストア開始

1. バックアップ一覧で対象バックアップの「リストア」ボタンをクリック

2. 警告ダイアログが表示される:
   ```
   ⚠️ 警告: データベースリストア

   この操作により、現在のデータベースが以下のバックアップで上書きされます：
   - バックアップ日時: 2026-01-31 02:00:15
   - ファイルサイズ: 3.2 MB

   現在のデータベースは自動的にバックアップされますが、
   念のため重要なデータが保存されていることを確認してください。

   本当にリストアを実行しますか？
   [キャンセル] [実行]
   ```

3. 「実行」ボタンをクリック

#### ステップ4: リストア進行状況確認

プログレスバーで以下のフェーズを確認:

```
1. バックアップファイル検証中...           [█████░░░░░] 25%
2. 整合性チェック実行中...                 [███████░░░] 50%
3. 現在のDBを退避中...                     [█████████░] 75%
4. リストア実行中...                       [██████████] 100%
```

#### ステップ5: リストア完了確認

1. 成功メッセージが表示される:
   ```
   ✓ リストア完了

   データベースが正常にリストアされました。
   - リストア元: BKP-20260131-020015-daily
   - リストア日時: 2026-01-31 15:05:35
   - 退避バックアップ: /backups/before_restore/itsm_nexus_before_restore_20260131_150530.db.gz

   [OK]
   ```

2. ダッシュボードに移動してデータを確認

### 3.3 動作確認

#### ステップ6: 基本機能確認

1. **ダッシュボード確認**:
   - KPI統計が表示されるか
   - チャートが正常に描画されるか

2. **インシデント一覧確認**:
   - インシデント一覧が表示されるか
   - データが欠落していないか

3. **ログイン確認**:
   - 管理者アカウントでログインできるか
   - 一般ユーザーでログインできるか

4. **API確認**:
   ```bash
   curl -k https://localhost:6443/api/v1/health
   ```

   期待するレスポンス:
   ```json
   {
     "status": "ok",
     "timestamp": "2026-01-31T15:10:00Z",
     "database": "connected"
   }
   ```

---

## 4. リストア手順（CLI）

### 4.1 事前確認

#### ステップ1: 最新バックアップ確認

```bash
# 日次バックアップの最新5件を表示
ls -lth /backups/daily/ | head -6

# 出力例:
# total 96M
# -rw------- 1 root root 3.2M Jan 31 02:00 itsm_nexus_daily_20260131_020015.db.gz
# -rw------- 1 root root 3.1M Jan 30 02:00 itsm_nexus_daily_20260130_020012.db.gz
# -rw------- 1 root root 3.0M Jan 29 02:00 itsm_nexus_daily_20260129_020018.db.gz
```

#### ステップ2: バックアップファイル整合性確認

```bash
# チェックサム確認
sha256sum /backups/daily/itsm_nexus_daily_20260131_020015.db.gz

# 解凍テスト
gunzip -t /backups/daily/itsm_nexus_daily_20260131_020015.db.gz

# "OK" が表示されればファイルは正常
```

### 4.2 リストア実行

#### ステップ3: システム停止

```bash
# サービス停止
sudo systemctl stop itsm-nexus-prod

# 停止確認
sudo systemctl status itsm-nexus-prod

# "Active: inactive (dead)" が表示されることを確認
```

#### ステップ4: リストアスクリプト実行

```bash
# リストアスクリプトの場所に移動
cd /mnt/LinuxHDD/ITSM-System

# 最新のバックアップからリストア
sudo ./scripts/Linux/operations/restore.sh --latest

# または、特定のバックアップを指定
sudo ./scripts/Linux/operations/restore.sh --file /backups/daily/itsm_nexus_daily_20260131_020015.db.gz
```

#### 対話型確認

スクリプトが確認を求めます:

```
===============================================
  WARNING: データベースリストア
===============================================
リストア元: /backups/daily/itsm_nexus_daily_20260131_020015.db.gz
バックアップ作成日時: 2026-01-31 02:00:15
ファイルサイズ: 3.2 MB

このリストアにより、現在のデータベースは上書きされます。
現在のデータベースは自動的にバックアップされますが、念のため確認してください。

本当にリストアを実行しますか？ (yes/no):
```

**`yes`** と入力してEnterキーを押す

#### ステップ5: リストア進行確認

```
[2026-01-31 15:05:30] Starting database restore
[2026-01-31 15:05:31] Backup file: /backups/daily/itsm_nexus_daily_20260131_020015.db.gz
[2026-01-31 15:05:32] Decompressing backup...
[2026-01-31 15:05:34] Running integrity check...
[2026-01-31 15:05:35] Integrity check: OK
[2026-01-31 15:05:36] Creating safety backup of current database...
[2026-01-31 15:05:39] Safety backup: /backups/before_restore/itsm_nexus_before_restore_20260131_150530.db.gz
[2026-01-31 15:05:40] Stopping ITSM services...
[2026-01-31 15:05:45] Services stopped
[2026-01-31 15:05:46] Replacing database file...
[2026-01-31 15:05:47] Database replaced successfully
[2026-01-31 15:05:48] Starting ITSM services...
[2026-01-31 15:05:53] Services started
[2026-01-31 15:05:54] Running verification queries...
[2026-01-31 15:05:55] Verification: SUCCESS
[2026-01-31 15:05:56] Restore completed successfully
[2026-01-31 15:05:56] Database restored to: 2026-01-31 02:00:15
```

### 4.3 システム起動

#### ステップ6: サービス起動

```bash
# サービス起動
sudo systemctl start itsm-nexus-prod

# 起動確認
sudo systemctl status itsm-nexus-prod

# "Active: active (running)" が表示されることを確認
```

### 4.4 動作確認

#### ステップ7: ヘルスチェック

```bash
# APIヘルスチェック
curl -k https://localhost:6443/api/v1/health

# 期待するレスポンス:
{
  "status": "ok",
  "timestamp": "2026-01-31T15:10:00Z",
  "database": "connected"
}
```

#### ステップ8: データベース確認

```bash
# データベース接続確認
sqlite3 /mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db \
  "SELECT COUNT(*) FROM sqlite_master;"

# テーブル数が表示されれば正常
# 例: 25（テーブル数）
```

#### ステップ9: ログ確認

```bash
# 最新50行のログを確認
sudo journalctl -u itsm-nexus-prod -n 50

# エラーがないことを確認
```

---

## 5. 緊急時対応フロー

### 5.1 障害検知

#### トリガー

- **監視アラート**: Prometheus/Grafanaアラート
- **ユーザー報告**: ログイン不可、データ表示エラー
- **ヘルスチェック失敗**: `/api/v1/health` が応答しない

#### 初動対応（1分以内）

```bash
# 1. サービス状態確認
sudo systemctl status itsm-nexus-prod

# 2. プロセス確認
ps aux | grep node

# 3. データベースファイル確認
ls -lh /mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db

# 4. ログ確認
sudo journalctl -u itsm-nexus-prod -n 100 | tail -50
```

### 5.2 影響範囲確認（2分以内）

#### チェックリスト

| 項目 | コマンド | 判断基準 |
|------|---------|---------|
| サービス稼働 | `systemctl status itsm-nexus-prod` | Active: active (running) |
| データベースファイル存在 | `ls -lh backend/itsm_nexus.db` | ファイルが存在 |
| データベース破損 | `sqlite3 backend/itsm_nexus.db "PRAGMA integrity_check;"` | "ok" が返る |
| ディスク容量 | `df -h /mnt/LinuxHDD` | 使用率 < 95% |
| メモリ | `free -h` | Available > 500MB |

#### 判断フロー

```
データベースファイル存在？
├─ NO → Critical: データベース消失 → 即座にリストア実行
└─ YES → データベース破損確認
    ├─ 破損あり → Critical: データベース破損 → リストア実行
    └─ 破損なし → アプリケーション障害 → サービス再起動
```

### 5.3 リストア判断基準

| 障害レベル | 説明 | 対応 | 承認 |
|----------|------|------|------|
| **Critical** | データベース消失・完全破損 | 即座にリストア | 承認不要（緊急対応） |
| **High** | データ一部破損・重要データ削除 | リストア推奨 | システム管理者承認 |
| **Medium** | 軽微なデータ破損 | バックアップから手動復旧 | - |
| **Low** | アプリケーション障害のみ | サービス再起動 | - |

### 5.4 実行判断ツリー

```
障害レベルは？
├─ Critical
│  └─ 即座にリストア実行（承認不要）
│     └─ [4. リストア手順（CLI）](#4-リストア手順cli) へ
│
├─ High
│  └─ システム管理者に連絡
│     ├─ 承認取得
│     │  └─ リストア実行
│     └─ 承認待機中
│        └─ サービス停止（被害拡大防止）
│
└─ Medium/Low
   └─ サービス再起動
      ├─ 成功 → 正常化
      └─ 失敗 → 障害レベル再評価
```

---

## 6. ロールバック手順

### 6.1 リストア失敗時の対応

#### シナリオ1: 整合性チェック失敗

**症状**: リストア中に整合性チェックでエラー

**対応**:

```bash
# 1. リストアを中止（自動的に中止される）
# 2. 別のバックアップを選択
ls -lth /backups/daily/ | head -10

# 3. 1つ前のバックアップでリストア実行
sudo ./scripts/Linux/operations/restore.sh \
  --file /backups/daily/itsm_nexus_daily_20260130_020012.db.gz
```

#### シナリオ2: リストア後の動作確認で異常検出

**症状**: リストアは成功したが、アプリケーションが正常動作しない

**対応**:

```bash
# 1. サービス停止
sudo systemctl stop itsm-nexus-prod

# 2. リストア前に退避したバックアップに戻す
sudo cp /backups/before_restore/itsm_nexus_before_restore_20260131_150530.db.gz \
  /mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db.gz

# 3. 解凍
sudo gunzip -f /mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db.gz

# 4. サービス起動
sudo systemctl start itsm-nexus-prod

# 5. 動作確認
curl -k https://localhost:6443/api/v1/health
```

#### シナリオ3: ディスク容量不足でリストア失敗

**症状**: リストア中にディスク容量不足エラー

**対応**:

```bash
# 1. 不要なファイルを削除
sudo rm /backups/manual/itsm_nexus_manual_YYYYMMDD_HHMMSS.db.gz

# 2. 容量確認
df -h /mnt/LinuxHDD

# 3. 十分な容量が確保できたらリストア再実行
sudo ./scripts/Linux/operations/restore.sh --latest
```

### 6.2 ロールバック判断基準

| 時間 | 状況 | 判断 |
|------|------|------|
| リストア開始から5分以内 | 整合性チェック失敗 | 即座に中止、別バックアップ選択 |
| リストア完了直後 | ヘルスチェック失敗 | 退避バックアップに戻す |
| リストア完了から10分以内 | アプリケーション異常 | 退避バックアップに戻す |
| リストア完了から10分超過 | データ不整合検出 | 再度リストア実行（正しいバックアップを選択） |

---

## 7. 連絡体制

### 7.1 エスカレーションフロー

```
レベル1: 一次対応（5分以内）
├─ 担当: 運用担当者
├─ 対応: 障害検知、影響範囲確認
└─ エスカレーション条件: Critical障害、15分以内に復旧見込みなし

レベル2: システム管理者（10分以内）
├─ 担当: システム管理者
├─ 対応: リストア判断、リストア実行
└─ エスカレーション条件: リストア失敗、複数回試行で復旧できず

レベル3: 上級管理者・ベンダー（30分以内）
├─ 担当: CTO、ITマネージャー、ベンダーサポート
├─ 対応: 根本原因調査、代替手段検討
└─ エスカレーション条件: 1時間以内に復旧見込みなし
```

### 7.2 連絡先リスト

| 役割 | 担当者名 | 連絡先（電話） | 連絡先（Email） | 対応時間 |
|------|---------|---------------|----------------|---------|
| 運用担当者（一次） | （名前） | XXX-XXXX-XXXX | ops@example.com | 24/7 |
| システム管理者 | （名前） | XXX-XXXX-XXXX | admin@example.com | 24/7 |
| ITマネージャー | （名前） | XXX-XXXX-XXXX | manager@example.com | 平日9-18時 |
| ベンダーサポート | ITSM Nexus Support | XXX-XXXX-XXXX | support@itsm-nexus.com | 24/7 |

### 7.3 通知テンプレート

#### 障害発生通知

```
件名: [CRITICAL] ITSM-Sec Nexus データベース障害

発生日時: 2026-01-31 15:00:00
障害レベル: Critical
障害内容: データベースファイル消失
影響範囲: 全ユーザーがシステム利用不可
対応状況: リストア作業中
復旧見込み: 15:15（15分以内）

担当者: 運用担当 山田太郎
連絡先: yamada@example.com / 090-XXXX-XXXX
```

#### 復旧完了通知

```
件名: [RESOLVED] ITSM-Sec Nexus 復旧完了

発生日時: 2026-01-31 15:00:00
復旧日時: 2026-01-31 15:12:00
ダウンタイム: 12分
復旧方法: 日次バックアップ（2026-01-31 02:00）からのリストア
データ損失: 最大13時間分のデータ（02:00〜15:00）

動作確認:
✓ ヘルスチェック: 正常
✓ ログイン: 正常
✓ インシデント一覧: 正常

今後の対応:
- 根本原因調査（担当: システム管理者）
- 再発防止策の検討
- バックアップ頻度の見直し

担当者: システム管理者 佐藤花子
連絡先: sato@example.com / 080-XXXX-XXXX
```

---

## 8. テスト計画

### 8.1 定期リストアテスト

#### 実施頻度

- **月次テスト**: 毎月第1日曜日 03:00〜04:00
- **四半期テスト**: 各四半期末（3月/6月/9月/12月）の日曜日

#### テスト環境

本番環境への影響を避けるため、別の環境でテストを実施します。

```bash
# テスト用ディレクトリ作成
sudo mkdir -p /tmp/restore-test
cd /tmp/restore-test

# バックアップをコピー
sudo cp /backups/daily/itsm_nexus_daily_YYYYMMDD_HHMMSS.db.gz .

# 解凍
sudo gunzip itsm_nexus_daily_YYYYMMDD_HHMMSS.db.gz

# 整合性チェック
sqlite3 itsm_nexus_daily_YYYYMMDD_HHMMSS.db "PRAGMA integrity_check;"

# クリーンアップ
cd /
sudo rm -rf /tmp/restore-test
```

### 8.2 テスト手順

#### フルリストアテスト（四半期）

| ステップ | 手順 | 成功基準 | 所要時間 |
|---------|------|---------|---------|
| 1 | テスト環境準備 | 環境が正常に起動 | 5分 |
| 2 | 最新バックアップ選択 | バックアップファイルが存在 | 1分 |
| 3 | リストア実行 | エラーなく完了 | 8分 |
| 4 | 整合性チェック | "ok"が返る | 1分 |
| 5 | アプリケーション起動 | サービスが起動 | 2分 |
| 6 | 動作確認 | ログイン、データ表示正常 | 3分 |
| **合計** | | **全ステップ成功** | **20分** |

#### 簡易テスト（月次）

```bash
# 月次簡易テスト
./scripts/backup-test.sh --latest

# チェック項目:
# 1. バックアップファイル存在
# 2. ファイルサイズ妥当性
# 3. 解凍テスト
# 4. チェックサム検証
# 5. PRAGMA integrity_check
```

### 8.3 テスト結果記録

#### テスト報告書テンプレート

```markdown
# リストアテスト報告書

**実施日時**: 2026-01-31 03:00〜03:20
**テスト種別**: 四半期フルリストアテスト
**テスト環境**: ステージング環境
**担当者**: 佐藤花子

## テスト結果

| ステップ | 結果 | 所要時間 | 備考 |
|---------|------|---------|------|
| 1. 環境準備 | ✓ PASS | 4分 | - |
| 2. バックアップ選択 | ✓ PASS | 1分 | 最新バックアップ使用 |
| 3. リストア実行 | ✓ PASS | 7分 | - |
| 4. 整合性チェック | ✓ PASS | 1分 | "ok" |
| 5. アプリケーション起動 | ✓ PASS | 2分 | - |
| 6. 動作確認 | ✓ PASS | 3分 | 全機能正常 |

**合計所要時間**: 18分
**RTO目標達成**: ✓ YES（目標15分に対し18分、テスト環境のため許容範囲）

## 発見事項

- 特になし

## 改善提案

- 特になし

## 次回テスト予定

- 2026-04-30（Q2テスト）
```

---

## 付録

### A. よくある質問（FAQ）

#### Q1: リストア中にシステムを使用できますか？

**A**: いいえ、リストア中はシステムが停止します。ユーザーには事前に通知してください。

#### Q2: リストア後、最新のデータが失われますか？

**A**: はい、バックアップ作成時点以降のデータは失われます。日次バックアップ（02:00 AM）を使用した場合、最大24時間分のデータが失われる可能性があります。

#### Q3: 手動バックアップを事前に実行すべきですか？

**A**: はい、重要な作業（デプロイ、大規模変更）の前には手動バックアップを推奨します。

#### Q4: リストアにどのくらい時間がかかりますか？

**A**: 通常、10〜15分以内に完了します。データベースサイズによって変動します。

#### Q5: 複数のバックアップを試すことはできますか？

**A**: はい、1つのバックアップで復旧できない場合、別のバックアップを試すことができます。

### B. チェックリスト

#### リストア前チェックリスト

- [ ] バックアップファイルの存在確認
- [ ] バックアップの整合性確認
- [ ] ディスク容量の確認（DB容量×2以上）
- [ ] ユーザーへの事前通知
- [ ] 管理者権限の確認
- [ ] エスカレーション先の確認

#### リストア後チェックリスト

- [ ] サービス起動確認
- [ ] ヘルスチェック成功
- [ ] ログイン動作確認
- [ ] ダッシュボード表示確認
- [ ] インシデント一覧表示確認
- [ ] ログにエラーがないことを確認
- [ ] ユーザーへの復旧通知

### C. トラブルシューティング

詳細は [BACKUP_OPERATIONS.md - トラブルシューティング](BACKUP_OPERATIONS.md#8-トラブルシューティング) を参照してください。

### D. 関連ドキュメント

- [バックアップ運用ガイド](BACKUP_OPERATIONS.md)
- [Systemd自動起動設定ガイド](SYSTEMD_SETUP.md)
- [バックアップアーキテクチャ設計書](../docs-dev/BACKUP_ARCHITECTURE.md)
- [要件定義書](../specs/phase9-1-backup-requirements.md)

---

**ドキュメント履歴**:
- 2026-01-31: 初版作成
