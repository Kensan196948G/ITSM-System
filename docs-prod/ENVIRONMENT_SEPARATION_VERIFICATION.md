# 環境分離 検証レポート

## 📊 検証概要

**実施日**: 2026-01-31
**対象システム**: ITSM-Sec Nexus
**検証目的**: 開発環境と本番環境の完全分離を確認

---

## ✅ 検証項目と結果

### 1. 環境設定ファイルの分離

| 項目 | 開発環境 | 本番環境 | 状態 |
|------|----------|----------|------|
| **設定ファイル** | `config/env/.env.development` | `config/env/.env.production` | ✅ 分離済 |
| **NODE_ENV** | development | production | ✅ 異なる |
| **HTTPSポート** | 5443 | 6443 | ✅ 異なる |
| **データベースパス** | `./backend/itsm_nexus_dev.db` | `./backend/itsm_nexus_prod.db` | ✅ 分離済 |
| **JWT_SECRET** | 開発用固定値 | 本番用（要強化） | ⚠️ 要設定 |
| **ログレベル** | debug | info | ✅ 異なる |
| **サンプルデータ** | 有効 | 無効 | ✅ 異なる |
| **Rate Limiting** | 1000 req/min | 100 req/min | ✅ 異なる |

**結論**: 環境設定は適切に分離されています。本番環境のJWT_SECRETは実運用前に強力な値に変更してください。

---

### 2. データベース分離

#### データベースファイル構成

```
backend/
├── itsm_nexus.db          # シンボリックリンク（現在の環境）
├── itsm_nexus_dev.db      # 開発環境専用 ✅
├── itsm_nexus_prod.db     # 本番環境専用 ✅
```

#### データベース切り替え検証

**テストケース1: 開発環境への切り替え**

```bash
$ ./scripts/switch-env.sh dev
```

**期待される動作:**
1. `itsm_nexus.db` が `itsm_nexus_dev.db` へのシンボリックリンクになる
2. データベース操作が開発用DBに反映される

**結果**: ✅ 正常動作

**テストケース2: 本番環境への切り替え**

```bash
$ ./scripts/switch-env.sh prod
```

**期待される動作:**
1. 確認プロンプト表示（"yes"入力が必要）
2. 自動バックアップ作成
3. `itsm_nexus.db` が `itsm_nexus_prod.db` へのシンボリックリンクになる

**結果**: ✅ 正常動作（確認プロンプトも機能）

---

### 3. サービス分離

| 項目 | 開発環境 | 本番環境 | 状態 |
|------|----------|----------|------|
| **systemdサービス名** | itsm-sec-nexus-dev | itsm-sec-nexus-prod | ✅ 独立 |
| **プロセス独立性** | 別プロセス | 別プロセス | ✅ 独立 |
| **ポート競合** | なし（5443） | なし（6443, 8080） | ✅ なし |
| **並行稼働** | 可能 | 可能 | ✅ 可能 |

**並行稼働テスト:**

```bash
# 両方のサービスを起動
sudo systemctl start itsm-sec-nexus-dev
sudo systemctl start itsm-sec-nexus-prod

# 状態確認
$ sudo systemctl status itsm-sec-nexus-dev
Active: active (running)

$ sudo systemctl status itsm-sec-nexus-prod
Active: active (running)
```

**結果**: ✅ 両環境が独立して稼働可能

---

### 4. 誤操作防止機構

#### 4.1 確認プロンプト

**テストケース: 本番環境への切り替え**

```bash
$ ./scripts/switch-env.sh prod

⚠️  警告: 本番環境に切り替えようとしています
本番環境での操作は慎重に行ってください
本番環境に切り替えますか? (yes/NO):
```

**動作確認:**
- "yes" 以外の入力 → キャンセル ✅
- "y" のみ → キャンセル ✅
- "yes" → 切り替え実行 ✅

**結果**: ✅ 誤操作防止機構が正常動作

#### 4.2 環境バナー表示

```bash
$ ./scripts/env-guard.sh --show-banner
```

**開発環境の場合:**
```
╔════════════════════════════════════════════╗
║                                            ║
║      開発環境 (DEVELOPMENT MODE)          ║
║                                            ║
╚════════════════════════════════════════════╝
```

**本番環境の場合:**
```
╔════════════════════════════════════════════╗
║                                            ║
║    ⚠️  本番環境 (PRODUCTION MODE) ⚠️     ║
║                                            ║
║    すべての操作は慎重に行ってください    ║
║                                            ║
╚════════════════════════════════════════════╝
```

**結果**: ✅ 視覚的な環境識別が可能

#### 4.3 デプロイ前チェック

```bash
$ ./scripts/env-guard.sh --check
```

**チェック項目:**
- ✅ .envファイルの存在
- ✅ 必須環境変数の設定
- ⚠️ JWT_SECRETの強度（本番環境では要改善）
- ✅ SSL証明書の存在
- ✅ node_modulesの存在

**結果**: ⚠️ 本番環境のJWT_SECRETは実運用前に強化が必要

---

### 5. バックアップ機能

**テストケース: 本番環境切り替え時の自動バックアップ**

```bash
$ ./scripts/switch-env.sh prod
```

**期待される動作:**
- `backups/itsm_nexus_prod_backup_YYYYMMDD_HHMMSS.db` が作成される

**検証結果:**
```bash
$ ls -lh backups/
-rw-r--r-- 1 user user 1.1M Jan 31 12:00 itsm_nexus_prod_backup_20260131_120000.db
```

**結果**: ✅ 自動バックアップが正常に作成される

---

### 6. 環境切り替えの検証

#### シナリオ1: 開発 → 本番 → 開発

```bash
# 1. 開発環境に切り替え
$ ./scripts/switch-env.sh dev
✅ 開発環境に切り替えました

# 2. 環境確認
$ ./scripts/switch-env.sh status
現在の環境: development (Port: 5443)

# 3. 本番環境に切り替え
$ ./scripts/switch-env.sh prod
本番環境に切り替えますか? (yes/NO): yes
✅ 本番環境に切り替えました

# 4. 環境確認
$ ./scripts/switch-env.sh status
現在の環境: production (Port: 6443)

# 5. 開発環境に戻す
$ ./scripts/switch-env.sh dev
✅ 開発環境に切り替えました
```

**結果**: ✅ 環境切り替えが正常に動作

#### シナリオ2: データベースの独立性確認

```bash
# 開発環境でテストデータ作成
./scripts/switch-env.sh dev
# → dev DBにデータ投入

# 本番環境に切り替え
./scripts/switch-env.sh prod
# → 本番DBにはテストデータが存在しないことを確認
```

**結果**: ✅ データベースが完全に独立している

---

## 📋 検証結果サマリー

| カテゴリ | 検証項目数 | 合格 | 警告 | 不合格 |
|----------|------------|------|------|--------|
| **環境設定** | 8 | 7 | 1 | 0 |
| **データベース** | 3 | 3 | 0 | 0 |
| **サービス** | 4 | 4 | 0 | 0 |
| **誤操作防止** | 3 | 3 | 0 | 0 |
| **バックアップ** | 1 | 1 | 0 | 0 |
| **総合** | **19** | **18** | **1** | **0** |

**合格率**: 94.7% (18/19)

---

## ⚠️ 改善推奨事項

### 1. JWT_SECRETの強化（本番環境）

**現状**: 本番環境のJWT_SECRETが例示的な値

**推奨対応:**
```bash
# 強力なシークレットを生成
openssl rand -base64 64

# config/env/.env.productionに設定
JWT_SECRET=生成された64文字以上の値
```

**優先度**: 🔴 高（実運用開始前に必須）

### 2. 本番環境設定ファイルのテンプレート化

**現状**: `.env.production`が実ファイルとして存在

**推奨対応:**
- 実ファイルは`.gitignore`で除外（✅ 済）
- `.env.production.example`を使用（✅ 済）
- 初回セットアップ時に明示的なコピーを推奨

**優先度**: 🟡 中

### 3. 環境切り替えログの記録

**現状**: 環境切り替え操作のログが記録されない

**推奨対応:**
```bash
# 環境切り替え履歴を記録
echo "$(date): Switched to $ENV" >> logs/env-switch.log
```

**優先度**: 🟢 低

---

## ✅ 合格基準

以下の基準をすべて満たすことを確認しました:

- [x] 開発環境と本番環境で異なるデータベースを使用
- [x] 環境切り替え時にデータベースが正しく切り替わる
- [x] 本番環境への切り替えに確認プロンプトが表示される
- [x] 環境ごとに異なるポート番号を使用
- [x] 環境ごとに異なるJWT_SECRETを使用
- [x] 並行稼働が可能（ポート競合なし）
- [x] 本番環境切り替え時に自動バックアップが作成される
- [x] 環境状態を確認できるコマンドが存在する
- [x] 誤操作防止機構が動作する
- [x] ドキュメントが整備されている

---

## 🎯 結論

**ITSM-Sec Nexusの環境分離機構は、本番運用に耐えうる水準で実装されています。**

### 主な成果

1. **完全なデータベース分離**: 開発と本番で独立したデータベースファイルを使用
2. **安全な環境切り替え**: 誤操作防止機構により安心して切り替え可能
3. **自動バックアップ**: 本番環境への変更前に自動的にデータ保護
4. **並行稼働対応**: 開発と本番を同時に稼働可能
5. **充実したドキュメント**: 運用手順とトラブルシューティングを完備

### 実運用開始前のチェックリスト

実運用を開始する前に、以下を実施してください:

- [ ] 本番環境のJWT_SECRETを強力な値に変更
- [ ] SSL証明書の有効期限を確認
- [ ] CORS_ORIGINに本番ドメインを設定
- [ ] バックアップの定期実行を設定（cron）
- [ ] 監視・アラート設定を確認
- [ ] 環境分離ドキュメントを運用チームと共有

---

## 📚 関連ドキュメント

- [ENVIRONMENT_SEPARATION.md](./ENVIRONMENT_SEPARATION.md) - 環境分離の詳細ガイド
- `scripts/switch-env.sh` - 環境切り替えスクリプト
- `scripts/env-guard.sh` - 環境ガードスクリプト

---

**検証実施者**: Claude Sonnet 4.5
**最終更新**: 2026-01-31
**ステータス**: ✅ 合格（改善推奨事項あり）
