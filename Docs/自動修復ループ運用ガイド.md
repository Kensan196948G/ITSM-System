# 自動エラー修復ループ 運用ガイド

ClaudeCode（Linuxネイティブ）と GitHub Actions を組み合わせた自動修復システムの運用ガイドです。

---

## 📋 システム概要

### 全体の考え方（最重要）

このシステムは **2つの役割を明確に分離** して動作します：

| 役割 | 担当 | 責務 |
|------|------|------|
| **制御エンジン** | GitHub Actions | 起動・判断・実行の司令塔 |
| **修復エンジン** | ClaudeCode | 考える・直す専門家 |

---

## 🎯 GitHub Actions の役割（制御エンジン）

GitHub Actions は「頭を使わない」ことが重要です。

### 実行する内容

1. ✅ Workflow を起動する（Issue / schedule / 手動）
2. ✅ テストを実行する
3. ✅ 成功 or 失敗を判定する
4. ✅ 1回の Run の中で **最大15回** 修復ループを回す
5. ✅ 15回失敗した場合、状態をファイルに保存する
6. ✅ Workflow を正常終了 or 失敗終了させる
7. ✅ 30分後に再実行するかどうかを判断する材料を残す

### 実行しない内容

- ❌ 仕様を理解する
- ❌ コードを考える
- ❌ エラーの原因を分析する

---

## 🤖 ClaudeCode の役割（修復エンジン）

ClaudeCode は「考えること」に専念させます。

### 実行する内容

1. ✅ テストエラーの内容を読む
2. ✅ 既存コードの構造を理解する
3. ✅ **CLAUDE.md**（ルール・憲法）を必ず守る
4. ✅ **README.md**（仕様書）を変更しない
5. ✅ エラーの原因を特定し、必要最小限の修正を行う
6. ✅ 修正理由を説明できる状態でコードを出力する

### 実行しない内容

- ❌ ループ回数を数える
- ❌ 待機する（sleep）
- ❌ 再実行判断をする

---

## 🔄 自動修復ループの流れ（1回の Run）

```
1. GitHub Actions が Workflow を起動
   ↓
2. 状態ファイルを確認（実行すべきか判断）
   ↓
3. テストを実行
   ├─ 成功 → Run 終了 ✅
   └─ 失敗 → 次へ
   ↓
4. ClaudeCode を呼び出して修復
   ↓
5. 再度テストを実行
   ↓
6. 手順③〜⑤を最大15回繰り返す
   ↓
7. 結果を状態ファイルに保存
```

---

## 💾 状態管理の仕組み

### 状態ファイル: `.github/auto-repair/state.json`

```json
{
  "retry_needed": false,        // 再試行が必要か
  "total_runs": 0,              // 累計実行回数
  "last_error": null,           // 最後のエラー
  "last_success": null,         // 最後の成功日時
  "consecutive_failures": 0     // 連続失敗回数
}
```

### 状態遷移

```
初期状態
  ├─ 修復成功 → retry_needed: false
  │             consecutive_failures: 0
  │             last_success: 更新
  │
  └─ 修復失敗 → retry_needed: true
                consecutive_failures: +1
                last_error: 更新
```

---

## ⏰ 30分待機後の再実行

1. GitHub Actions の `schedule`（cron）で30分ごとに起動
2. 起動時に状態ファイルを読む

**判断ロジック**:
```yaml
if retry_needed == true:
    修復ループを再開
else:
    何もせず終了
```

---

## 🚫 無限ループに見えて「無限ではない」理由

- ✅ 1回の Run は短時間で必ず終了する
- ✅ 待機は GitHub 側のスケジューラが担当する
- ✅ 同じ Workflow が「新しい Run」として起動される
- ✅ GitHub Actions 的には健全な実行モデル

---

## 📁 ファイル構成

```
.
├── CLAUDE.md                          # 修復ルール・憲法（最重要）
├── README.md                          # プロジェクト仕様書（変更禁止）
├── .github/
│   ├── workflows/
│   │   └── 自動エラー修復ループ.yml   # メインワークフロー
│   └── auto-repair/
│       ├── state.json                 # 状態管理ファイル
│       └── README.md                  # 状態管理の説明
└── Docs/
    └── 自動修復ループ運用ガイド.md     # このファイル
```

---

## 🎛️ 起動方法

### 1. 手動実行

```bash
# GitHub UI から
Actions → 自動エラー修復ループ → Run workflow
```

### 2. Issue トリガー

```bash
# Issueに "auto-fix" ラベルを付ける
```

### 3. 自動実行（スケジュール）

```yaml
# 30分ごとに自動実行（状態ファイルで制御）
# retry_needed == true の場合のみ実行
```

---

## 📊 実行結果の確認

### GitHub Actions UI

```
Actions → 自動エラー修復ループ → 最新の Run
```

### サマリーで確認

各 Run の Summary に以下が表示されます：

```markdown
## 🤖 自動エラー修復ループ 実行結果

### ✅ 修復成功
- 試行回数: 3 / 15
- 状態: すべてのテストが成功
```

---

## ⚙️ 設定のカスタマイズ

### 最大試行回数を変更

`.github/workflows/自動エラー修復ループ.yml`:
```yaml
env:
  MAX_ITERATIONS: 15  # ← ここを変更
```

### スケジュール間隔を変更

```yaml
schedule:
  - cron: '*/30 * * * *'  # ← 30分ごと
  # - cron: '0 * * * *'   # ← 1時間ごと
  # - cron: '0 0 * * *'   # ← 1日ごと
```

---

## 🔧 トラブルシューティング

### Q1. ループが止まらない

**A**: 状態ファイルを確認してください

```bash
cat .github/auto-repair/state.json
```

手動でリセット:
```bash
echo '{"retry_needed":false,"total_runs":0,"last_error":null,"last_success":null,"consecutive_failures":0}' > .github/auto-repair/state.json
git add .github/auto-repair/state.json
git commit -m "chore: 状態ファイルをリセット"
git push
```

### Q2. 修復が成功しているのに再実行される

**A**: 状態ファイルの `retry_needed` が true のままの可能性

```bash
# 状態ファイルを確認
cat .github/auto-repair/state.json

# 手動でfalseに設定
jq '.retry_needed = false' .github/auto-repair/state.json > tmp.json
mv tmp.json .github/auto-repair/state.json
git add .github/auto-repair/state.json
git commit -m "chore: retry_needed を false に設定"
git push
```

### Q3. ClaudeCodeが実行されていない

**A**: 現バージョンでは簡易的な自動修正（ESLint, Prettier）のみです

実際のClaudeCode CLI連携は将来的に実装予定です。

---

## 🎯 ベストプラクティス

### ✅ やるべきこと

1. **CLAUDE.md を定期的にレビュー**
   - ルールが適切か確認
   - プロジェクトの成長に合わせて更新

2. **README.md を最新に保つ**
   - ClaudeCodeが参照する仕様書
   - 常に正確な情報を記載

3. **状態ファイルを監視**
   - 連続失敗回数が多い場合は手動介入

4. **ログを確認**
   - どのような修正が行われたか確認
   - 不適切な修正があれば CLAUDE.md を更新

### ❌ やってはいけないこと

1. **状態ファイルを頻繁に手動編集**
   - 自動管理に任せる
   - 緊急時のみ手動編集

2. **CLAUDE.md を無視**
   - ルールは必ず守る
   - 修正が不適切な場合はルールを見直す

3. **README.md を頻繁に変更**
   - 仕様の真実として扱う
   - 変更時は慎重に

---

## 📚 関連ドキュメント

- `CLAUDE.md` - 修復ルール・憲法
- `README.md` - プロジェクト仕様書
- `.github/auto-repair/README.md` - 状態管理の詳細

---

## 🎓 まとめ

この自動修復システムは、以下の原則に基づいています：

1. **役割分離**: 制御と修復を明確に分ける
2. **状態管理**: ファイルベースで Run 間をつなぐ
3. **ルール遵守**: CLAUDE.md を必ず守る
4. **仕様保護**: README.md を変更しない
5. **最小限修正**: 必要最小限のコードのみ変更

この原則を守ることで、**壊れない・再現性のある自動修復ループ**が実現します。
