# ITSM-Sec Nexus デプロイメントガイド（ネイティブ環境）

## 目次
1. [前提条件](#前提条件)
2. [初回デプロイ手順](#初回デプロイ手順)
3. [アップデート手順](#アップデート手順)
4. [ロールバック手順](#ロールバック手順)
5. [トラブルシューティング](#トラブルシューティング)
6. [本番環境チェックリスト](#本番環境チェックリスト)

---

## 前提条件

### サーバー要件
- **OS**: Ubuntu 20.04 LTS / 22.04 LTS、CentOS 8+、Debian 11+
- **CPU**: 2コア以上（推奨: 4コア）
- **メモリ**: 4GB以上（推奨: 8GB）
- **ディスク**: 50GB以上の空き容量
- **ネットワーク**: ポート 5000 が必要なクライアントから接続可能

### 必要なソフトウェア
- **Node.js**: v20.x LTS
- **npm**: v10.x以上
- **SQLite3**: v3.x以上
- **Git**: v2.25以上
- **OpenSSL**: 環境変数生成用

---

## CI/CD方針

- **CI**: `.github/workflows/ci.yml` を使用（lint/test/coverage）
- **CD**: `deploy.yml.disabled` は保留（Dockerfile/SSH/環境変数未整備のため）
- **デプロイ**: 本書の手順に従い手動で実施

---

## 初回デプロイ手順

### ステップ1: Node.jsのインストール

```bash
# Ubuntu/Debian
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs

# CentOS/RHEL
curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash -
sudo yum install -y nodejs

# インストール確認
node --version  # v20.x.x
npm --version   # v10.x.x
```

### ステップ2: プロジェクトのセットアップ

```bash
# プロジェクトディレクトリに移動
cd /mnt/LinuxHDD/ITSM-System

# 依存関係のインストール
npm install

# 環境変数の設定
./scripts/setup-env.sh
```

### ステップ3: データベースのマイグレーション

```bash
# マイグレーション実行
npm run migrate:latest

# マイグレーション状態確認
npm run migrate:status
```

### ステップ4: サービスの起動

#### 開発環境

```bash
# 手動起動
npm start

# または開発モード
npm run dev
```

#### 本番環境（systemd）

```bash
# systemdサービスとしてインストール
sudo ./scripts/install-systemd.sh

# サービス起動
sudo systemctl start itsm-system

# 自動起動有効化
sudo systemctl enable itsm-system

# ステータス確認
sudo systemctl status itsm-system
```

### ステップ5: 自動バックアップの設定

```bash
# cron設定ファイルをインストール
sudo cp cron.d/itsm-backup /etc/cron.d/
sudo chmod 644 /etc/cron.d/itsm-backup

# cron設定を編集（必要に応じてディレクトリパスを更新）
sudo nano /etc/cron.d/itsm-backup

# cronサービス再起動
sudo systemctl restart cron
```

### ステップ6: ログローテーションの設定

```bash
# logrotate設定ファイルをインストール
sudo cp logrotate.d/itsm-system /etc/logrotate.d/
sudo chmod 644 /etc/logrotate.d/itsm-system

# logrotate設定を編集（必要に応じてパスを更新）
sudo nano /etc/logrotate.d/itsm-system

# 手動でテスト実行
sudo logrotate -f /etc/logrotate.d/itsm-system
```

### ステップ7: デプロイ確認

```bash
# ヘルスチェック（基本）
curl http://localhost:5000/api/v1/health

# Liveness probe
curl http://localhost:5000/api/v1/health/live

# Readiness probe（詳細チェック）
curl http://localhost:5000/api/v1/health/ready

# Prometheusメトリクス
curl http://localhost:5000/metrics

# Webブラウザでフロントエンドにアクセス
# http://192.168.0.187:5050/index.html
```

---

## アップデート手順

### 標準アップデート

```bash
# 1. サービス停止
sudo systemctl stop itsm-system

# 2. 最新コードを取得
git pull origin main

# 3. データベースバックアップ（重要！）
./scripts/backup.sh

# 4. 依存関係の更新
npm install

# 5. データベースマイグレーション
npm run migrate:latest

# 6. サービス再起動
sudo systemctl start itsm-system

# 7. ヘルスチェック
curl http://localhost:5000/api/v1/health/ready

# 8. ログ確認
sudo journalctl -u itsm-system -f
```

### ゼロダウンタイムアップデート（複数サーバー環境）

```bash
# サーバー1: ロードバランサーから切り離し
# サーバー1: アップデート実行
# サーバー1: ヘルスチェック確認
# サーバー1: ロードバランサーに復帰

# サーバー2以降: 同様の手順を繰り返し
```

---

## ロールバック手順

### 緊急ロールバック（5分以内）

```bash
# 1. サービス停止
sudo systemctl stop itsm-system

# 2. 前バージョンに戻す
git log --oneline -5  # 前回のコミットハッシュを確認
git reset --hard <前回のコミットハッシュ>

# 3. 依存関係を復元
npm install

# 4. データベースを復元（データ損失がある場合のみ）
./scripts/restore.sh backend/backups/daily/itsm_nexus_daily_YYYYMMDD_HHMMSS.db

# 5. サービス再起動
sudo systemctl start itsm-system

# 6. ヘルスチェック
curl http://localhost:5000/api/v1/health/ready
```

### データベースマイグレーションのロールバック

```bash
# 最新のマイグレーションを1つ戻す
npm run migrate:rollback

# マイグレーション状態確認
npm run migrate:status

# サービス再起動
sudo systemctl restart itsm-system
```

---

## トラブルシューティング

### 1. サービスが起動しない

```bash
# サービス状態確認
sudo systemctl status itsm-system

# 詳細ログ確認
sudo journalctl -u itsm-system -n 100 --no-pager

# アプリケーションログ確認
tail -f logs/itsm-system.log
tail -f logs/itsm-system-error.log
```

**よくある原因**:
- `.env.production`ファイルが存在しない → `./scripts/setup-env.sh`を実行
- ポート5000が使用中 → `sudo lsof -i :5000`で確認
- データベースファイルのパーミッションエラー → `chmod 644 backend/itsm_nexus.db`

### 2. データベース接続エラー

```bash
# データベースファイルの確認
ls -la backend/itsm_nexus.db

# SQLite整合性チェック
sqlite3 backend/itsm_nexus.db "PRAGMA integrity_check;"

# テーブル一覧確認
sqlite3 backend/itsm_nexus.db ".tables"
```

### 3. パフォーマンス低下

```bash
# プロセス状態確認
ps aux | grep node

# メモリ使用状況
free -h

# ディスク使用状況
df -h

# ログファイルサイズ確認
du -sh logs/*

# WALファイルのチェックポイント実行
sqlite3 backend/itsm_nexus.db "PRAGMA wal_checkpoint(FULL);"
```

### 4. 認証エラー

```bash
# JWT_SECRETが正しく設定されているか確認
grep JWT_SECRET .env.production

# ユーザー一覧確認
sqlite3 backend/itsm_nexus.db "SELECT username, role FROM users;"

# 新しいJWT_SECRETを生成（すべてのトークンが無効化される）
openssl rand -base64 64
```

---

## 本番環境チェックリスト

### セキュリティ

- [ ] `.env.production`にランダムなJWT_SECRETを設定
- [ ] `.env.production`のパーミッションが600
- [ ] デフォルトパスワードを変更（admin/admin123など）
- [ ] ファイアウォールで不要なポートを閉鎖（5000番は必要）
- [ ] SSH鍵認証を使用（パスワード認証無効化）
- [ ] fail2banなどのブルートフォース対策
- [ ] HTTPS化（nginxなどのリバースプロキシ経由）

### 監視・バックアップ

- [ ] 日次バックアップcronジョブ設定（/etc/cron.d/itsm-backup）
- [ ] バックアップのリモート保存設定（rsync or AWS S3）
- [ ] ログローテーション設定（/etc/logrotate.d/itsm-system）
- [ ] ヘルスチェックエンドポイント動作確認
- [ ] Prometheusメトリクス収集動作確認

### パフォーマンス

- [ ] SQLite WALモード有効（knexfile.jsで設定済み）
- [ ] NODE_ENV=production設定
- [ ] ログレベルをwarnに設定

### ドキュメント

- [ ] 運用マニュアル確認
- [ ] インシデント対応フロー確認
- [ ] 緊急連絡先リスト作成

---

## 運用コマンド一覧

### Systemd

```bash
# サービス起動
sudo systemctl start itsm-system

# サービス停止
sudo systemctl stop itsm-system

# サービス再起動
sudo systemctl restart itsm-system

# サービス状態確認
sudo systemctl status itsm-system

# ログ確認
sudo journalctl -u itsm-system -f

# 自動起動有効化
sudo systemctl enable itsm-system

# 自動起動無効化
sudo systemctl disable itsm-system
```

### Database

```bash
# マイグレーション実行
npm run migrate:latest

# マイグレーションロールバック
npm run migrate:rollback

# マイグレーション状態確認
npm run migrate:status

# 新しいマイグレーション作成
npm run migrate:make <マイグレーション名>
```

### バックアップ

```bash
# 手動バックアップ（日次）
./scripts/backup.sh daily

# 手動バックアップ（週次）
./scripts/backup.sh weekly

# 手動バックアップ（月次）
./scripts/backup.sh monthly

# バックアップから復元
./scripts/restore.sh backend/backups/daily/itsm_nexus_daily_YYYYMMDD_HHMMSS.db

# バックアップ一覧表示
ls -lh backend/backups/daily/
ls -lh backend/backups/weekly/
ls -lh backend/backups/monthly/
```

### 監視

```bash
# ヘルスチェック
curl http://localhost:5000/api/v1/health
curl http://localhost:5000/api/v1/health/live
curl http://localhost:5000/api/v1/health/ready

# Prometheusメトリクス確認
curl http://localhost:5000/metrics

# リアルタイムログ監視
tail -f logs/itsm-system.log
```

---

## パフォーマンスチューニング

### SQLite最適化

```bash
# WALモード確認
sqlite3 backend/itsm_nexus.db "PRAGMA journal_mode;"

# キャッシュサイズ確認
sqlite3 backend/itsm_nexus.db "PRAGMA cache_size;"

# 手動VACUUM（定期メンテナンス）
sqlite3 backend/itsm_nexus.db "VACUUM;"

# 統計情報更新
sqlite3 backend/itsm_nexus.db "ANALYZE;"
```

### Node.jsチューニング

```bash
# メモリ制限を設定して起動
node --max-old-space-size=2048 backend/server.js

# クラスタモード（複数コア活用）
# package.jsonに追加: "start:cluster": "pm2 start backend/server.js -i max"
npm install -g pm2
pm2 start backend/server.js -i max --name itsm-system
pm2 save
pm2 startup
```

---

## サポート

問題が解決しない場合は、以下の情報を含めて報告してください：

1. エラーメッセージ全文
2. `sudo journalctl -u itsm-system -n 100 --no-pager`の出力
3. `curl http://localhost:5000/api/v1/health/ready`の出力
4. OS環境情報（`uname -a`）
5. Node.jsバージョン（`node --version`）
6. データベース整合性チェック（`sqlite3 backend/itsm_nexus.db "PRAGMA integrity_check;"`）

**GitHub Issues**: https://github.com/your-org/itsm-system/issues

---
### 更新メモ (2025-12-29)
- 監査ダッシュボード/コンプライアンス管理のUI詳細を反映
- 脆弱性管理の編集・削除を有効化
- ドキュメント参照先をDocs/に統一（docs/フォルダ削除）

