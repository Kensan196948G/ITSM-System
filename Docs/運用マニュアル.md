# ITSM-Sec Nexus 運用マニュアル

## 目次

1. [日次運用手順](#1-日次運用手順)
2. [週次運用手順](#2-週次運用手順)
3. [月次運用手順](#3-月次運用手順)
4. [バックアップ・リストア手順](#4-バックアップリストア手順)
5. [インシデント対応フロー](#5-インシデント対応フロー)
6. [システム監視](#6-システム監視)
7. [トラブルシューティング](#7-トラブルシューティング)

---

## 1. 日次運用手順

### 1.1 システム起動/停止

#### システム起動（毎朝8:00）

```bash
# 1. システムディレクトリへ移動
cd /mnt/LinuxHDD/ITSM-System

# 2. 環境変数確認
cat .env | grep -E "JWT_SECRET|PORT|DB_PATH"

# 3. バックエンドサーバー起動
npm start &

# 4. プロセスID確認（後で停止時に使用）
echo $! > /tmp/itsm-backend.pid

# 5. 起動確認（30秒待機）
sleep 30
curl http://localhost:3000/api/v1/health

# 6. フロントエンドHTTPサーバー起動
python3 -m http.server 5050 --bind 0.0.0.0 &
echo $! > /tmp/itsm-frontend.pid

# 7. 起動完了ログ
echo "[$(date)] ITSM System started successfully" >> /var/log/itsm/startup.log
```

**起動確認項目**:
- [ ] バックエンドポート3000がリスニング中
- [ ] フロントエンドポート5050がリスニング中
- [ ] ヘルスチェックAPI応答200
- [ ] データベースファイル存在確認

#### システム停止（毎晩20:00）

```bash
# 1. プロセスID取得
BACKEND_PID=$(cat /tmp/itsm-backend.pid)
FRONTEND_PID=$(cat /tmp/itsm-frontend.pid)

# 2. グレースフルシャットダウン（SIGTERM）
kill -15 $BACKEND_PID
kill -15 $FRONTEND_PID

# 3. 10秒待機
sleep 10

# 4. 強制停止が必要か確認
if ps -p $BACKEND_PID > /dev/null; then
  echo "[WARN] Backend did not stop gracefully, forcing..."
  kill -9 $BACKEND_PID
fi

# 5. 停止完了ログ
echo "[$(date)] ITSM System stopped" >> /var/log/itsm/startup.log

# 6. PIDファイル削除
rm -f /tmp/itsm-backend.pid /tmp/itsm-frontend.pid
```

### 1.2 ログ確認

#### アプリケーションログ確認（毎日9:00）

```bash
# 1. バックエンドログ確認（最新100行）
tail -n 100 /var/log/itsm/backend.log

# 2. エラーログ抽出
grep -i "error\|warn\|fail" /var/log/itsm/backend.log | tail -n 50

# 3. 認証失敗ログ確認（セキュリティ監視）
grep "401\|403" /var/log/itsm/backend.log | tail -n 20

# 4. 異常なアクセス検出
awk '{print $1}' /var/log/itsm/access.log | sort | uniq -c | sort -rn | head -20

# 5. データベースエラー確認
grep "SQLITE_ERROR\|database" /var/log/itsm/backend.log | tail -n 10
```

**確認項目チェックリスト**:
- [ ] エラーログ件数（目標: 0件/日）
- [ ] 認証失敗回数（閾値: 10回/日未満）
- [ ] API応答時間（目標: 平均200ms以下）
- [ ] データベースエラー（目標: 0件）

#### ログローテーション確認

```bash
# ログファイルサイズ確認
du -h /var/log/itsm/*.log

# 1GBを超えたらローテーション
if [ $(stat -c%s /var/log/itsm/backend.log) -gt 1073741824 ]; then
  mv /var/log/itsm/backend.log /var/log/itsm/backend.log.$(date +%Y%m%d)
  gzip /var/log/itsm/backend.log.$(date +%Y%m%d)
  touch /var/log/itsm/backend.log
fi
```

### 1.3 バックアップ確認

#### 自動バックアップステータス確認（毎日10:00）

```bash
# 1. 最新バックアップファイル確認
ls -lh /backup/itsm/daily/ | tail -n 5

# 2. 今日のバックアップ存在確認
BACKUP_FILE="/backup/itsm/daily/itsm_nexus_$(date +%Y%m%d).db"
if [ ! -f "$BACKUP_FILE" ]; then
  echo "[CRITICAL] Daily backup missing for $(date +%Y-%m-%d)" | mail -s "ITSM Backup Alert" admin@example.com
  exit 1
fi

# 3. バックアップファイル整合性確認
sqlite3 $BACKUP_FILE "PRAGMA integrity_check;"

# 4. バックアップサイズ確認（急激な増減は異常）
CURRENT_SIZE=$(stat -c%s $BACKUP_FILE)
EXPECTED_SIZE=10485760  # 10MB（想定サイズ）
DIFF=$((CURRENT_SIZE - EXPECTED_SIZE))

if [ ${DIFF#-} -gt 5242880 ]; then  # 5MB以上の差
  echo "[WARN] Backup size anomaly: $CURRENT_SIZE bytes"
fi
```

**バックアップ確認項目**:
- [ ] 本日分バックアップ存在
- [ ] ファイル破損なし（integrity_check成功）
- [ ] ファイルサイズ正常範囲内
- [ ] バックアップディスク容量十分（80%未満）

### 1.4 アラート確認

#### 監視アラート確認（毎日11:00）

```bash
# 1. Criticalインシデント確認
sqlite3 /mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db \
  "SELECT id, title, created_at FROM incident_tickets WHERE priority='Critical' AND status!='Resolved' ORDER BY created_at DESC;"

# 2. セキュリティイベント確認
sqlite3 /mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db \
  "SELECT event_type, severity, COUNT(*) FROM security_events WHERE detected_at > datetime('now', '-24 hours') GROUP BY event_type, severity;"

# 3. SLA違反確認
sqlite3 /mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db \
  "SELECT service_name, target_availability, current_availability FROM sla_targets WHERE current_availability < target_availability;"

# 4. 承認待ちRFC確認
sqlite3 /mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db \
  "SELECT id, title, requested_date FROM change_requests WHERE approval_status='Pending' AND datetime(requested_date) < datetime('now', '-7 days');"
```

**アラート対応基準**:

| 種類 | 条件 | 対応時間 | 担当 |
|-----|------|---------|------|
| Critical インシデント | 新規発生 | 1時間以内 | シニアエンジニア |
| セキュリティイベント | High/Critical | 2時間以内 | セキュリティチーム |
| SLA違反 | 目標未達 | 4時間以内 | サービスマネージャー |
| RFC承認遅延 | 7日以上放置 | 1営業日以内 | 変更管理責任者 |

---

## 2. 週次運用手順

### 2.1 データベース最適化

#### 実施タイミング: 毎週日曜日 02:00

```bash
#!/bin/bash
# weekly-db-optimization.sh

DB_PATH="/mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db"
LOG_FILE="/var/log/itsm/db-optimization.log"

echo "[$(date)] Starting weekly database optimization" >> $LOG_FILE

# 1. データベースバックアップ（最適化前）
cp $DB_PATH ${DB_PATH}.pre-optimization-$(date +%Y%m%d)

# 2. VACUUM実行（データベース再構築、断片化解消）
sqlite3 $DB_PATH "VACUUM;" >> $LOG_FILE 2>&1

# 3. ANALYZE実行（クエリプラン最適化）
sqlite3 $DB_PATH "ANALYZE;" >> $LOG_FILE 2>&1

# 4. インデックス再構築
sqlite3 $DB_PATH "REINDEX;" >> $LOG_FILE 2>&1

# 5. 整合性チェック
INTEGRITY=$(sqlite3 $DB_PATH "PRAGMA integrity_check;")
if [ "$INTEGRITY" != "ok" ]; then
  echo "[ERROR] Database integrity check failed: $INTEGRITY" >> $LOG_FILE
  mail -s "ITSM DB Integrity Error" admin@example.com < $LOG_FILE
  exit 1
fi

# 6. 最適化前後のサイズ比較
BEFORE_SIZE=$(stat -c%s ${DB_PATH}.pre-optimization-$(date +%Y%m%d))
AFTER_SIZE=$(stat -c%s $DB_PATH)
SAVED=$((BEFORE_SIZE - AFTER_SIZE))

echo "[$(date)] Optimization completed. Space saved: $((SAVED / 1024 / 1024)) MB" >> $LOG_FILE

# 7. 古い最適化前バックアップ削除（30日以上）
find /mnt/LinuxHDD/ITSM-System/backend/ -name "*.pre-optimization-*" -mtime +30 -delete

echo "[$(date)] Weekly database optimization finished" >> $LOG_FILE
```

**cron設定**:
```cron
0 2 * * 0 /usr/local/bin/weekly-db-optimization.sh
```

### 2.2 ログローテーション

#### 実施タイミング: 毎週日曜日 03:00

```bash
#!/bin/bash
# weekly-log-rotation.sh

LOG_DIR="/var/log/itsm"
ARCHIVE_DIR="/var/log/itsm/archive"
RETENTION_DAYS=90

# 1. アーカイブディレクトリ作成
mkdir -p $ARCHIVE_DIR

# 2. ログファイルローテーション
for logfile in backend.log access.log error.log; do
  if [ -f "$LOG_DIR/$logfile" ]; then
    # ファイル名に日付追加
    mv $LOG_DIR/$logfile $ARCHIVE_DIR/${logfile%.log}_$(date +%Y%m%d).log

    # 圧縮
    gzip $ARCHIVE_DIR/${logfile%.log}_$(date +%Y%m%d).log

    # 新しいログファイル作成
    touch $LOG_DIR/$logfile
    chmod 644 $LOG_DIR/$logfile
  fi
done

# 3. 古いアーカイブ削除（90日以上）
find $ARCHIVE_DIR -name "*.log.gz" -mtime +$RETENTION_DAYS -delete

echo "[$(date)] Log rotation completed" >> $LOG_DIR/maintenance.log
```

### 2.3 セキュリティアップデート確認

#### 実施タイミング: 毎週月曜日 10:00

```bash
# 1. npm依存関係の脆弱性スキャン
cd /mnt/LinuxHDD/ITSM-System
npm audit

# 2. 脆弱性レポート生成
npm audit --json > /tmp/npm-audit-$(date +%Y%m%d).json

# 3. High/Critical脆弱性確認
HIGH_VULNS=$(npm audit --json | jq '.metadata.vulnerabilities.high')
CRITICAL_VULNS=$(npm audit --json | jq '.metadata.vulnerabilities.critical')

if [ "$HIGH_VULNS" -gt 0 ] || [ "$CRITICAL_VULNS" -gt 0 ]; then
  echo "High vulnerabilities: $HIGH_VULNS, Critical: $CRITICAL_VULNS" | \
    mail -s "ITSM Security Alert" security@example.com
fi

# 4. 自動修正可能なパッチ適用（低リスク）
npm audit fix

# 5. システム再起動（パッチ適用後）
systemctl restart itsm-backend
```

**セキュリティアップデート対応基準**:

| 脆弱性レベル | 対応期限 | 承認者 |
|------------|---------|--------|
| Critical | 24時間以内 | セキュリティ責任者 |
| High | 7日以内 | システム管理者 |
| Medium | 30日以内 | 開発チーム |
| Low | 次回メンテナンス | 開発チーム |

### 2.4 パフォーマンス監視

#### 実施タイミング: 毎週金曜日 15:00

```bash
# 1. API応答時間測定（100回平均）
TOTAL_TIME=0
for i in {1..100}; do
  RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}\n' http://localhost:3000/api/v1/health)
  TOTAL_TIME=$(echo "$TOTAL_TIME + $RESPONSE_TIME" | bc)
done
AVG_TIME=$(echo "scale=3; $TOTAL_TIME / 100" | bc)

echo "Average API response time: ${AVG_TIME}s"

# 2. データベースクエリパフォーマンス
sqlite3 /mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db <<EOF
.timer ON
SELECT COUNT(*) FROM incident_tickets;
SELECT COUNT(*) FROM change_requests;
SELECT COUNT(*) FROM security_events;
EOF

# 3. メモリ使用量確認
ps aux | grep "node.*server.js" | awk '{print "Memory: " $6/1024 " MB"}'

# 4. ディスク使用量確認
df -h /mnt/LinuxHDD/ITSM-System

# 5. パフォーマンスレポート保存
{
  echo "=== ITSM Performance Report $(date) ==="
  echo "Average API Response: ${AVG_TIME}s"
  ps aux | grep "node.*server.js"
  df -h /mnt/LinuxHDD/ITSM-System
} > /var/log/itsm/performance-$(date +%Y%m%d).log
```

---

## 3. 月次運用手順

### 3.1 データベースバックアップ（完全バックアップ）

#### 実施タイミング: 毎月1日 01:00

```bash
#!/bin/bash
# monthly-full-backup.sh

BACKUP_DIR="/backup/itsm/monthly"
DB_PATH="/mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db"
BACKUP_FILE="$BACKUP_DIR/itsm_nexus_full_$(date +%Y%m).db"

# 1. バックアップディレクトリ作成
mkdir -p $BACKUP_DIR

# 2. データベースダンプ（SQL形式）
sqlite3 $DB_PATH .dump > ${BACKUP_FILE%.db}.sql

# 3. バイナリコピー（完全バックアップ）
cp $DB_PATH $BACKUP_FILE

# 4. 圧縮
gzip $BACKUP_FILE
gzip ${BACKUP_FILE%.db}.sql

# 5. チェックサム作成（改ざん検出）
sha256sum ${BACKUP_FILE}.gz > ${BACKUP_FILE}.gz.sha256

# 6. リモートバックアップ（オプション）
# rsync -avz ${BACKUP_FILE}.gz backup-server:/backup/itsm/

# 7. 古いバックアップ削除（12ヶ月以上）
find $BACKUP_DIR -name "*.gz" -mtime +365 -delete

echo "[$(date)] Monthly full backup completed: ${BACKUP_FILE}.gz" >> /var/log/itsm/backup.log
```

**バックアップファイル構成**:
```
/backup/itsm/monthly/
├── itsm_nexus_full_202501.db.gz        # バイナリバックアップ
├── itsm_nexus_full_202501.db.gz.sha256 # チェックサム
└── itsm_nexus_full_202501.sql.gz       # SQLダンプ
```

### 3.2 ユーザーアカウント監査

#### 実施タイミング: 毎月15日 10:00

```bash
# 1. 全ユーザー一覧取得
sqlite3 /mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db \
  "SELECT username, email, role, created_at, last_login FROM users ORDER BY role, username;" \
  > /tmp/user-audit-$(date +%Y%m).csv

# 2. 長期未使用アカウント検出（90日以上ログインなし）
sqlite3 /mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db \
  "SELECT username, email, last_login FROM users WHERE last_login < datetime('now', '-90 days') OR last_login IS NULL;"

# 3. 管理者権限ユーザー確認
sqlite3 /mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db \
  "SELECT username, email, created_at FROM users WHERE role='admin';"

# 4. 重複メールアドレス確認
sqlite3 /mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db \
  "SELECT email, COUNT(*) as count FROM users GROUP BY email HAVING count > 1;"

# 5. 監査レポート生成
{
  echo "=== User Account Audit Report $(date) ==="
  echo ""
  echo "Total Users: $(sqlite3 /mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db 'SELECT COUNT(*) FROM users;')"
  echo "Active Users (last 30 days): $(sqlite3 /mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db "SELECT COUNT(*) FROM users WHERE last_login > datetime('now', '-30 days');")"
  echo "Inactive Users (90+ days): $(sqlite3 /mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db "SELECT COUNT(*) FROM users WHERE last_login < datetime('now', '-90 days') OR last_login IS NULL;")"
  echo "Admin Users: $(sqlite3 /mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db "SELECT COUNT(*) FROM users WHERE role='admin';")"
} > /var/log/itsm/user-audit-$(date +%Y%m).log
```

**監査対応アクション**:
- 90日以上未使用アカウント: 無効化検討
- 管理者権限: 最小権限原則確認
- 重複メールアドレス: データ整合性調査

### 3.3 SLAレポート作成

#### 実施タイミング: 毎月末 17:00

```bash
#!/bin/bash
# monthly-sla-report.sh

DB_PATH="/mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db"
REPORT_FILE="/var/log/itsm/sla-report-$(date +%Y%m).html"

# 1. 月次インシデント統計
TOTAL_INCIDENTS=$(sqlite3 $DB_PATH "SELECT COUNT(*) FROM incident_tickets WHERE strftime('%Y-%m', created_at) = strftime('%Y-%m', 'now');")
RESOLVED_INCIDENTS=$(sqlite3 $DB_PATH "SELECT COUNT(*) FROM incident_tickets WHERE status='Resolved' AND strftime('%Y-%m', resolved_at) = strftime('%Y-%m', 'now');")
CRITICAL_INCIDENTS=$(sqlite3 $DB_PATH "SELECT COUNT(*) FROM incident_tickets WHERE priority='Critical' AND strftime('%Y-%m', created_at) = strftime('%Y-%m', 'now');")

# 2. 平均解決時間（時間）
AVG_RESOLUTION=$(sqlite3 $DB_PATH "SELECT AVG((julianday(resolved_at) - julianday(created_at)) * 24) FROM incident_tickets WHERE status='Resolved' AND strftime('%Y-%m', resolved_at) = strftime('%Y-%m', 'now');")

# 3. SLA達成率
SLA_TARGET_HOURS=24
ON_TIME=$(sqlite3 $DB_PATH "SELECT COUNT(*) FROM incident_tickets WHERE status='Resolved' AND ((julianday(resolved_at) - julianday(created_at)) * 24) <= $SLA_TARGET_HOURS AND strftime('%Y-%m', resolved_at) = strftime('%Y-%m', 'now');")
SLA_RATE=$(echo "scale=2; $ON_TIME * 100 / $RESOLVED_INCIDENTS" | bc)

# 4. HTMLレポート生成
cat > $REPORT_FILE <<EOF
<!DOCTYPE html>
<html>
<head>
  <title>SLA Report - $(date +%Y-%m)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #4CAF50; color: white; }
    .good { color: green; }
    .warning { color: orange; }
    .bad { color: red; }
  </style>
</head>
<body>
  <h1>月次SLAレポート - $(date +%Y年%m月)</h1>

  <h2>インシデント統計</h2>
  <table>
    <tr><th>項目</th><th>値</th></tr>
    <tr><td>総インシデント数</td><td>$TOTAL_INCIDENTS</td></tr>
    <tr><td>解決済み</td><td>$RESOLVED_INCIDENTS</td></tr>
    <tr><td>Criticalインシデント</td><td class="$([ $CRITICAL_INCIDENTS -gt 5 ] && echo 'bad' || echo 'good')">$CRITICAL_INCIDENTS</td></tr>
    <tr><td>平均解決時間</td><td>$(printf '%.1f' $AVG_RESOLUTION) 時間</td></tr>
  </table>

  <h2>SLA達成状況</h2>
  <table>
    <tr><th>指標</th><th>目標</th><th>実績</th><th>達成率</th></tr>
    <tr>
      <td>24時間以内解決</td>
      <td>95%</td>
      <td class="$(echo "$SLA_RATE >= 95" | bc -l | grep -q 1 && echo 'good' || echo 'bad')">$(printf '%.1f' $SLA_RATE)%</td>
      <td>$ON_TIME / $RESOLVED_INCIDENTS</td>
    </tr>
  </table>

  <h2>改善推奨事項</h2>
  <ul>
    <li>$([ $CRITICAL_INCIDENTS -gt 5 ] && echo 'Criticalインシデントが多発しています。根本原因分析を実施してください。' || echo 'Criticalインシデント件数は許容範囲内です。')</li>
    <li>$(echo "$SLA_RATE < 95" | bc -l | grep -q 1 && echo 'SLA達成率が目標未達です。プロセス改善が必要です。' || echo 'SLA達成率は良好です。')</li>
  </ul>

  <p>生成日時: $(date)</p>
</body>
</html>
EOF

echo "[$(date)] SLA report generated: $REPORT_FILE"

# 5. レポートをメール送信（オプション）
# mail -s "Monthly SLA Report $(date +%Y-%m)" -a "Content-Type: text/html" \
#   management@example.com < $REPORT_FILE
```

### 3.4 システムヘルスチェック

#### 実施タイミング: 毎月20日 14:00

```bash
#!/bin/bash
# monthly-health-check.sh

REPORT_FILE="/var/log/itsm/health-check-$(date +%Y%m).log"

{
  echo "=== ITSM System Health Check Report ==="
  echo "Date: $(date)"
  echo ""

  # 1. システムリソース
  echo "--- System Resources ---"
  echo "CPU Usage:"
  top -bn1 | grep "Cpu(s)" | awk '{print "  " $2 " user, " $4 " system"}'

  echo "Memory Usage:"
  free -h | awk 'NR==2{printf "  Used: %s / Total: %s (%.2f%%)\n", $3, $2, $3/$2*100}'

  echo "Disk Usage:"
  df -h /mnt/LinuxHDD/ITSM-System | awk 'NR==2{print "  " $3 " / " $2 " (" $5 ")"}'

  # 2. データベース状態
  echo ""
  echo "--- Database Health ---"
  echo "Database Size: $(du -h /mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db | cut -f1)"
  echo "Table Counts:"
  sqlite3 /mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db <<EOF
SELECT '  incident_tickets: ' || COUNT(*) FROM incident_tickets;
SELECT '  change_requests: ' || COUNT(*) FROM change_requests;
SELECT '  users: ' || COUNT(*) FROM users;
SELECT '  security_events: ' || COUNT(*) FROM security_events;
EOF

  # 3. API健全性
  echo ""
  echo "--- API Health ---"
  HEALTH_STATUS=$(curl -s http://localhost:3000/api/v1/health | jq -r '.status')
  echo "Health Endpoint: $HEALTH_STATUS"

  API_RESPONSE=$(curl -o /dev/null -s -w '%{http_code}' http://localhost:3000/api/v1/health)
  echo "HTTP Status: $API_RESPONSE"

  # 4. セキュリティ状態
  echo ""
  echo "--- Security Status ---"
  echo "Failed Login Attempts (last 30 days):"
  grep -c "401.*login" /var/log/itsm/backend.log 2>/dev/null || echo "  0"

  echo "Critical Security Events:"
  sqlite3 /mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db \
    "SELECT COUNT(*) FROM security_events WHERE severity='Critical' AND detected_at > datetime('now', '-30 days');"

  # 5. バックアップ状態
  echo ""
  echo "--- Backup Status ---"
  echo "Latest Daily Backup:"
  ls -lh /backup/itsm/daily/ | tail -1 | awk '{print "  " $9 " (" $5 ")"}'

  echo "Latest Monthly Backup:"
  ls -lh /backup/itsm/monthly/ | tail -1 | awk '{print "  " $9 " (" $5 ")"}'

  # 6. 総合評価
  echo ""
  echo "--- Overall Assessment ---"
  ISSUES=0

  # ディスク使用率チェック
  DISK_USAGE=$(df /mnt/LinuxHDD/ITSM-System | awk 'NR==2{print $5}' | sed 's/%//')
  if [ $DISK_USAGE -gt 80 ]; then
    echo "[WARNING] Disk usage high: ${DISK_USAGE}%"
    ISSUES=$((ISSUES + 1))
  fi

  # API応答チェック
  if [ "$API_RESPONSE" != "200" ]; then
    echo "[ERROR] API health check failed"
    ISSUES=$((ISSUES + 1))
  fi

  if [ $ISSUES -eq 0 ]; then
    echo "[OK] All systems operational"
  else
    echo "[ALERT] $ISSUES issue(s) detected - immediate attention required"
  fi

} > $REPORT_FILE

cat $REPORT_FILE
```

---

## 4. バックアップ・リストア手順

### 4.1 データベースバックアップコマンド

#### 即時バックアップ（手動）

```bash
# 1. シンプルコピー
cp /mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db \
   /backup/itsm/manual/itsm_nexus_$(date +%Y%m%d_%H%M%S).db

# 2. SQLダンプ（可読形式）
sqlite3 /mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db .dump \
   > /backup/itsm/manual/itsm_nexus_$(date +%Y%m%d_%H%M%S).sql

# 3. 圧縮バックアップ
tar -czf /backup/itsm/manual/itsm_backup_$(date +%Y%m%d_%H%M%S).tar.gz \
   -C /mnt/LinuxHDD/ITSM-System/backend itsm_nexus.db
```

#### 自動バックアップ設定（cron）

```bash
# crontab -e で編集
# 毎日AM 2:00にバックアップ
0 2 * * * /usr/local/bin/daily-backup.sh

# /usr/local/bin/daily-backup.sh 内容
#!/bin/bash
BACKUP_DIR="/backup/itsm/daily"
DB_PATH="/mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db"
BACKUP_FILE="$BACKUP_DIR/itsm_nexus_$(date +%Y%m%d).db"

mkdir -p $BACKUP_DIR
cp $DB_PATH $BACKUP_FILE
gzip $BACKUP_FILE

# 7日以上前のバックアップ削除
find $BACKUP_DIR -name "*.gz" -mtime +7 -delete
```

### 4.2 バックアップファイル管理

#### バックアップ保存ポリシー

| 種類 | 頻度 | 保存期間 | 保存場所 |
|-----|------|---------|---------|
| **日次** | 毎日 02:00 | 7日間 | /backup/itsm/daily/ |
| **週次** | 毎週日曜 02:00 | 30日間 | /backup/itsm/weekly/ |
| **月次** | 毎月1日 01:00 | 12ヶ月 | /backup/itsm/monthly/ |
| **手動** | オンデマンド | 無期限 | /backup/itsm/manual/ |

#### バックアップディスク容量管理

```bash
# バックアップディスク使用量確認
du -sh /backup/itsm/*

# 古いバックアップ自動削除スクリプト
#!/bin/bash
# cleanup-old-backups.sh

find /backup/itsm/daily -name "*.gz" -mtime +7 -delete
find /backup/itsm/weekly -name "*.gz" -mtime +30 -delete
find /backup/itsm/monthly -name "*.gz" -mtime +365 -delete

echo "[$(date)] Old backups cleaned up" >> /var/log/itsm/backup.log
```

### 4.3 リストア手順

#### 完全リストア（データベース全体）

```bash
#!/bin/bash
# restore-database.sh

# 警告: このスクリプトは既存データを上書きします！

BACKUP_FILE="$1"
DB_PATH="/mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db"

if [ -z "$BACKUP_FILE" ]; then
  echo "Usage: $0 <backup-file>"
  echo "Example: $0 /backup/itsm/daily/itsm_nexus_20250128.db.gz"
  exit 1
fi

# 1. サービス停止
echo "Stopping ITSM services..."
systemctl stop itsm-backend

# 2. 現在のDBをバックアップ（安全措置）
echo "Creating safety backup..."
cp $DB_PATH ${DB_PATH}.before-restore-$(date +%Y%m%d_%H%M%S)

# 3. バックアップファイル解凍（gzip圧縮の場合）
if [[ $BACKUP_FILE == *.gz ]]; then
  echo "Extracting backup..."
  gunzip -c $BACKUP_FILE > /tmp/restore_temp.db
  RESTORE_SOURCE="/tmp/restore_temp.db"
else
  RESTORE_SOURCE=$BACKUP_FILE
fi

# 4. 整合性チェック
echo "Checking backup integrity..."
INTEGRITY=$(sqlite3 $RESTORE_SOURCE "PRAGMA integrity_check;")
if [ "$INTEGRITY" != "ok" ]; then
  echo "ERROR: Backup file is corrupted!"
  systemctl start itsm-backend
  exit 1
fi

# 5. リストア実行
echo "Restoring database..."
cp $RESTORE_SOURCE $DB_PATH

# 6. 権限修正
chmod 664 $DB_PATH
chown itsm:itsm $DB_PATH

# 7. サービス再起動
echo "Starting ITSM services..."
systemctl start itsm-backend

# 8. 動作確認
sleep 5
HEALTH=$(curl -s http://localhost:3000/api/v1/health | jq -r '.status')
if [ "$HEALTH" == "healthy" ]; then
  echo "✓ Restore completed successfully!"
else
  echo "✗ Service not responding - check logs"
  exit 1
fi

# 9. 一時ファイル削除
rm -f /tmp/restore_temp.db
```

#### 部分リストア（特定テーブルのみ）

```bash
#!/bin/bash
# restore-table.sh <backup-file> <table-name>

BACKUP_FILE="$1"
TABLE_NAME="$2"
DB_PATH="/mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db"

# 1. バックアップからテーブルダンプ抽出
sqlite3 $BACKUP_FILE .dump $TABLE_NAME > /tmp/${TABLE_NAME}_dump.sql

# 2. 既存テーブル削除（注意！）
sqlite3 $DB_PATH "DROP TABLE IF EXISTS ${TABLE_NAME};"

# 3. テーブルリストア
sqlite3 $DB_PATH < /tmp/${TABLE_NAME}_dump.sql

echo "Table $TABLE_NAME restored from $BACKUP_FILE"
```

### 4.4 検証手順

#### リストア後の検証チェックリスト

```bash
# 1. データベース整合性確認
sqlite3 /mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db "PRAGMA integrity_check;"

# 2. テーブル存在確認
sqlite3 /mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db ".tables"

# 3. レコード数確認
sqlite3 /mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db <<EOF
SELECT 'users: ' || COUNT(*) FROM users;
SELECT 'incidents: ' || COUNT(*) FROM incident_tickets;
SELECT 'changes: ' || COUNT(*) FROM change_requests;
EOF

# 4. API動作確認
curl http://localhost:3000/api/v1/health

# 5. ログイン確認
curl -X POST http://localhost:3000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'
```

---

## 5. インシデント対応フロー

### 5.1 Criticalインシデント対応

#### フェーズ1: 初動対応（15分以内）

```bash
# 1. インシデント確認
sqlite3 /mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db \
  "SELECT id, title, description, created_at FROM incident_tickets WHERE id='<incident-id>';"

# 2. 影響範囲確認
# - 影響ユーザー数
# - 影響システム
# - ビジネスインパクト

# 3. 関係者通知
echo "Critical Incident: <summary>" | mail -s "CRITICAL: <title>" \
  ops-team@example.com,management@example.com

# 4. インシデントステータス更新
curl -X PUT http://localhost:3000/api/v1/incidents/<incident-id> \
  -H "Authorization: Bearer <admin-token>" \
  -H "Content-Type: application/json" \
  -d '{"status":"In Progress","assigned_to":"senior-engineer"}'
```

#### フェーズ2: 調査・診断（30分以内）

```bash
# 1. ログ収集
tail -n 500 /var/log/itsm/backend.log > /tmp/incident-<id>-logs.txt
tail -n 500 /var/log/itsm/error.log >> /tmp/incident-<id>-logs.txt

# 2. システム状態確認
{
  echo "=== System Status ==="
  systemctl status itsm-backend

  echo "=== Database Status ==="
  sqlite3 /mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db "PRAGMA integrity_check;"

  echo "=== Resource Usage ==="
  top -bn1 | head -20
  df -h
} > /tmp/incident-<id>-status.txt

# 3. 根本原因特定
# - コードレビュー
# - データベースクエリ分析
# - 外部依存関係確認
```

#### フェーズ3: 復旧・修正（1時間以内）

```bash
# 1. 緊急修正適用
# - ホットフィックスデプロイ
# - 設定変更
# - データ修正

# 2. サービス再起動
systemctl restart itsm-backend

# 3. 動作確認
curl http://localhost:3000/api/v1/health

# 4. ステータス更新
curl -X PUT http://localhost:3000/api/v1/incidents/<incident-id> \
  -H "Authorization: Bearer <admin-token>" \
  -H "Content-Type: application/json" \
  -d '{"status":"Resolved","resolution_notes":"Root cause: <description>, Fix: <solution>"}'
```

#### フェーズ4: 事後対応（24時間以内）

```bash
# 1. ポストモーテムレポート作成
cat > /tmp/postmortem-<incident-id>.md <<EOF
# インシデントポストモーテム

## 概要
- インシデントID: <id>
- 発生日時: <timestamp>
- 解決日時: <timestamp>
- 影響範囲: <scope>

## 根本原因
<root-cause-analysis>

## 対応内容
<actions-taken>

## 再発防止策
1. <preventive-action-1>
2. <preventive-action-2>

## 学んだ教訓
<lessons-learned>
EOF

# 2. 問題チケット作成（再発防止）
curl -X POST http://localhost:3000/api/v1/problems \
  -H "Authorization: Bearer <admin-token>" \
  -H "Content-Type: application/json" \
  -d '{"title":"Prevent recurrence of <incident>","root_cause":"<cause>","related_incident":"<id>"}'
```

### 5.2 セキュリティインシデント対応

#### 即時対応（5分以内）

```bash
# 1. 侵害確認
sqlite3 /mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db \
  "SELECT * FROM security_events WHERE severity='Critical' ORDER BY detected_at DESC LIMIT 10;"

# 2. 影響範囲隔離
# - 該当ユーザーアカウント無効化
# - 不正アクセス元IPブロック
# - 該当サービス停止

sqlite3 /mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db \
  "UPDATE users SET is_active=0 WHERE username='<compromised-user>';"

# 3. セキュリティチーム通知
echo "Security Incident Detected: <details>" | mail -s "SECURITY ALERT" security@example.com

# 4. フォレンジック証拠保全
cp /var/log/itsm/backend.log /backup/forensics/incident-<id>-$(date +%Y%m%d_%H%M%S).log
cp /mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db /backup/forensics/db-snapshot-$(date +%Y%m%d_%H%M%S).db
```

### 5.3 エスカレーション手順

#### レベル1: オペレーター（初動対応）

**対応可能範囲**:
- 既知のエラー対応
- 再起動による復旧
- ログ収集

**エスカレーション条件**:
- 30分以内に解決できない
- ビジネス影響が大きい

#### レベル2: シニアエンジニア（技術対応）

**対応可能範囲**:
- コード修正
- データベース復旧
- 設定変更

**エスカレーション条件**:
- 1時間以内に解決できない
- Critical優先度

#### レベル3: マネジメント（意思決定）

**対応可能範囲**:
- ビジネス判断
- リソース配分
- 外部ベンダー連絡

### 5.4 復旧手順

#### サービス復旧チェックリスト

- [ ] ヘルスチェックAPI応答確認
- [ ] ログインテスト（admin/analyst）
- [ ] CRUD操作テスト
- [ ] パフォーマンス確認（応答時間）
- [ ] データ整合性確認
- [ ] ユーザー通知（復旧完了）

---

## 6. システム監視

### 6.1 監視項目

#### システムリソース監視

```bash
# CPU使用率監視（閾値: 80%）
top -bn1 | grep "Cpu(s)" | awk '{print $2}' | sed 's/%us,//'

# メモリ使用率監視（閾値: 85%）
free | grep Mem | awk '{printf "%.0f", $3/$2 * 100.0}'

# ディスク使用率監視（閾値: 80%）
df /mnt/LinuxHDD/ITSM-System | awk 'NR==2{print $5}' | sed 's/%//'

# プロセス監視
ps aux | grep "node.*server.js" || echo "Backend not running!"
```

#### アプリケーション監視

```bash
# API応答時間監視（閾値: 1秒）
curl -o /dev/null -s -w '%{time_total}\n' http://localhost:3000/api/v1/health

# エラーレート監視（閾値: 5件/分）
grep -c "ERROR" /var/log/itsm/backend.log | tail -n 1

# 認証失敗監視（閾値: 10回/時）
grep -c "401\|403" /var/log/itsm/backend.log | tail -n 1
```

#### データベース監視

```bash
# データベースサイズ監視（閾値: 1GB）
du -b /mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db | awk '{print $1}'

# クエリパフォーマンス監視
sqlite3 /mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db <<EOF
.timer ON
SELECT COUNT(*) FROM incident_tickets;
EOF
```

### 6.2 しきい値設定

| 項目 | 警告 | 危険 | アクション |
|-----|------|------|----------|
| **CPU使用率** | 70% | 85% | プロセス調査 |
| **メモリ使用率** | 80% | 90% | メモリリーク確認 |
| **ディスク使用率** | 75% | 85% | ログクリーンアップ |
| **API応答時間** | 500ms | 1000ms | パフォーマンス最適化 |
| **エラーレート** | 5件/分 | 10件/分 | 根本原因調査 |
| **DB接続エラー** | 1件 | 3件 | DB再起動検討 |

### 6.3 アラート設定

#### メールアラート設定

```bash
#!/bin/bash
# monitoring-alert.sh

CPU_THRESHOLD=80
DISK_THRESHOLD=80

CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | sed 's/%us,//' | cut -d. -f1)
DISK_USAGE=$(df /mnt/LinuxHDD/ITSM-System | awk 'NR==2{print $5}' | sed 's/%//')

if [ $CPU_USAGE -gt $CPU_THRESHOLD ]; then
  echo "CPU usage critical: ${CPU_USAGE}%" | mail -s "ITSM Alert: High CPU" admin@example.com
fi

if [ $DISK_USAGE -gt $DISK_THRESHOLD ]; then
  echo "Disk usage critical: ${DISK_USAGE}%" | mail -s "ITSM Alert: High Disk Usage" admin@example.com
fi
```

### 6.4 ダッシュボード確認

#### KPIダッシュボードアクセス

```bash
# ブラウザで以下にアクセス
http://192.168.0.187:5050/index.html#dashboard

# または API経由で確認
curl -H "Authorization: Bearer <token>" http://localhost:3000/api/v1/dashboard/kpi | jq
```

**確認項目**:
- 総インシデント数
- Openインシデント数
- Criticalインシデント数
- 平均解決時間
- SLA達成率
- セキュリティイベント数

#### 監査・コンプライアンスダッシュボード確認

**アクセス方法**:
- サイドバーから「監査ダッシュボード」「ポリシー・プロシージャー管理」「コンプライアンス管理」を選択

**確認項目**:
- 監査ダッシュボード: 監査カバレッジ、直近の監査スケジュール、重点指摘事項、証跡収集状況
- ポリシー・プロシージャー管理: ルール/手順の最新化、レビュー期限、担当部署
- コンプライアンス管理: エビデンス一覧、監査スケジュール、指摘事項、レポート進捗

---

## 7. トラブルシューティング

### 7.1 サーバー起動失敗

**症状**: `npm start` でエラー

**原因と対処**:

```bash
# 原因1: ポート使用中
lsof -i :3000
kill -9 <PID>

# 原因2: 環境変数未設定
cat .env
# JWT_SECRET, DB_PATHを確認

# 原因3: 依存関係不足
npm install

# 原因4: Node.jsバージョン不一致
node --version  # v20以上必要
nvm install 20
nvm use 20
```

### 7.2 データベース接続エラー

**症状**: `SQLITE_CANTOPEN` エラー

**対処**:

```bash
# 1. ファイル存在確認
ls -la /mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db

# 2. 権限確認
chmod 664 /mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db
chown $USER:$USER /mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db

# 3. ディレクトリ権限
chmod 775 /mnt/LinuxHDD/ITSM-System/backend/

# 4. データベース再作成（最終手段）
rm /mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db
npm start  # 自動で再作成される
```

### 7.3 認証エラー

**症状**: `401 Unauthorized` または `403 Forbidden`

**対処**:

```bash
# 1. トークン有効期限確認
# フロントエンド: localStorage確認
localStorage.getItem('authToken')

# 2. JWT_SECRET一致確認
grep JWT_SECRET .env

# 3. ログアウト→再ログイン
localStorage.removeItem('authToken')

# 4. ユーザー存在確認
sqlite3 /mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db \
  "SELECT username, role FROM users WHERE username='admin';"

# 5. パスワードリセット（adminユーザー）
node -e "const bcrypt=require('bcryptjs'); console.log(bcrypt.hashSync('admin123', 10));"
# 出力されたハッシュをDBに直接更新
```

### 7.4 パフォーマンス問題

**症状**: API応答が遅い（1秒以上）

**対処**:

```bash
# 1. データベース最適化
sqlite3 /mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db "VACUUM; ANALYZE;"

# 2. インデックス作成
sqlite3 /mnt/LinuxHDD/ITSM-System/backend/itsm_nexus.db <<EOF
CREATE INDEX IF NOT EXISTS idx_incidents_status ON incident_tickets(status);
CREATE INDEX IF NOT EXISTS idx_incidents_priority ON incident_tickets(priority);
CREATE INDEX IF NOT EXISTS idx_created_at ON incident_tickets(created_at);
EOF

# 3. スロークエリ特定
# server.jsにログ追加
console.log('[QUERY TIME]', Date.now() - startTime, 'ms');

# 4. キャッシュ有効化（将来実装）
# Redis導入検討
```

---

## 付録

### A. 連絡先一覧

| 役割 | 担当者 | 連絡先 | 対応時間 |
|-----|--------|--------|---------|
| システム管理者 | Admin Team | admin@example.com | 24/7 |
| セキュリティ責任者 | Security Team | security@example.com | 24/7 |
| 開発チーム | Dev Team | dev@example.com | 平日9-18時 |
| 経営層 | Management | management@example.com | 平日9-18時 |

### B. エスカレーションマトリクス

| インシデント種類 | 優先度 | 初動対応 | エスカレーション先 | 対応期限 |
|---------------|--------|---------|-----------------|---------|
| システムダウン | Critical | オペレーター | シニアエンジニア（即時） | 1時間 |
| セキュリティ侵害 | Critical | オペレーター | セキュリティ責任者（即時） | 30分 |
| パフォーマンス劣化 | High | オペレーター | 開発チーム（1時間以内） | 4時間 |
| 機能不具合 | Medium | オペレーター | 開発チーム（翌営業日） | 24時間 |

### C. 定期メンテナンススケジュール

| 作業 | 頻度 | 実施時間 | 所要時間 | ダウンタイム |
|-----|------|---------|---------|------------|
| データベース最適化 | 週次 | 日曜 02:00 | 30分 | なし |
| セキュリティアップデート | 週次 | 月曜 10:00 | 1時間 | 5分 |
| 完全バックアップ | 月次 | 1日 01:00 | 1時間 | なし |
| システムヘルスチェック | 月次 | 20日 14:00 | 2時間 | なし |

---

**最終更新**: 2025-12-28
**バージョン**: 1.0.0
**承認者**: システム管理責任者

---

## 8. Microsoft 365 ユーザー同期

### 8.1 概要

Microsoft 365（Azure AD）からユーザー情報を自動取得し、ITSM-Sec Nexusのユーザーデータベースと同期する機能です。

**認証方式**: Client Credentials Flow（非対話型認証）

**必要な権限**: User.Read.All（Application）

### 8.2 初期設定

#### Azure AD アプリ登録

1. [Azure Portal](https://portal.azure.com) → Azure Active Directory → アプリの登録
2. 新規登録 → 名前: "ITSM-Sec Nexus"
3. API のアクセス許可 → Microsoft Graph → アプリケーションの許可
4. `User.Read.All` を追加 → 管理者の同意を付与
5. 証明書とシークレット → 新しいクライアントシークレット → 値をコピー

#### 環境変数設定

`.env` ファイルに以下を設定:

```bash
# Microsoft 365 Graph API Configuration
M365_TENANT_ID=your-tenant-id
M365_CLIENT_ID=your-client-id
M365_CLIENT_SECRET=your-client-secret
M365_GRAPH_ENDPOINT=https://graph.microsoft.com/v1.0
```

**重要**: `.env` ファイルはGitにコミットされません（.gitignoreに含まれています）

### 8.3 手動同期

#### 接続テスト

```bash
cd /mnt/LinuxHDD/ITSM-System
node backend/scripts/migrate/test-m365-connection.js
```

#### ユーザー同期実行

```bash
# 1. M365からユーザー抽出
node backend/scripts/migrate/extract-users-from-m365.js

# 2. データベースに投入
node backend/scripts/migrate/load-users.js --file=data/extracted/users-m365.json

# 3. サービス再起動（キャッシュクリア）
sudo systemctl restart itsm-system-https.service
```

#### 同期結果確認

```bash
# データベースのユーザー数確認
node -e "
const sqlite3 = require('sqlite3').verbose();
const db = new sqlite3.Database('backend/itsm_nexus.db');
db.get('SELECT COUNT(*) as count FROM users', (err, row) => {
  console.log('Total users:', row.count);
  db.close();
});
"
```

### 8.4 定期同期（cron設定）

#### 日次同期スクリプト

```bash
#!/bin/bash
# /usr/local/bin/m365-user-sync.sh

LOG_FILE="/var/log/itsm/m365-sync.log"
cd /mnt/LinuxHDD/ITSM-System

echo "[$(date)] Starting M365 user sync..." >> $LOG_FILE

# ユーザー抽出
node backend/scripts/migrate/extract-users-from-m365.js >> $LOG_FILE 2>&1

# データ投入
node backend/scripts/migrate/load-users.js --file=data/extracted/users-m365.json >> $LOG_FILE 2>&1

echo "[$(date)] M365 user sync completed" >> $LOG_FILE
```

#### cron設定

```bash
# 毎日 AM 6:00 に同期
0 6 * * * /usr/local/bin/m365-user-sync.sh
```

### 8.5 トラブルシューティング

| エラー | 原因 | 対処法 |
|-------|------|--------|
| `AADSTS7000215` | Client Secret が無効/期限切れ | Azure Portalで新しいシークレットを作成 |
| `AADSTS700016` | テナントID/クライアントIDが不正 | `.env`の値を確認 |
| `403 Insufficient privileges` | 権限不足 | Azure Portalで管理者の同意を付与 |
| `SQLITE_ERROR` | データベースエラー | `validate-migration.js`で検証 |

---

## 9. 本番環境設定

### 9.1 環境変数一覧

| 変数名 | 説明 | デフォルト |
|--------|------|----------|
| `NODE_ENV` | 環境モード | development |
| `PORT` | バックエンドポート | 5000 |
| `HTTPS_PORT` | HTTPSポート | 5443 |
| `FRONTEND_HTTPS_PORT` | フロントエンドHTTPSポート | 5050 |
| `SYSTEM_IP` | システムIPアドレス | - |
| `JWT_SECRET` | JWT署名キー | - |
| `DATABASE_PATH` | データベースパス | ./backend/itsm_nexus.db |
| `DISABLE_SEED_DATA` | シードデータ自動挿入無効化 | false |
| `M365_TENANT_ID` | Azure AD テナントID | - |
| `M365_CLIENT_ID` | Azure AD クライアントID | - |
| `M365_CLIENT_SECRET` | Azure AD クライアントシークレット | - |

### 9.2 systemd サービス管理

#### サービス一覧

| サービス名 | 説明 | ポート |
|-----------|------|--------|
| `itsm-system-https.service` | バックエンドAPI (HTTPS) | 5443 |
| `itsm-frontend.service` | フロントエンド (HTTPS) | 5050 |

#### 基本コマンド

```bash
# ステータス確認
sudo systemctl status itsm-system-https.service itsm-frontend.service

# 再起動
sudo systemctl restart itsm-system-https.service itsm-frontend.service

# 停止
sudo systemctl stop itsm-system-https.service itsm-frontend.service

# 起動
sudo systemctl start itsm-system-https.service itsm-frontend.service

# 自動起動有効化
sudo systemctl enable itsm-system-https.service itsm-frontend.service

# ログ確認
sudo journalctl -u itsm-system-https.service -f
```

### 9.3 HTTPS設定

#### 自己署名証明書の場所

```
ssl/
├── server.crt  # サーバー証明書
└── server.key  # 秘密鍵
```

#### 証明書更新手順

```bash
# 1. 新しい証明書を生成
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout ssl/server.key \
  -out ssl/server.crt \
  -subj "/CN=192.168.0.187"

# 2. サービス再起動
sudo systemctl restart itsm-system-https.service itsm-frontend.service
```

---

**最終更新**: 2026-01-07
**バージョン**: 2.0.0

---

## 10. 通知設定

### 10.1 通知チャネル設定

#### メール通知設定

```bash
# .envファイルに以下を設定
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_USER=noreply@example.com
SMTP_PASSWORD=your-password
SMTP_FROM=ITSM System <noreply@example.com>
```

**テスト送信**:
```bash
curl -X POST http://localhost:5000/api/v1/notifications \
  -H "Authorization: Bearer <admin-token>" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "test",
    "channel": "email",
    "recipient": "admin@example.com",
    "subject": "テスト通知",
    "message": "通知システムのテストメールです"
  }'
```

#### Slack通知設定

```bash
# .envファイルに以下を設定
SLACK_WEBHOOK_URL=https://hooks.slack.com/services/YOUR/WEBHOOK/URL
```

**テスト送信**:
```bash
curl -X POST http://localhost:5000/api/v1/notifications \
  -H "Authorization: Bearer <admin-token>" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "test",
    "channel": "slack",
    "message": "Slack通知テスト"
  }'
```

### 10.2 通知ルール設定

#### 通知優先度

| 優先度 | 説明 | 配信チャネル | 例 |
|--------|------|-------------|---|
| **High** | 即時対応必要 | メール + Slack | Criticalインシデント |
| **Medium** | 確認推奨 | メール | SLA違反警告 |
| **Low** | 情報提供 | システム内通知のみ | レポート完成 |

#### 通知設定例

```javascript
// 通知設定の取得
GET /api/v1/notifications/settings

// 通知設定の更新
PUT /api/v1/notifications/settings
{
  "channels": {
    "email": true,
    "slack": true,
    "webhook": false
  },
  "preferences": {
    "incidentCreated": "high",
    "slaViolation": "high",
    "reportGenerated": "low",
    "changeApproved": "medium"
  }
}
```

---

## 11. レポート生成手順

### 11.1 即時レポート生成

#### PDFレポート生成

```bash
# インシデントレポート生成
curl -X POST http://localhost:5000/api/v1/reports/generate \
  -H "Authorization: Bearer <admin-token>" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "incident",
    "format": "pdf",
    "filters": {
      "startDate": "2026-01-01",
      "endDate": "2026-01-31",
      "priority": "Critical"
    }
  }'

# SLAレポート生成
curl -X POST http://localhost:5000/api/v1/reports/generate \
  -H "Authorization: Bearer <admin-token>" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "sla",
    "format": "pdf",
    "filters": {
      "month": "2026-01"
    }
  }'
```

#### Excelレポート生成

```bash
curl -X POST http://localhost:5000/api/v1/reports/generate \
  -H "Authorization: Bearer <admin-token>" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "security",
    "format": "excel",
    "filters": {
      "startDate": "2026-01-01",
      "endDate": "2026-01-31"
    }
  }'
```

### 11.2 スケジュールレポート設定

#### 日次レポート設定

```bash
curl -X POST http://localhost:5000/api/v1/reports/scheduled \
  -H "Authorization: Bearer <admin-token>" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "日次インシデントレポート",
    "type": "incident",
    "format": "pdf",
    "schedule": "0 9 * * *",
    "recipients": ["manager@example.com"],
    "filters": {
      "status": "Open",
      "priority": ["High", "Critical"]
    }
  }'
```

#### 週次レポート設定

```bash
curl -X POST http://localhost:5000/api/v1/reports/scheduled \
  -H "Authorization: Bearer <admin-token>" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "週次SLAレポート",
    "type": "sla",
    "format": "excel",
    "schedule": "0 10 * * 1",
    "recipients": ["management@example.com"]
  }'
```

#### 月次レポート設定

```bash
curl -X POST http://localhost:5000/api/v1/reports/scheduled \
  -H "Authorization: Bearer <admin-token>" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "月次セキュリティレポート",
    "type": "security",
    "format": "pdf",
    "schedule": "0 9 1 * *",
    "recipients": ["security@example.com", "management@example.com"]
  }'
```

### 11.3 レポート管理

#### スケジュールレポート一覧

```bash
curl -H "Authorization: Bearer <admin-token>" \
  http://localhost:5000/api/v1/reports/scheduled
```

#### レポート履歴確認

```bash
curl -H "Authorization: Bearer <admin-token>" \
  http://localhost:5000/api/v1/reports?page=1&limit=20
```

#### レポートダウンロード

```bash
curl -H "Authorization: Bearer <admin-token>" \
  http://localhost:5000/api/v1/reports/<report-id> \
  -o report.pdf
```

---

## 12. 統合管理

### 12.1 Microsoft 365統合

#### 設定確認

```bash
# 接続テスト
node backend/scripts/migrate/test-m365-connection.js

# ユーザー同期実行
curl -X POST http://localhost:5000/api/v1/integrations/m365/sync \
  -H "Authorization: Bearer <admin-token>"
```

#### トラブルシューティング

| エラー | 原因 | 対処法 |
|-------|------|--------|
| `AADSTS7000215` | Client Secret が無効/期限切れ | Azure Portalで新しいシークレットを作成 |
| `AADSTS700016` | テナントID/クライアントIDが不正 | `.env`の値を確認 |
| `403 Insufficient privileges` | 権限不足 | Azure Portalで管理者の同意を付与 |

### 12.2 ServiceNow統合

#### 設定

```bash
# .envファイルに以下を設定
SERVICENOW_INSTANCE=https://your-instance.service-now.com
SERVICENOW_USERNAME=integration_user
SERVICENOW_PASSWORD=your-password
```

#### インシデント同期

```bash
# ServiceNowへインシデント送信
curl -X POST http://localhost:5000/api/v1/integrations/servicenow/sync \
  -H "Authorization: Bearer <admin-token>" \
  -H "Content-Type: application/json" \
  -d '{
    "incidentId": "INC-001",
    "direction": "push"
  }'
```

### 12.3 Webhook統合

#### Webhook設定

```bash
curl -X POST http://localhost:5000/api/v1/webhooks \
  -H "Authorization: Bearer <admin-token>" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "外部システム通知",
    "url": "https://external-system.example.com/webhook",
    "events": ["incident.created", "sla.violated"],
    "active": true
  }'
```

#### Webhookテスト

```bash
curl -X POST http://localhost:5000/api/v1/webhooks/<webhook-id>/test \
  -H "Authorization: Bearer <admin-token>"
```

---

### 更新履歴

#### 2026-01-07 (v2.0.0)
- **通知設定セクション追加**: メール/Slack/Webhook通知設定手順
- **レポート生成セクション追加**: 即時レポート、スケジュールレポート設定手順
- **統合管理セクション追加**: M365、ServiceNow、Webhook統合手順
- **トラブルシューティング拡張**: 通知、レポート、統合のエラー対処法追加

#### 2026-01-02 (v1.5.0)
- Microsoft 365ユーザー同期セクション追加
- 本番環境設定セクション追加
- systemdサービス管理手順追加
- DISABLE_SEED_DATA環境変数の説明追加

#### 2025-12-29 (v1.0.0)
- 監査ダッシュボード/コンプライアンス管理のUI詳細を反映
- 脆弱性管理の編集・削除を有効化
- ドキュメント参照先をDocs/に統一（docs/フォルダ削除）

