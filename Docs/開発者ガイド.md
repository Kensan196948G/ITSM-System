# ITSM-Sec Nexus 開発者ガイド

## 目次

1. [プロジェクト構造説明](#1-プロジェクト構造説明)
2. [技術スタック](#2-技術スタック)
3. [コーディング規約](#3-コーディング規約)
4. [新機能追加手順](#4-新機能追加手順)
5. [開発環境セットアップ](#5-開発環境セットアップ)
6. [トラブルシューティング](#6-トラブルシューティング)

---

## 1. プロジェクト構造説明

### 1.1 ディレクトリ構成

```
ITSM-System/
├── backend/                    # バックエンド（Node.js + Express）
│   ├── server.js              # メインサーバーファイル
│   ├── db.js                  # データベース設定・初期化
│   ├── swagger.js             # Swagger API仕様
│   ├── middleware/            # カスタムミドルウェア
│   │   ├── auth.js           # JWT認証ミドルウェア
│   │   └── validation.js     # 入力バリデーション
│   └── __tests__/            # テストファイル
│       ├── integration/      # 統合テスト
│       ├── unit/            # ユニットテスト
│       └── e2e/             # E2Eテスト
├── Docs/                      # 要件定義・設計・運用ドキュメント
├── e2e/                       # Playwrightテスト
├── utils/                     # ユーティリティスクリプト
├── app.js                     # フロントエンドアプリケーション（SPAロジック）
├── index.html                 # エントリーポイント（HTML）
├── style.css                  # スタイルシート
├── package.json              # プロジェクト設定
├── .env                      # 環境変数（秘匿情報）
├── .eslintrc.json            # ESLint設定（バックエンド）
├── .eslintrc.browser.json    # ESLint設定（フロントエンド）
└── jest.config.js            # Jestテスト設定
```

### 1.2 各ファイルの役割

#### バックエンド

| ファイル | 役割 |
|---------|------|
| `backend/server.js` | Express.jsサーバー、全APIエンドポイント、ルーティング |
| `backend/db.js` | SQLite3データベース接続、テーブル作成、初期データ投入 |
| `backend/swagger.js` | Swagger UI設定（API仕様書） |
| `backend/middleware/auth.js` | JWT認証、ロールベースアクセス制御（RBAC） |
| `backend/middleware/validation.js` | 入力バリデーションルール（express-validator） |

#### フロントエンド

| ファイル | 役割 |
|---------|------|
| `index.html` | HTMLエントリーポイント、レイアウト定義 |
| `app.js` | SPAロジック、ルーティング、API通信、XSS対策DOM操作 |
| `style.css` | UI/UXスタイリング、レスポンシブデザイン |

#### 設定・テスト

| ファイル | 役割 |
|---------|------|
| `.env` | 環境変数（JWT_SECRET、DB_PATH、PORT等） |
| `.eslintrc.json` | バックエンドコーディング規約（Airbnb） |
| `.eslintrc.browser.json` | フロントエンドコーディング規約 |
| `jest.config.js` | Jestテストランナー設定 |
| `package.json` | npm依存関係、スクリプト定義 |

### 1.3 アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                      クライアント                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ index.html  │  │   app.js    │  │  style.css  │        │
│  │  (構造)     │  │  (ロジック)  │  │  (装飾)     │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
│         ↓                ↓                                  │
│    DOM API使用   Fetch API（JWT付き）                       │
│    XSS対策完備   ────────────────────────────────────────▶│
└─────────────────────────────────────────────────────────────┘

### 1.4 主要画面

- セキュリティダッシュボード: アラート/監査ログ/ユーザーアクティビティを統合表示
- 監査ダッシュボード: 監査カバレッジ/スケジュール/指摘事項/証跡収集をタブで切替
- ポリシー・プロシージャー管理: ポリシー一覧、レビュー期限、運用手順の可視化
- コンプライアンス管理: エビデンス/監査/指摘事項/レポートの統合管理
- 脆弱性管理: CVSS/影響資産/ステータスの一覧と編集・削除操作
                                    ▼
┌─────────────────────────────────────────────────────────────┐
│                   Express.js サーバー                         │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ ミドルウェアチェーン                                    │  │
│  │  1. helmet (セキュリティヘッダー)                       │  │
│  │  2. cors (CORS設定)                                   │  │
│  │  3. morgan (ログ)                                     │  │
│  │  4. express.json() (JSON解析)                         │  │
│  │  5. authenticateToken (JWT認証)                       │  │
│  │  6. checkRole (ロール権限チェック)                      │  │
│  │  7. validateRequest (入力検証)                         │  │
│  └──────────────────────────────────────────────────────┘  │
│         ↓                                                    │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ APIエンドポイント                                       │  │
│  │  /api/v1/auth/*       - 認証                           │  │
│  │  /api/v1/dashboard/*  - KPI統計                        │  │
│  │  /api/v1/incidents/*  - インシデント管理                 │  │
│  │  /api/v1/changes/*    - 変更管理                        │  │
│  │  /api/v1/problems/*   - 問題管理                        │  │
│  │  /api/v1/assets/*     - 構成管理                        │  │
│  │  /api/v1/sla/*        - SLA管理                        │  │
│  │  /api/v1/security/*   - セキュリティ管理                 │  │
│  └──────────────────────────────────────────────────────┘  │
│         ↓                                                    │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ データベース層 (db.js)                                  │  │
│  │  - SQLite3接続                                         │  │
│  │  - パラメータ化クエリ（SQLインジェクション対策）           │  │
│  │  - トランザクション管理                                  │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                                    ▼
┌─────────────────────────────────────────────────────────────┐
│                SQLite3 データベース                           │
│  itsm_nexus.db                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. 技術スタック

### 2.1 バックエンド

| 技術 | バージョン | 用途 |
|-----|-----------|------|
| **Node.js** | v20+ | JavaScriptランタイム |
| **Express.js** | ^5.2.1 | Webフレームワーク |
| **SQLite3** | ^5.1.7 | データベース |
| **JWT** (jsonwebtoken) | ^9.0.3 | 認証トークン |
| **bcryptjs** | ^3.0.3 | パスワードハッシング |
| **express-validator** | ^7.3.1 | 入力バリデーション |
| **helmet** | ^8.1.0 | セキュリティヘッダー |
| **cors** | ^2.8.5 | CORS管理 |
| **morgan** | ^1.10.1 | HTTPログ |
| **dotenv** | ^17.2.3 | 環境変数管理 |
| **uuid** | ^9.0.0 | ユニークID生成 |
| **xlsx** | ^0.18.5 | Excelエクスポート |
| **swagger-ui-express** | ^5.0.1 | API仕様書 |

### 2.2 フロントエンド

| 技術 | バージョン | 用途 |
|-----|-----------|------|
| **Vanilla JavaScript** | ES2021 | SPAロジック |
| **DOM API** | - | XSS安全な操作 |
| **Fetch API** | - | HTTP通信 |
| **Chart.js** | ^4.5.1 | グラフ描画 |
| **CSS3** | - | スタイリング |

### 2.3 開発・テストツール

| 技術 | バージョン | 用途 |
|-----|-----------|------|
| **Jest** | ^30.2.0 | テストフレームワーク |
| **Supertest** | ^7.1.4 | API統合テスト |
| **Playwright** | ^1.57.0 | E2Eテスト |
| **ESLint** | ^8.57.1 | コード品質 |
| **Prettier** | ^3.7.4 | コードフォーマット |
| **Husky** | ^9.1.7 | Gitフック |
| **lint-staged** | ^16.2.7 | コミット前チェック |

### 2.4 セキュリティ対策

#### 認証・認可
- **JWT認証**: HS256アルゴリズム、24時間有効期限
- **RBAC**: 4つのロール（admin, manager, analyst, viewer）
- **パスワードハッシング**: bcrypt 10ラウンド

#### 入力検証
- **express-validator**: 全APIエンドポイント
- **SQLインジェクション対策**: パラメータ化クエリ（db.run/db.all）
- **XSS対策**: DOM API（createElement/textContent）完全使用

#### セキュリティヘッダー
- **helmet**: CSP、X-Frame-Options、HSTS等
- **CORS**: ホワイトリスト方式（環境変数で制御）

---

## 3. コーディング規約

### 3.1 ESLint設定

#### バックエンド（.eslintrc.json）

```json
{
  "extends": "airbnb-base",
  "rules": {
    "no-console": "off",          // サーバーログは許可
    "camelcase": "off",           // DB列名はスネークケース
    "prefer-const": "error",      // 再代入しない変数はconst
    "no-var": "error",            // var禁止
    "comma-dangle": ["error", "never"], // 末尾カンマ禁止
    "max-len": ["warn", { "code": 120 }] // 1行120文字
  }
}
```

#### フロントエンド（.eslintrc.browser.json）

```json
{
  "env": { "browser": true },
  "extends": "airbnb-base",
  "rules": {
    "no-use-before-define": "off", // 関数定義順序柔軟
    "no-restricted-syntax": [
      "error",
      {
        "selector": "CallExpression[callee.property.name='innerHTML']",
        "message": "innerHTML is prohibited. Use DOM API (createElement, textContent)"
      }
    ]
  }
}
```

### 3.2 XSS安全ルール

#### 禁止事項

```javascript
// ❌ 絶対禁止
element.innerHTML = userInput;
element.outerHTML = data;
document.write(content);
eval(userCode);

// ❌ DOMベースXSS脆弱性
element.setAttribute('onclick', userInput);
location.href = userInput; // 検証なし
```

#### 推奨パターン

```javascript
// ✅ 安全なDOM操作
const div = document.createElement('div');
div.textContent = userInput; // 自動エスケープ
div.className = 'safe-class';
parentElement.appendChild(div);

// ✅ URL検証
if (url.startsWith('http://') || url.startsWith('https://')) {
  location.href = url;
}

// ✅ HTMLエスケープ関数
function escapeHTML(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}
```

### 3.3 命名規則

| 対象 | 規則 | 例 |
|-----|------|---|
| **変数・関数** | camelCase | `getUserData`, `isAuthenticated` |
| **定数** | UPPER_SNAKE_CASE | `JWT_SECRET`, `MAX_ATTEMPTS` |
| **クラス** | PascalCase | `AuthMiddleware`, `DatabaseService` |
| **プライベート変数** | _prefix | `_internalState` |
| **DBテーブル** | snake_case | `users`, `incident_tickets` |
| **DB列名** | snake_case | `user_id`, `created_at` |

### 3.4 コメント規約

```javascript
/**
 * ユーザー認証を行う（JSDoc形式）
 * @param {string} username - ユーザー名
 * @param {string} password - パスワード
 * @returns {Promise<Object>} トークンとユーザー情報
 * @throws {Error} 認証失敗時
 */
async function authenticateUser(username, password) {
  // TODO: 2要素認証を追加予定
  // FIXME: パスワードリセット機能のバグ修正必要

  // 1. ユーザー検索
  const user = await findUser(username);

  // 2. パスワード検証
  const isValid = await bcrypt.compare(password, user.password_hash);

  return { token, user };
}
```

---

## 4. 新機能追加手順

### 4.1 フロントエンド：新しいrender関数追加

#### ステップ1: 関数定義（app.js）

```javascript
// ========================================
// 17. 新機能レンダリング
// ========================================
function renderNewFeature() {
  const container = document.getElementById('main-content');
  container.innerHTML = ''; // 既存コンテンツクリア

  // XSS安全なDOM構築
  const title = document.createElement('h2');
  title.textContent = '新機能タイトル';
  container.appendChild(title);

  // テーブル作成
  const table = createTableWithActions(
    ['列1', '列2', '列3'],
    [],
    'new-feature-table'
  );
  container.appendChild(table);

  // データ取得
  fetchNewFeatureData();
}
```

#### ステップ2: データ取得関数

```javascript
async function fetchNewFeatureData() {
  try {
    const token = localStorage.getItem('authToken');
    const response = await fetch(`${API_BASE_URL}/new-feature`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });

    if (!response.ok) throw new Error('データ取得失敗');

    const data = await response.json();
    updateNewFeatureTable(data);
  } catch (error) {
    showToast('エラーが発生しました', 'error');
  }
}
```

#### ステップ3: ルーティング追加

```javascript
// ナビゲーション処理
document.addEventListener('DOMContentLoaded', () => {
  // ナビゲーションイベント
  document.getElementById('nav-new-feature')?.addEventListener('click', (e) => {
    e.preventDefault();
    renderNewFeature();
  });
});
```

### 4.2 バックエンド：新しいAPIエンドポイント追加

#### ステップ1: バリデーション定義（middleware/validation.js）

```javascript
// 新機能バリデーション
newFeature: [
  body('name')
    .trim()
    .notEmpty().withMessage('名前は必須です')
    .isLength({ max: 100 }).withMessage('名前は100文字以内'),
  body('value')
    .isInt({ min: 0 }).withMessage('値は0以上の整数'),
  handleValidationErrors
]
```

#### ステップ2: エンドポイント実装（server.js）

```javascript
// ========================================
// 新機能API
// ========================================

/**
 * GET /api/v1/new-feature
 * 新機能データ一覧取得
 */
app.get(
  '/api/v1/new-feature',
  authenticateToken,
  (req, res) => {
    const sql = `
      SELECT id, name, value, created_at
      FROM new_feature_table
      ORDER BY created_at DESC
    `;

    db.all(sql, [], (err, rows) => {
      if (err) {
        return res.status(500).json({ error: 'データベースエラー' });
      }
      res.json({ success: true, data: rows });
    });
  }
);

/**
 * POST /api/v1/new-feature
 * 新規作成（analyst以上）
 */
app.post(
  '/api/v1/new-feature',
  authenticateToken,
  checkRole(['analyst', 'manager', 'admin']),
  validationRules.newFeature,
  (req, res) => {
    const { name, value } = req.body;
    const id = uuid.v4();

    const sql = `
      INSERT INTO new_feature_table (id, name, value, created_by)
      VALUES (?, ?, ?, ?)
    `;

    db.run(sql, [id, name, value, req.user.username], function(err) {
      if (err) {
        return res.status(500).json({ error: '作成失敗' });
      }
      res.status(201).json({ success: true, id });
    });
  }
);
```

#### ステップ3: データベーステーブル追加（db.js）

```javascript
// 新機能テーブル作成
db.run(`
  CREATE TABLE IF NOT EXISTS new_feature_table (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    value INTEGER DEFAULT 0,
    created_by TEXT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (created_by) REFERENCES users(username)
  )
`);
```

### 4.3 テスト追加

#### 統合テスト（__tests__/integration/new-feature.test.js）

```javascript
const request = require('supertest');
const app = require('../../server');

describe('New Feature API', () => {
  let authToken;

  beforeAll(async () => {
    const res = await request(app)
      .post('/api/v1/auth/login')
      .send({ username: 'admin', password: 'admin123' });
    authToken = res.body.token;
  });

  it('should get all new feature data', async () => {
    const res = await request(app)
      .get('/api/v1/new-feature')
      .set('Authorization', `Bearer ${authToken}`);

    expect(res.status).toBe(200);
    expect(res.body.success).toBe(true);
  });

  it('should create new feature (analyst)', async () => {
    const res = await request(app)
      .post('/api/v1/new-feature')
      .set('Authorization', `Bearer ${authToken}`)
      .send({ name: 'Test Feature', value: 100 });

    expect(res.status).toBe(201);
    expect(res.body.success).toBe(true);
  });
});
```

### 4.4 ドキュメント更新

1. **API仕様書更新**: `backend/swagger.js`にエンドポイント追加
2. **README更新**: 新機能の説明を追加
3. **このガイド更新**: 新機能特有の注意点を追記

---

## 5. 開発環境セットアップ

### 5.1 依存関係インストール

```bash
# Node.js v20以上が必要
node --version  # v20.x.x以上を確認

# プロジェクトクローン
git clone <repository-url>
cd ITSM-System

# 依存関係インストール
npm install
```

### 5.2 環境変数設定

```bash
# .envファイル作成
cp .env.example .env

# .env編集（重要）
nano .env
```

**.env設定例**

```env
# サーバー設定
PORT=3000
NODE_ENV=development

# データベース
DB_PATH=./backend/itsm_nexus.db

# JWT認証
JWT_SECRET=your-super-secret-jwt-key-change-this-in-production
JWT_EXPIRES_IN=24h

# CORS設定
ALLOWED_ORIGINS=http://localhost:5050,http://192.168.0.187:5050

# ログレベル
LOG_LEVEL=info
```

### 5.3 データベース初期化

```bash
# 初回起動時に自動で初期化される
npm start

# または手動で初期化スクリプト実行（カスタマイズ可能）
node utils/init-db.js
```

**確認方法**

```bash
# SQLiteコマンドラインツール
sqlite3 backend/itsm_nexus.db

# テーブル確認
.tables

# ユーザー確認
SELECT username, role FROM users;

# 終了
.quit
```

### 5.4 サーバー起動

#### 方法1: 個別起動（開発推奨）

```bash
# ターミナル1: バックエンド起動
npm start
# または開発モード（ホットリロード）
npm run dev

# ターミナル2: フロントエンド起動
python3 -m http.server 5050 --bind 0.0.0.0
# または
npx http-server -p 5050 -a 0.0.0.0
```

#### 方法2: シェルスクリプト使用

```bash
chmod +x start-system.sh
./start-system.sh
```

#### アクセス確認

```bash
# バックエンドヘルスチェック
curl http://localhost:3000/api/v1/health

# フロントエンドアクセス
# ブラウザで http://localhost:5050/index.html
```

### 5.5 テスト実行

```bash
# 全テスト実行
npm test

# ウォッチモード（開発中）
npm run test:watch

# カバレッジレポート
npm run test:coverage

# ユニットテストのみ
npm run test:unit

# 統合テストのみ
npm run test:integration
```

### 5.6 コード品質チェック

```bash
# ESLint実行
npm run lint

# 自動修正
npm run lint:fix

# Prettierフォーマット確認
npm run format:check

# 自動フォーマット
npm run format
```

---

## 6. トラブルシューティング

### 6.1 よくあるエラーと解決方法

#### エラー1: サーバー起動失敗

**症状**
```
Error: listen EADDRINUSE: address already in use :::3000
```

**原因**: ポート3000が既に使用されている

**解決方法**
```bash
# 既存プロセス確認
lsof -i :3000
# または
netstat -ano | grep 3000

# プロセス停止
kill -9 <PID>

# または別ポート使用
PORT=3001 npm start
```

#### エラー2: データベース接続エラー

**症状**
```
Error: SQLITE_CANTOPEN: unable to open database file
```

**原因**: データベースファイルのパスが間違っている、または権限不足

**解決方法**
```bash
# ディレクトリ存在確認
ls -la backend/

# 権限確認
ls -la backend/itsm_nexus.db

# 権限付与
chmod 664 backend/itsm_nexus.db
chmod 775 backend/

# 環境変数確認
echo $DB_PATH
```

#### エラー3: JWT認証エラー

**症状**
```
401 Unauthorized: Invalid token
```

**原因**: トークン期限切れ、またはJWT_SECRETが一致しない

**解決方法**
```javascript
// フロントエンド: ログアウト→再ログイン
localStorage.removeItem('authToken');
// 再度ログイン画面へ

// バックエンド: .envのJWT_SECRET確認
cat .env | grep JWT_SECRET

// トークン再生成
const newToken = jwt.sign(payload, process.env.JWT_SECRET, {
  expiresIn: '24h'
});
```

#### エラー4: CORSエラー

**症状**
```
Access to fetch at 'http://localhost:3000/api/v1/...' from origin
'http://localhost:5050' has been blocked by CORS policy
```

**原因**: ALLOWED_ORIGINSに許可されていないオリジン

**解決方法**
```bash
# .env編集
ALLOWED_ORIGINS=http://localhost:5050,http://192.168.0.187:5050

# サーバー再起動
npm start
```

#### エラー5: XSS検出エラー（開発時）

**症状**
```
ESLint: innerHTML is prohibited. Use DOM API (createElement, textContent)
```

**原因**: innerHTML使用

**解決方法**
```javascript
// ❌ 修正前
element.innerHTML = `<div>${data}</div>`;

// ✅ 修正後
const div = document.createElement('div');
div.textContent = data;
element.appendChild(div);
```

### 6.2 デバッグ方法

#### バックエンドデバッグ

```javascript
// console.logデバッグ
console.log('[DEBUG] User data:', req.user);
console.log('[DEBUG] Request body:', req.body);

// Node.js Inspectorデバッグ
node --inspect backend/server.js
// Chrome DevToolsで chrome://inspect にアクセス

// Visual Studio Code デバッグ設定（.vscode/launch.json）
{
  "type": "node",
  "request": "launch",
  "name": "Debug Backend",
  "program": "${workspaceFolder}/backend/server.js",
  "envFile": "${workspaceFolder}/.env"
}
```

#### フロントエンドデバッグ

```javascript
// Chrome DevTools使用
debugger; // ブレークポイント設定

// ネットワークタブ
// - API通信確認
// - リクエストヘッダー（Authorization）確認
// - レスポンス内容確認

// Consoleタブ
console.table(data); // テーブル形式表示
console.group('API Response');
console.log('Status:', response.status);
console.log('Data:', data);
console.groupEnd();
```

### 6.3 ログの確認方法

#### アプリケーションログ

```bash
# リアルタイムログ確認
npm start | tee logs/app.log

# morganログ（HTTPリクエスト）
# サーバーコンソールに自動出力
# 例: GET /api/v1/incidents 200 45.123 ms
```

#### データベースログ

```javascript
// db.jsでSQLログ有効化
db.on('trace', (sql) => {
  console.log('[SQL]', sql);
});
```

#### エラーログ

```javascript
// server.jsのエラーハンドラー
app.use((err, req, res, next) => {
  console.error('[ERROR]', err.stack);
  res.status(500).json({ error: 'サーバーエラー' });
});
```

### 6.4 パフォーマンス問題

#### 症状: API応答が遅い

**解決策**
```sql
-- SQLインデックス追加
CREATE INDEX idx_incidents_status ON incident_tickets(status);
CREATE INDEX idx_created_at ON incident_tickets(created_at);

-- クエリ最適化
EXPLAIN QUERY PLAN SELECT * FROM incident_tickets WHERE status = 'Open';
```

#### 症状: メモリリーク

**確認方法**
```bash
# Node.jsメモリ使用量監視
node --max-old-space-size=512 backend/server.js

# プロセスメモリ確認
ps aux | grep node
```

**解決策**
```javascript
// データベース接続を適切にクローズ
db.close((err) => {
  if (err) console.error(err);
});

// イベントリスナー削除
element.removeEventListener('click', handler);
```

---

## 付録

### A. 開発者チェックリスト

新機能実装時の確認項目:

- [ ] XSS対策: DOM API使用（innerHTML禁止）
- [ ] SQLインジェクション対策: パラメータ化クエリ
- [ ] 認証: authenticateToken適用
- [ ] 認可: checkRole適用
- [ ] バリデーション: express-validator使用
- [ ] エラーハンドリング: try-catchとステータスコード適切
- [ ] テスト: カバレッジ80%以上
- [ ] ESLint: エラーゼロ
- [ ] ドキュメント: API仕様書更新
- [ ] ログ: 適切なログ出力

### B. 参考リンク

- [Express.js公式ドキュメント](https://expressjs.com/)
- [SQLite3 Node.js API](https://github.com/TryGhost/node-sqlite3)
- [JWT公式サイト](https://jwt.io/)
- [OWASP XSS対策](https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html)
- [Airbnb JavaScript Style Guide](https://github.com/airbnb/javascript)

---

**最終更新**: 2025-12-28
**バージョン**: 1.0.0

---
### 更新メモ (2025-12-29)
- 監査ダッシュボード/コンプライアンス管理のUI詳細を反映
- 脆弱性管理の編集・削除を有効化
- ドキュメント参照先をDocs/に統一（docs/フォルダ削除）

