#####################################################################
# ğŸ¤– è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ ï¼ˆ5åˆ†é–“éš”ãƒ»ç„¡é™ãƒ«ãƒ¼ãƒ—ï¼‰
#
# ã‚¹ã‚­ãƒ¼ãƒãƒãƒ¼ã‚¸ãƒ§ãƒ³: state-v2.json
# å®Ÿè¡Œé–“éš”: 5åˆ†ï¼ˆcron: */5 * * * *ï¼‰
# ãƒ«ãƒ¼ãƒ—å›æ•°: 15å›ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
# å¾…æ©Ÿæ™‚é–“: 2ç§’ï¼ˆãƒ«ãƒ¼ãƒ—é–“ï¼‰
#
# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ä»¥ä¸‹ã®åŸå‰‡ã«åŸºã¥ã„ã¦å‹•ä½œã—ã¾ã™ï¼š
#
# ã€GitHub Actions ã®å½¹å‰²ã€‘åˆ¶å¾¡ã‚¨ãƒ³ã‚¸ãƒ³ + ãƒ˜ãƒ«ã‚¹ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°
# - 5åˆ†é–“éš”ã§Workflowã‚’èµ·å‹•ã™ã‚‹
# - Pythonãƒ™ãƒ¼ã‚¹ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹
# - ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ã‚¨ãƒ©ãƒ¼ã‚’æ¤œçŸ¥ã™ã‚‹
# - Node.jsãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹
# - æˆåŠŸ or å¤±æ•—ã‚’åˆ¤å®šã™ã‚‹
# - 1å›ã®Runã§æœ€å¤§15å›ã®ä¿®å¾©ãƒ«ãƒ¼ãƒ—ã‚’å®Ÿè¡Œ
# - Issueé€šçŸ¥ï¼ˆå¤±æ•—æ™‚ï¼‰+ Artifactä¿å­˜
#
# ã€è‡ªå‹•ä¿®å¾©ãƒ‡ãƒ¼ãƒ¢ãƒ³ã®å½¹å‰²ã€‘ä¿®å¾©ã‚¨ãƒ³ã‚¸ãƒ³
# - auto_fix_daemon.py ã«ã‚ˆã‚‹ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥
# - error_patterns.json ã«åŸºã¥ã„ãŸè‡ªå‹•ä¿®å¾©
# - 13ç¨®é¡ã®ä¿®å¾©ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚µãƒ¼ãƒ“ã‚¹å†èµ·å‹•ã€ãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ç­‰ï¼‰
# - ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³æ©Ÿèƒ½ï¼ˆåŒä¸€ã‚¨ãƒ©ãƒ¼300ç§’ï¼‰
#
# ã€ClaudeCode ã®å½¹å‰²ã€‘é«˜åº¦ä¿®å¾©ã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆå°†æ¥å¯¾å¿œï¼‰
# - ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼ã®å†…å®¹ã‚’èª­ã‚€
# - æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã®æ§‹é€ ã‚’ç†è§£ã™ã‚‹
# - CLAUDE.mdï¼ˆãƒ«ãƒ¼ãƒ«ãƒ»æ†²æ³•ï¼‰ã‚’å¿…ãšå®ˆã‚‹
# - README.mdï¼ˆä»•æ§˜æ›¸ï¼‰ã‚’å¤‰æ›´ã—ãªã„
# - ã‚¨ãƒ©ãƒ¼ã®åŸå› ã‚’ç‰¹å®šã—ã€å¿…è¦æœ€å°é™ã®ä¿®æ­£ã‚’è¡Œã†
#
#####################################################################

name: ğŸ¤– è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ ï¼ˆ5åˆ†é–“éš”ï¼‰ITSM-Systemç‰ˆ

on:
  schedule:
    - cron: '*/5 * * * *'  # æ¯5åˆ†å®Ÿè¡Œï¼ˆUTCï¼‰
  workflow_dispatch:
    inputs:
      max_loops:
        description: 'æœ€å¤§ãƒ«ãƒ¼ãƒ—å›æ•°'
        default: '15'
        type: string
      create_issue:
        description: 'Issueä½œæˆï¼ˆyes/noï¼‰'
        default: 'yes'
        type: choice
        options:
          - 'yes'
          - 'no'

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  STATE_FILE: '.github/auto-repair/state-v2.json'
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.12'
  NODE_ENV: test
  DATABASE_PATH: ./backend/test_itsm.db
  JWT_SECRET: ${{ secrets.JWT_SECRET_TEST }}
  JWT_EXPIRES_IN: '1h'
  REFRESH_TOKEN_EXPIRES_DAYS: '7'
  ENABLE_HTTPS: 'false'
  SCHEDULER_ENABLED: 'false'
  PORT: '5100'
  MAX_LOOPS: ${{ github.event.inputs.max_loops || '15' }}
  LOOP_INTERVAL_SECONDS: '2'
  COOLDOWN_PERIOD: '300'

jobs:
  #####################################################################
  # Job 1: è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ãƒ«ãƒ¼ãƒ—ï¼ˆ15å›ãƒ«ãƒ¼ãƒ—ï¼‰
  #####################################################################
  auto-fix:
    name: è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ãƒ«ãƒ¼ãƒ—
    runs-on: ubuntu-latest
    timeout-minutes: 10

    outputs:
      success: ${{ steps.auto-fix-loop.outputs.success }}
      attempts: ${{ steps.auto-fix-loop.outputs.attempts }}
      final_status: ${{ steps.auto-fix-loop.outputs.final_status }}
      health_status: ${{ steps.health-check.outputs.status }}
      errors_detected: ${{ steps.auto-fix-loop.outputs.errors_detected }}
      fixes_attempted: ${{ steps.auto-fix-loop.outputs.fixes_attempted }}

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      #####################################################################
      # ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      #####################################################################
      - name: Node.jsç’°å¢ƒæ§‹ç¯‰
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Pythonç’°å¢ƒæ§‹ç¯‰
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Pythonä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          python -m pip install --upgrade pip
          pip install requests psutil

      - name: Node.jsä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      - name: Gitã‚’è¨­å®š
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
        run: npm run migrate:latest

      - name: ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
        run: |
          mkdir -p backend/logs
          touch backend/logs/app.log
          touch backend/logs/auto_fix.log
          touch backend/logs/alerts.log

      - name: state-v2.jsonåˆæœŸåŒ–ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆï¼‰
        run: |
          if [ ! -f "$STATE_FILE" ]; then
            echo "ğŸ“ state-v2.json ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€åˆæœŸåŒ–ã—ã¾ã™"
            mkdir -p .github/auto-repair
            echo '{
              "schema_version": "2.0",
              "last_run": {
                "timestamp": null,
                "status": "none",
                "attempts": 0,
                "run_id": null
              },
              "stats": {
                "total_runs": 0,
                "successful_runs": 0,
                "failed_runs": 0,
                "errors_detected": 0,
                "fixes_attempted": 0
              }
            }' | jq . > $STATE_FILE
            echo "âœ… state-v2.json ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ"
          fi

      #####################################################################
      # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œï¼ˆPythonã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼‰
      #####################################################################
      - name: ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
        id: health-check
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ¥ ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          cd backend/scripts
          python3 health_monitor.py > ../../health-check-result.json || true

          if [ -f ../../health-check-result.json ]; then
            cat ../../health-check-result.json | jq .

            # ãƒ˜ãƒ«ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—
            HEALTH_STATUS=$(cat ../../health-check-result.json | jq -r '.overall_status' 2>/dev/null || echo "unknown")
            echo "status=$HEALTH_STATUS" >> $GITHUB_OUTPUT

            echo ""
            echo "âœ… ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Œäº†: $HEALTH_STATUS"
          else
            echo "âš ï¸ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯çµæœãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
            echo "status=unknown" >> $GITHUB_OUTPUT
          fi

      #####################################################################
      # 15å›ãƒ«ãƒ¼ãƒ—å®Ÿè¡Œï¼ˆä»•æ§˜æº–æ‹ ï¼‰
      #####################################################################
      - name: è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ãƒ«ãƒ¼ãƒ—ï¼ˆ15å›ï¼‰
        id: auto-fix-loop
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”„ è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ãƒ«ãƒ¼ãƒ—ã‚’é–‹å§‹ã—ã¾ã™"
          echo "   ãƒ«ãƒ¼ãƒ—å›æ•°: $MAX_LOOPS å›"
          echo "   å¾…æ©Ÿæ™‚é–“: $LOOP_INTERVAL_SECONDS ç§’ï¼ˆãƒ«ãƒ¼ãƒ—é–“ï¼‰"
          echo "   ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³: $COOLDOWN_PERIOD ç§’"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          ATTEMPT=0
          SUCCESS=false
          FINAL_STATUS="failed"
          TOTAL_ERRORS_DETECTED=0
          TOTAL_FIXES_ATTEMPTED=0

          while [ $ATTEMPT -lt $MAX_LOOPS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ” ã‚µã‚¤ã‚¯ãƒ« $ATTEMPT / $MAX_LOOPS"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            # ========================================
            # ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆå„ã‚µã‚¤ã‚¯ãƒ«ï¼‰
            # ========================================
            echo ""
            echo "ğŸ“‹ [1/5] ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ..."
            cd backend/scripts
            python3 -c "
import sys
sys.path.insert(0, '.')
try:
    from health_monitor import HealthMonitor
    monitor = HealthMonitor()
    result = monitor.run_all_checks()
    status = result.get('overall_status', 'unknown')
    print(f'  ãƒ˜ãƒ«ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: {status}')
    if status != 'healthy':
        print(f'  âš ï¸ å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ')
        for check_name, check_result in result.get('checks', {}).items():
            if check_result.get('status') != 'healthy':
                print(f'    - {check_name}: {check_result.get(\"status\")}')
except Exception as e:
    print(f'  ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¹ã‚­ãƒƒãƒ—: {e}')
" 2>&1 || true
            cd ../..

            # ========================================
            # ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ­ã‚°ã‚¹ã‚­ãƒ£ãƒ³ + è‡ªå‹•ä¿®å¾©ï¼ˆPythonãƒ‡ãƒ¼ãƒ¢ãƒ³ï¼‰
            # ========================================
            echo ""
            echo "ğŸ“‹ [2/5] ãƒ­ã‚°ã‚¹ã‚­ãƒ£ãƒ³ + è‡ªå‹•ä¿®å¾©..."

            cd backend/scripts
            SCAN_RESULT=$(python3 -c "
import sys
import json
sys.path.insert(0, '.')
from auto_fix_daemon import AutoFixDaemon

daemon = AutoFixDaemon()
log_paths = [
    '../logs/app.log',
    '../logs/auto_fix.log',
    '../logs/alerts.log'
]

# ãƒ­ã‚°ã‚¹ã‚­ãƒ£ãƒ³
errors = daemon.scan_logs(log_paths)

# ã‚¨ãƒ©ãƒ¼ä¿®å¾©
fixes_attempted = 0
for error in errors:
    if daemon.auto_fix_error(error):
        fixes_attempted += 1

# çµæœå‡ºåŠ›ï¼ˆJSONå½¢å¼ï¼‰
result = {
    'errors_detected': len(errors),
    'fixes_attempted': fixes_attempted,
    'error_names': [e['name'] for e in errors[:5]]
}
print(json.dumps(result))
" 2>&1 || echo '{"errors_detected":0,"fixes_attempted":0,"error_names":[]}')
            cd ../..

            # çµæœã‚’è§£æ
            ERRORS_IN_CYCLE=$(echo "$SCAN_RESULT" | grep -o '"errors_detected":[0-9]*' | grep -o '[0-9]*' || echo "0")
            FIXES_IN_CYCLE=$(echo "$SCAN_RESULT" | grep -o '"fixes_attempted":[0-9]*' | grep -o '[0-9]*' || echo "0")
            TOTAL_ERRORS_DETECTED=$((TOTAL_ERRORS_DETECTED + ERRORS_IN_CYCLE))
            TOTAL_FIXES_ATTEMPTED=$((TOTAL_FIXES_ATTEMPTED + FIXES_IN_CYCLE))

            if [ "$ERRORS_IN_CYCLE" -gt 0 ]; then
              echo "  âš ï¸ ${ERRORS_IN_CYCLE}ä»¶ã®ã‚¨ãƒ©ãƒ¼ã‚’æ¤œå‡ºã€${FIXES_IN_CYCLE}ä»¶ã®ä¿®å¾©ã‚’è©¦è¡Œ"
            else
              echo "  âœ“ ã‚¨ãƒ©ãƒ¼ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
            fi

            # ========================================
            # ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
            # ========================================
            echo ""
            echo "ğŸ“Š [3/5] ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."

            if npm test 2>&1 | tee test-output.log; then
              echo "âœ… ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼"
              SUCCESS=true
              FINAL_STATUS="success"
              break
            else
              echo "âŒ ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ"

              # ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã‚’æŠ½å‡º
              echo ""
              echo "  ğŸ“‹ å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã®è©³ç´°:"
              grep -A 3 "FAIL\|âœ•" test-output.log | head -20 || true
            fi

            # ========================================
            # ã‚¹ãƒ†ãƒƒãƒ—4: ã‚³ãƒ¼ãƒ‰è‡ªå‹•ä¿®å¾©ã‚’å®Ÿè¡Œ
            # ========================================
            echo ""
            echo "ğŸ”§ [4/5] ã‚³ãƒ¼ãƒ‰è‡ªå‹•ä¿®å¾©ã‚’å®Ÿè¡Œä¸­..."

            # ESLintè‡ªå‹•ä¿®æ­£
            echo "  ğŸ”§ [4a] ESLintè‡ªå‹•ä¿®æ­£..."
            npm run lint:fix 2>&1 || true

            # Prettierè‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            echo "  ğŸ”§ [4b] Prettierè‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ..."
            npm run format 2>&1 || true

            # TypeScriptã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
            if [ -f "tsconfig.json" ]; then
              echo "  ğŸ”§ [4c] TypeScriptã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯..."
              npx tsc --noEmit 2>&1 || true
            fi

            # å¤‰æ›´ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
            git add -A
            if ! git diff --cached --quiet; then
              echo "  âœ“ å¤‰æ›´ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã—ã¾ã—ãŸ"
              TOTAL_FIXES_ATTEMPTED=$((TOTAL_FIXES_ATTEMPTED + 1))
            else
              echo "  âš ï¸  è‡ªå‹•ä¿®æ­£ã«ã‚ˆã‚‹å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
            fi

            # ========================================
            # ã‚¹ãƒ†ãƒƒãƒ—5: å¾…æ©Ÿï¼ˆ2ç§’ï¼‰
            # ========================================
            if [ $ATTEMPT -lt $MAX_LOOPS ]; then
              echo ""
              echo "â³ [5/5] æ¬¡ã®ã‚µã‚¤ã‚¯ãƒ«ã¾ã§${LOOP_INTERVAL_SECONDS}ç§’å¾…æ©Ÿ..."
              sleep $LOOP_INTERVAL_SECONDS
            fi
          done

          # ========================================
          # æœ€çµ‚çµæœã‚’å‡ºåŠ›å¤‰æ•°ã«è¨­å®š
          # ========================================
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š ãƒ«ãƒ¼ãƒ—å®Œäº†çµ±è¨ˆ:"
          echo "   ç·ã‚µã‚¤ã‚¯ãƒ«æ•°: $ATTEMPT"
          echo "   æ¤œå‡ºã‚¨ãƒ©ãƒ¼æ•°: $TOTAL_ERRORS_DETECTED"
          echo "   ä¿®å¾©è©¦è¡Œæ•°: $TOTAL_FIXES_ATTEMPTED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if [ "$SUCCESS" = "true" ]; then
            echo "âœ… ä¿®å¾©ãƒ«ãƒ¼ãƒ—æˆåŠŸï¼ˆã‚µã‚¤ã‚¯ãƒ«: $ATTEMPTï¼‰"
            echo "success=true" >> $GITHUB_OUTPUT
            echo "attempts=$ATTEMPT" >> $GITHUB_OUTPUT
            echo "final_status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ ä¿®å¾©ãƒ«ãƒ¼ãƒ—å¤±æ•—ï¼ˆæœ€å¤§ã‚µã‚¤ã‚¯ãƒ«æ•°ã«åˆ°é”ï¼‰"
            echo "success=false" >> $GITHUB_OUTPUT
            echo "attempts=$ATTEMPT" >> $GITHUB_OUTPUT
            echo "final_status=failed" >> $GITHUB_OUTPUT
          fi

          echo "errors_detected=$TOTAL_ERRORS_DETECTED" >> $GITHUB_OUTPUT
          echo "fixes_attempted=$TOTAL_FIXES_ATTEMPTED" >> $GITHUB_OUTPUT

      #####################################################################
      # çµæœãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
      #####################################################################
      - name: ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        if: always()
        run: |
          echo "# ğŸ¤– è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ å®Ÿè¡Œãƒ¬ãƒãƒ¼ãƒˆ" > auto-fix-report.md
          echo "" >> auto-fix-report.md
          echo "## å®Ÿè¡Œæƒ…å ±" >> auto-fix-report.md
          echo "" >> auto-fix-report.md
          echo "| é …ç›® | å€¤ |" >> auto-fix-report.md
          echo "|------|-----|" >> auto-fix-report.md
          echo "| **å®Ÿè¡Œæ—¥æ™‚** | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> auto-fix-report.md
          echo "| **Run ID** | ${{ github.run_id }} |" >> auto-fix-report.md
          echo "| **ã‚µã‚¤ã‚¯ãƒ«æ•°** | ${{ steps.auto-fix-loop.outputs.attempts }}/$MAX_LOOPS |" >> auto-fix-report.md
          echo "| **æœ€çµ‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹** | ${{ steps.auto-fix-loop.outputs.final_status }} |" >> auto-fix-report.md
          echo "| **ãƒ˜ãƒ«ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹** | ${{ steps.health-check.outputs.status }} |" >> auto-fix-report.md
          echo "| **æ¤œå‡ºã‚¨ãƒ©ãƒ¼æ•°** | ${{ steps.auto-fix-loop.outputs.errors_detected }} |" >> auto-fix-report.md
          echo "| **ä¿®å¾©è©¦è¡Œæ•°** | ${{ steps.auto-fix-loop.outputs.fixes_attempted }} |" >> auto-fix-report.md
          echo "" >> auto-fix-report.md

          echo "## ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯çµæœ" >> auto-fix-report.md
          echo "" >> auto-fix-report.md
          echo '```json' >> auto-fix-report.md
          cat health-check-result.json 2>/dev/null || echo "{}" >> auto-fix-report.md
          echo '```' >> auto-fix-report.md
          echo "" >> auto-fix-report.md

          echo "## ãƒ†ã‚¹ãƒˆå‡ºåŠ›ï¼ˆæœ€æ–°ï¼‰" >> auto-fix-report.md
          echo "" >> auto-fix-report.md
          echo '```' >> auto-fix-report.md
          tail -n 100 test-output.log 2>/dev/null || echo "ãƒ†ã‚¹ãƒˆå‡ºåŠ›ãªã—" >> auto-fix-report.md
          echo '```' >> auto-fix-report.md

          cat auto-fix-report.md

      #####################################################################
      # Artifactä¿å­˜
      #####################################################################
      - name: Artifactä¿å­˜
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: auto-fix-report-${{ github.run_id }}
          path: |
            auto-fix-report.md
            health-check-result.json
            test-output.log
            backend/logs/*.log
          retention-days: 30

      - name: state-v2.jsonæ›´æ–°
        if: always()
        run: |
          # ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
          NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          STATUS="${{ steps.auto-fix-loop.outputs.final_status }}"
          ATTEMPTS="${{ steps.auto-fix-loop.outputs.attempts }}"
          ERRORS_DETECTED="${{ steps.auto-fix-loop.outputs.errors_detected }}"
          FIXES_ATTEMPTED="${{ steps.auto-fix-loop.outputs.fixes_attempted }}"

          if [ ! -f "$STATE_FILE" ]; then
            echo "âš ï¸ state-v2.json ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 0
          fi

          # çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
          TOTAL_RUNS=$(jq -r '.stats.total_runs' $STATE_FILE)
          SUCCESSFUL_RUNS=$(jq -r '.stats.successful_runs' $STATE_FILE)
          FAILED_RUNS=$(jq -r '.stats.failed_runs' $STATE_FILE)
          PREV_ERRORS=$(jq -r '.stats.errors_detected // 0' $STATE_FILE)
          PREV_FIXES=$(jq -r '.stats.fixes_attempted // 0' $STATE_FILE)

          TOTAL_RUNS=$((TOTAL_RUNS + 1))

          if [ "$STATUS" = "success" ]; then
            SUCCESSFUL_RUNS=$((SUCCESSFUL_RUNS + 1))
          else
            FAILED_RUNS=$((FAILED_RUNS + 1))
          fi

          NEW_ERRORS=$((PREV_ERRORS + ${ERRORS_DETECTED:-0}))
          NEW_FIXES=$((PREV_FIXES + ${FIXES_ATTEMPTED:-0}))

          # state-v2.jsonã‚’æ›´æ–°
          jq --arg timestamp "$NOW" \
             --arg status "$STATUS" \
             --argjson attempts "${ATTEMPTS:-0}" \
             --arg run_id "${{ github.run_id }}" \
             --argjson total_runs "$TOTAL_RUNS" \
             --argjson successful_runs "$SUCCESSFUL_RUNS" \
             --argjson failed_runs "$FAILED_RUNS" \
             --argjson errors_detected "$NEW_ERRORS" \
             --argjson fixes_attempted "$NEW_FIXES" \
             '.last_run.timestamp = $timestamp |
              .last_run.status = $status |
              .last_run.attempts = $attempts |
              .last_run.run_id = $run_id |
              .stats.total_runs = $total_runs |
              .stats.successful_runs = $successful_runs |
              .stats.failed_runs = $failed_runs |
              .stats.errors_detected = $errors_detected |
              .stats.fixes_attempted = $fixes_attempted' \
             $STATE_FILE > $STATE_FILE.tmp
          mv $STATE_FILE.tmp $STATE_FILE

          echo "âœ… state-v2.json ã‚’æ›´æ–°ã—ã¾ã—ãŸ"

      - name: ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆï¼ˆå¤‰æ›´ãŒã‚ã‚‹å ´åˆï¼‰
        if: always()
        env:
          HUSKY: '0'
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # å¤‰æ›´ãŒã‚ã‚‹ã‹ç¢ºèª
          if git diff --cached --quiet && git diff --quiet; then
            echo "â­ï¸  å¤‰æ›´ãŒãªã„ãŸã‚ã€PRã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
            exit 0
          fi

          echo "ğŸ”€ PRãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆä¸­..."

          BRANCH_NAME="auto-fix/continuous-${{ github.run_id }}"
          SUCCESS="${{ steps.auto-fix-loop.outputs.success }}"
          ATTEMPTS="${{ steps.auto-fix-loop.outputs.attempts }}"
          HEALTH="${{ steps.health-check.outputs.status }}"
          ERRORS="${{ steps.auto-fix-loop.outputs.errors_detected }}"
          FIXES="${{ steps.auto-fix-loop.outputs.fixes_attempted }}"

          # ã™ã¹ã¦ã®å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
          echo "ğŸ“‹ å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ..."
          git add -A
          git commit --no-verify -m "fix(auto): è‡ªå‹•ã‚¨ãƒ©ãƒ¼ä¿®å¾©ï¼ˆ5åˆ†é–“éš”ï¼‰

- ã‚µã‚¤ã‚¯ãƒ«æ•°: ${ATTEMPTS:-1}å›
- æ¤œå‡ºã‚¨ãƒ©ãƒ¼: ${ERRORS:-0}ä»¶
- ä¿®å¾©è©¦è¡Œ: ${FIXES:-0}ä»¶
- Run ID: ${{ github.run_id }}
- çµæœ: $([ \"$SUCCESS\" = \"true\" ] && echo 'âœ… æˆåŠŸ' || echo 'âŒ å¤±æ•—')
- ãƒ˜ãƒ«ã‚¹: ${HEALTH}" || {
            echo "âš ï¸ ã‚³ãƒŸãƒƒãƒˆã™ã‚‹å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“"
            exit 0
          }

          # ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆã—ã¦ãƒ—ãƒƒã‚·ãƒ¥
          echo "ğŸš€ ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒ—ãƒƒã‚·ãƒ¥ä¸­..."
          git checkout -b "$BRANCH_NAME"
          git push --no-verify -u origin "$BRANCH_NAME" || {
            echo "âš ï¸ ãƒ—ãƒƒã‚·ãƒ¥ã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 0
          }

          # PRã®çŠ¶æ…‹ã«å¿œã˜ã¦ãƒ©ãƒ™ãƒ«ã‚’è¨­å®š
          if [ "$SUCCESS" = "true" ]; then
            LABEL="auto-fix,ready-for-review"
          else
            LABEL="auto-fix,needs-review"
          fi

          # PRã‚’ä½œæˆ
          echo "ğŸ“ PRã‚’ä½œæˆä¸­..."
          gh pr create \
            --title "ğŸ¤– è‡ªå‹•ã‚¨ãƒ©ãƒ¼ä¿®å¾©ï¼ˆ5åˆ†é–“éš”ï¼‰- Run #${{ github.run_id }}" \
            --body "## ğŸ¤– è‡ªå‹•ã‚¨ãƒ©ãƒ¼ä¿®å¾©ãƒ¬ãƒãƒ¼ãƒˆï¼ˆ5åˆ†é–“éš”å®Ÿè¡Œï¼‰

ã“ã®PRã¯è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚Šç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚

### ğŸ“Š ä¿®å¾©çµ±è¨ˆ
| é …ç›® | å€¤ |
|------|-----|
| **ã‚µã‚¤ã‚¯ãƒ«æ•°** | ${ATTEMPTS:-1}å› |
| **æ¤œå‡ºã‚¨ãƒ©ãƒ¼** | ${ERRORS:-0}ä»¶ |
| **ä¿®å¾©è©¦è¡Œ** | ${FIXES:-0}ä»¶ |
| **çµæœ** | $([ \"$SUCCESS\" = \"true\" ] && echo 'âœ… æˆåŠŸ' || echo 'âŒ å¤±æ•—') |
| **ãƒ˜ãƒ«ã‚¹** | ${HEALTH} |

### å¤‰æ›´å†…å®¹
- è‡ªå‹•ä¿®å¾©ã«ã‚ˆã‚‹å¤‰æ›´
- state-v2.jsonæ›´æ–°

---
ğŸ“‹ **ãƒ«ãƒ¼ãƒ«éµå®ˆ**: CLAUDE.md ã«åŸºã¥ã„ã¦ä¿®å¾©
ğŸ“Š **è©³ç´°**: [Workflowå®Ÿè¡Œå±¥æ­´](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" \
            --label "$LABEL" \
            --base main \
            --head "$BRANCH_NAME" || {
            echo "âš ï¸ PRä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ—¢å­˜ã®PRãŒã‚ã‚‹å¯èƒ½æ€§ï¼‰"
          }

          echo "âœ… PRä½œæˆå‡¦ç†å®Œäº†"

      - name: Issueä½œæˆï¼ˆå¤±æ•—æ™‚ï¼‰
        if: failure() && (github.event.inputs.create_issue == 'yes' || github.event_name == 'schedule')
        uses: actions/github-script@v7
        with:
          script: |
            const body = '## ğŸš¨ è‡ªå‹•ã‚¨ãƒ©ãƒ¼ä¿®å¾©ãŒå¤±æ•—ã—ã¾ã—ãŸ\n\n' +
              '### å®Ÿè¡Œæƒ…å ±\n' +
              `- Run ID: ${context.runId}\n` +
              `- Timestamp: ${new Date().toISOString()}\n` +
              `- ã‚µã‚¤ã‚¯ãƒ«æ•°: ${{ steps.auto-fix-loop.outputs.attempts }}å›\n` +
              `- æ¤œå‡ºã‚¨ãƒ©ãƒ¼: ${{ steps.auto-fix-loop.outputs.errors_detected }}ä»¶\n` +
              `- ä¿®å¾©è©¦è¡Œ: ${{ steps.auto-fix-loop.outputs.fixes_attempted }}ä»¶\n` +
              `- ãƒ˜ãƒ«ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${{ steps.health-check.outputs.status }}\n\n` +
              '### æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³\n' +
              '**äººé–“ã«ã‚ˆã‚‹å¯¾å¿œãŒå¿…è¦ã§ã™**\n\n' +
              '1. ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„\n' +
              '2. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯çµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„\n' +
              '3. æ ¹æœ¬åŸå› ã‚’ç‰¹å®šã—ã¦ãã ã•ã„\n' +
              '4. æ‰‹å‹•ã§ä¿®æ­£ã—ã¦ãã ã•ã„\n\n' +
              '### å‚è€ƒãƒªãƒ³ã‚¯\n' +
              `- [Workflowå®Ÿè¡Œå±¥æ­´](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n` +
              `- [Artifactãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}#artifacts)\n\n` +
              'â° **æ¬¡å›å®Ÿè¡Œ**: 5åˆ†å¾Œã«è‡ªå‹•å†å®Ÿè¡Œäºˆå®š\n\n' +
              'è©³ç´°ã¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œãƒ­ã‚°ã¨Artifactã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ è‡ªå‹•ã‚¨ãƒ©ãƒ¼ä¿®å¾©å¤±æ•—ï¼ˆ5åˆ†é–“éš”å®Ÿè¡Œï¼‰',
              body: body,
              labels: ['auto-fix-failure', 'needs-review']
            });

      - name: å®Ÿè¡Œã‚µãƒãƒªãƒ¼
        if: always()
        run: |
          SUCCESS="${{ steps.auto-fix-loop.outputs.success }}"
          ATTEMPTS="${{ steps.auto-fix-loop.outputs.attempts }}"
          HEALTH="${{ steps.health-check.outputs.status }}"
          ERRORS="${{ steps.auto-fix-loop.outputs.errors_detected }}"
          FIXES="${{ steps.auto-fix-loop.outputs.fixes_attempted }}"

          echo "## ğŸ¤– è‡ªå‹•ã‚¨ãƒ©ãƒ¼ä¿®å¾©å®Ÿè¡Œçµæœï¼ˆ5åˆ†é–“éš”ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$SUCCESS" = "true" ]; then
            echo "### âœ… ä¿®å¾©æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| é …ç›® | å€¤ |" >> $GITHUB_STEP_SUMMARY
            echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
            echo "| **ã‚µã‚¤ã‚¯ãƒ«æ•°** | $ATTEMPTS å› |" >> $GITHUB_STEP_SUMMARY
            echo "| **çµæœ** | ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸ |" >> $GITHUB_STEP_SUMMARY
            echo "| **ãƒ˜ãƒ«ã‚¹** | $HEALTH |" >> $GITHUB_STEP_SUMMARY
            echo "| **æ¤œå‡ºã‚¨ãƒ©ãƒ¼** | $ERRORS ä»¶ |" >> $GITHUB_STEP_SUMMARY
            echo "| **ä¿®å¾©è©¦è¡Œ** | $FIXES ä»¶ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ ä¿®å¾©å¤±æ•—ï¼ˆæœ€å¤§ã‚µã‚¤ã‚¯ãƒ«æ•°ã«åˆ°é”ï¼‰" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| é …ç›® | å€¤ |" >> $GITHUB_STEP_SUMMARY
            echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
            echo "| **ã‚µã‚¤ã‚¯ãƒ«æ•°** | $ATTEMPTS å›ï¼ˆæœ€å¤§ï¼‰|" >> $GITHUB_STEP_SUMMARY
            echo "| **ãƒ˜ãƒ«ã‚¹** | $HEALTH |" >> $GITHUB_STEP_SUMMARY
            echo "| **æ¤œå‡ºã‚¨ãƒ©ãƒ¼** | $ERRORS ä»¶ |" >> $GITHUB_STEP_SUMMARY
            echo "| **ä¿®å¾©è©¦è¡Œ** | $FIXES ä»¶ |" >> $GITHUB_STEP_SUMMARY
            echo "| **æ¬¡å›** | 5åˆ†å¾Œã«è‡ªå‹•å†å®Ÿè¡Œäºˆå®š |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“‹ **ãƒ«ãƒ¼ãƒ«éµå®ˆ**: CLAUDE.md ã«åŸºã¥ã„ã¦ä¿®å¾©" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“– **ä»•æ§˜ä¿è­·**: README.md ã¯å¤‰æ›´ã•ã‚Œã¦ã„ã¾ã›ã‚“" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ’¾ **çŠ¶æ…‹ç®¡ç†**: state-v2.json" >> $GITHUB_STEP_SUMMARY
          echo "â° **å®Ÿè¡Œé–“éš”**: 5åˆ†" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”„ **ãƒ«ãƒ¼ãƒ—å›æ•°**: $MAX_LOOPS å›" >> $GITHUB_STEP_SUMMARY
          echo "â±ï¸ **å¾…æ©Ÿæ™‚é–“**: $LOOP_INTERVAL_SECONDS ç§’ï¼ˆãƒ«ãƒ¼ãƒ—é–“ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ¥ **ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯**: Pythonãƒ™ãƒ¼ã‚¹" >> $GITHUB_STEP_SUMMARY

      - name: ç¾åœ¨ã®çŠ¶æ…‹ã‚’è¡¨ç¤º
        if: always()
        run: |
          if [ -f "$STATE_FILE" ]; then
            echo "ğŸ“Š ç¾åœ¨ã®state-v2.json:"
            cat $STATE_FILE | jq .
          else
            echo "âš ï¸ state-v2.json ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi
