#####################################################################
# ğŸ¤– è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ ï¼ˆçµ±åˆé‹ç”¨è¨­è¨ˆãƒ»æœ€çµ‚ç‰ˆæº–æ‹ ï¼‰
#
# ã€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã€‘
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚ GitHub Actionsï¼ˆåˆ¶å¾¡ãƒ¬ã‚¤ãƒ¤ï¼‰        â”‚
#   â”‚ ãƒ»schedule / workflow_dispatch      â”‚
#   â”‚ ãƒ»Run å˜ä½ã§æœ€å¤§15å›ãƒ«ãƒ¼ãƒ—          â”‚
#   â”‚ ãƒ»state.json ã«ã‚ˆã‚‹ Run é–“çŠ¶æ…‹ç®¡ç†  â”‚
#   â”‚ ãƒ»å†å®Ÿè¡Œ or åœæ­¢ã®åˆ¤æ–­              â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#                â”‚ å‘¼ã³å‡ºã—
#                â–¼
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚ ClaudeCode / auto_fix_daemon.py    â”‚
#   â”‚ï¼ˆä¿®å¾©ãƒ¬ã‚¤ãƒ¤ï¼‰                       â”‚
#   â”‚ ãƒ»ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯                    â”‚
#   â”‚ ãƒ»ãƒ­ã‚°ã‚¹ã‚­ãƒ£ãƒ³                      â”‚
#   â”‚ ãƒ»ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ç…§åˆ                â”‚
#   â”‚ ãƒ»è‡ªå‹•ä¿®å¾©ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ            â”‚
#   â”‚ ãƒ»ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³åˆ¶å¾¡ï¼ˆ300ç§’ï¼‰         â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# ã€åŸå‰‡ã€‘
#   åˆ¶å¾¡ãƒ¬ã‚¤ãƒ¤: è€ƒãˆãªã„ãƒ»å¸¸é§ã—ãªã„ãƒ»å¿…ãšçµ‚ã‚ã‚‹
#   ä¿®å¾©ãƒ¬ã‚¤ãƒ¤: è€ƒãˆã‚‹ãƒ»ç›´ã™ãƒ»åˆ¤æ–­ã—ãªã„
#
# ã€ç–‘ä¼¼ç„¡é™ãƒ«ãƒ¼ãƒ—ã€‘
#   Run #1ï¼ˆæœ€å¤§15å›ä¿®å¾©ï¼‰â†’ çµ‚äº†
#      â†“ï¼ˆ5åˆ†å¾Œï¼‰
#   Run #2ï¼ˆæœ€å¤§15å›ä¿®å¾©ï¼‰â†’ çµ‚äº†
#      â†“
#   ...
#   â€» ç„¡é™ã«è¦‹ãˆã‚‹ãŒRunã¯å¿…ãšçŸ­æ™‚é–“ã§çµ‚äº†ï¼ˆå¥å…¨ãªè¨­è¨ˆï¼‰
#
#####################################################################

name: ğŸ¤– è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ ï¼ˆITSM-Systemç‰ˆï¼‰

on:
  schedule:
    - cron: '*/5 * * * *'  # æ¯5åˆ†å®Ÿè¡Œï¼ˆUTCï¼‰
  workflow_dispatch:
    inputs:
      max_loops:
        description: 'æœ€å¤§ãƒ«ãƒ¼ãƒ—å›æ•°ï¼ˆ1 Run ã‚ãŸã‚Šï¼‰'
        default: '15'
        type: string
      create_issue:
        description: 'Issueä½œæˆï¼ˆå¤±æ•—æ™‚ï¼‰'
        default: 'yes'
        type: choice
        options:
          - 'yes'
          - 'no'
      force_run:
        description: 'ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ç„¡è¦–ã—ã¦å¼·åˆ¶å®Ÿè¡Œ'
        default: 'no'
        type: choice
        options:
          - 'no'
          - 'yes'

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  # çŠ¶æ…‹ç®¡ç†ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆRuné–“é€£æºã®è¦ï¼‰
  STATE_FILE: '.github/auto-repair/state.json'

  # ç’°å¢ƒè¨­å®š
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.12'
  NODE_ENV: test
  DATABASE_PATH: ./backend/test_itsm.db
  JWT_SECRET: ${{ secrets.JWT_SECRET_TEST }}
  JWT_EXPIRES_IN: '1h'
  REFRESH_TOKEN_EXPIRES_DAYS: '7'
  ENABLE_HTTPS: 'false'
  SCHEDULER_ENABLED: 'false'
  PORT: '5100'

  # ãƒ«ãƒ¼ãƒ—åˆ¶å¾¡ï¼ˆä»•æ§˜æº–æ‹ ï¼‰
  MAX_LOOPS: ${{ github.event.inputs.max_loops || '15' }}
  LOOP_INTERVAL_SECONDS: '2'
  COOLDOWN_PERIOD: '300'

jobs:
  #####################################################################
  # Job 1: è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ãƒ«ãƒ¼ãƒ—
  # å½¹å‰²: åˆ¶å¾¡ãƒ¬ã‚¤ãƒ¤ï¼ˆåˆ¤æ–­ã®ã¿ã€å¸¸é§ã—ãªã„ã€å¿…ãšçµ‚ã‚ã‚‹ï¼‰
  #####################################################################
  auto-fix:
    name: ğŸ”„ è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ãƒ«ãƒ¼ãƒ—
    runs-on: ubuntu-latest
    timeout-minutes: 10

    outputs:
      success: ${{ steps.auto-fix-loop.outputs.success }}
      attempts: ${{ steps.auto-fix-loop.outputs.attempts }}
      final_status: ${{ steps.auto-fix-loop.outputs.final_status }}
      health_status: ${{ steps.health-check.outputs.status }}
      errors_detected: ${{ steps.auto-fix-loop.outputs.errors_detected }}
      fixes_attempted: ${{ steps.auto-fix-loop.outputs.fixes_attempted }}

    steps:
      #################################################################
      # ã‚¹ãƒ†ãƒƒãƒ—1: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      #################################################################
      - name: ğŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      #################################################################
      # ã‚¹ãƒ†ãƒƒãƒ—2: ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ç¢ºèªï¼ˆRuné–“é€£æºï¼‰
      #################################################################
      - name: â±ï¸ ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ç¢ºèª
        id: cooldown-check
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â±ï¸ ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ç¢ºèª"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          FORCE_RUN="${{ github.event.inputs.force_run }}"

          if [ "$FORCE_RUN" = "yes" ]; then
            echo "âš¡ å¼·åˆ¶å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰: ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—"
            echo "should_run=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          if [ -f "$STATE_FILE" ]; then
            COOLDOWN_UNTIL=$(jq -r '.cooldown_until // ""' $STATE_FILE)

            if [ -n "$COOLDOWN_UNTIL" ] && [ "$COOLDOWN_UNTIL" != "null" ]; then
              COOLDOWN_TS=$(date -d "$COOLDOWN_UNTIL" +%s 2>/dev/null || echo "0")
              NOW_TS=$(date +%s)

              if [ "$COOLDOWN_TS" -gt "$NOW_TS" ]; then
                REMAINING=$((COOLDOWN_TS - NOW_TS))
                echo "â³ ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ä¸­: ã‚ã¨${REMAINING}ç§’"
                echo "should_run=false" >> $GITHUB_OUTPUT
                exit 0
              fi
            fi
          fi

          echo "âœ… ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³å®Œäº†ã€å®Ÿè¡Œå¯èƒ½"
          echo "should_run=true" >> $GITHUB_OUTPUT

      #################################################################
      # ã‚¹ãƒ†ãƒƒãƒ—3: ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      #################################################################
      - name: ğŸ“¦ Node.jsç’°å¢ƒæ§‹ç¯‰
        if: steps.cooldown-check.outputs.should_run == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ Pythonç’°å¢ƒæ§‹ç¯‰
        if: steps.cooldown-check.outputs.should_run == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Pythonä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        if: steps.cooldown-check.outputs.should_run == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install requests psutil

      - name: ğŸ“¦ Node.jsä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        if: steps.cooldown-check.outputs.should_run == 'true'
        run: npm ci

      - name: ğŸ”§ Gitè¨­å®š
        if: steps.cooldown-check.outputs.should_run == 'true'
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: ğŸ—ƒï¸ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
        if: steps.cooldown-check.outputs.should_run == 'true'
        run: npm run migrate:latest

      - name: ğŸ“ ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
        if: steps.cooldown-check.outputs.should_run == 'true'
        run: |
          mkdir -p backend/logs
          touch backend/logs/app.log
          touch backend/logs/auto_fix.log
          touch backend/logs/alerts.log

      - name: ğŸ“ state.jsonåˆæœŸåŒ–
        if: steps.cooldown-check.outputs.should_run == 'true'
        run: |
          if [ ! -f "$STATE_FILE" ]; then
            echo "ğŸ“ state.json ãŒå­˜åœ¨ã—ãªã„ãŸã‚åˆæœŸåŒ–"
            mkdir -p .github/auto-repair
            cat > $STATE_FILE << 'EOF'
          {
            "schema_version": "3.0",
            "description": "çµ±åˆé‹ç”¨è¨­è¨ˆãƒ»æœ€çµ‚ç‰ˆã«æº–æ‹ ã—ãŸçŠ¶æ…‹ç®¡ç†ãƒ•ã‚¡ã‚¤ãƒ«",
            "retry_required": false,
            "run_count": 0,
            "last_error_id": null,
            "last_error_summary": null,
            "last_attempt_at": null,
            "cooldown_until": null,
            "stats": {
              "total_runs": 0,
              "successful_runs": 0,
              "failed_runs": 0,
              "errors_detected": 0,
              "fixes_attempted": 0,
              "fixes_succeeded": 0
            },
            "last_run": {
              "run_id": null,
              "status": "none",
              "attempts": 0,
              "health_status": null
            },
            "meta": {
              "workflow": "auto-error-fix-continuous",
              "branch": "main",
              "max_loops_per_run": 15,
              "cooldown_period_seconds": 300,
              "loop_interval_seconds": 2
            }
          }
          EOF
            echo "âœ… state.json åˆæœŸåŒ–å®Œäº†"
          fi

      #################################################################
      # ã‚¹ãƒ†ãƒƒãƒ—4: ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆä¿®å¾©ãƒ¬ã‚¤ãƒ¤ã‚’å‘¼ã³å‡ºã—ï¼‰
      #################################################################
      - name: ğŸ¥ ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
        if: steps.cooldown-check.outputs.should_run == 'true'
        id: health-check
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ¥ ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          cd backend/scripts

          # ãƒ˜ãƒ«ã‚¹ãƒ¢ãƒ‹ã‚¿ãƒ¼å®Ÿè¡Œï¼ˆä¿®å¾©ãƒ¬ã‚¤ãƒ¤ï¼‰
          python3 -c "
import sys
import json
sys.path.insert(0, '.')
try:
    from health_monitor import HealthMonitor
    monitor = HealthMonitor()
    result = monitor.run_all_checks()
    print(json.dumps(result, indent=2, ensure_ascii=False))
except Exception as e:
    print(json.dumps({'overall_status': 'unknown', 'error': str(e)}))
" > ../../health-check-result.json 2>&1 || echo '{"overall_status":"unknown"}' > ../../health-check-result.json

          cd ../..

          cat health-check-result.json | jq . || cat health-check-result.json

          HEALTH_STATUS=$(jq -r '.overall_status // "unknown"' health-check-result.json)
          echo "status=$HEALTH_STATUS" >> $GITHUB_OUTPUT
          echo "âœ… ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Œäº†: $HEALTH_STATUS"

      #################################################################
      # ã‚¹ãƒ†ãƒƒãƒ—5: è‡ªå‹•ä¿®å¾©ãƒ«ãƒ¼ãƒ—ï¼ˆæœ€å¤§15å›ï¼‰
      #################################################################
      - name: ğŸ”„ è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ãƒ«ãƒ¼ãƒ—
        if: steps.cooldown-check.outputs.should_run == 'true'
        id: auto-fix-loop
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”„ è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ãƒ«ãƒ¼ãƒ—é–‹å§‹"
          echo "   ãƒ«ãƒ¼ãƒ—å›æ•°: $MAX_LOOPS å›"
          echo "   å¾…æ©Ÿæ™‚é–“: $LOOP_INTERVAL_SECONDS ç§’"
          echo "   ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³: $COOLDOWN_PERIOD ç§’"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          ATTEMPT=0
          SUCCESS=false
          FINAL_STATUS="failed"
          TOTAL_ERRORS=0
          TOTAL_FIXES=0
          LAST_ERROR_ID=""
          LAST_ERROR_SUMMARY=""

          while [ $ATTEMPT -lt $MAX_LOOPS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ” ã‚µã‚¤ã‚¯ãƒ« $ATTEMPT / $MAX_LOOPS"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # [1/4] ãƒ­ã‚°ã‚¹ã‚­ãƒ£ãƒ³ + è‡ªå‹•ä¿®å¾©ï¼ˆä¿®å¾©ãƒ¬ã‚¤ãƒ¤ï¼‰
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            echo ""
            echo "ğŸ“‹ [1/4] ãƒ­ã‚°ã‚¹ã‚­ãƒ£ãƒ³ + è‡ªå‹•ä¿®å¾©..."

            cd backend/scripts
            SCAN_RESULT=$(python3 -c "
import sys
import json
sys.path.insert(0, '.')
from auto_fix_daemon import AutoFixDaemon

daemon = AutoFixDaemon()
log_paths = [
    '../logs/app.log',
    '../logs/auto_fix.log',
    '../logs/alerts.log'
]

errors = daemon.scan_logs(log_paths)
fixes = 0
error_id = ''
error_summary = ''

for error in errors:
    if daemon.auto_fix_error(error):
        fixes += 1
    if not error_id:
        error_id = error.get('id', '')
        error_summary = error.get('name', '')

result = {
    'errors_detected': len(errors),
    'fixes_attempted': fixes,
    'last_error_id': error_id,
    'last_error_summary': error_summary
}
print(json.dumps(result))
" 2>&1 || echo '{"errors_detected":0,"fixes_attempted":0}')
            cd ../..

            # çµæœè§£æ
            ERRORS_IN_CYCLE=$(echo "$SCAN_RESULT" | grep -o '"errors_detected":[0-9]*' | grep -o '[0-9]*' || echo "0")
            FIXES_IN_CYCLE=$(echo "$SCAN_RESULT" | grep -o '"fixes_attempted":[0-9]*' | grep -o '[0-9]*' || echo "0")
            TOTAL_ERRORS=$((TOTAL_ERRORS + ERRORS_IN_CYCLE))
            TOTAL_FIXES=$((TOTAL_FIXES + FIXES_IN_CYCLE))

            # ã‚¨ãƒ©ãƒ¼IDå–å¾—
            NEW_ERROR_ID=$(echo "$SCAN_RESULT" | jq -r '.last_error_id // ""' 2>/dev/null || echo "")
            NEW_ERROR_SUMMARY=$(echo "$SCAN_RESULT" | jq -r '.last_error_summary // ""' 2>/dev/null || echo "")
            if [ -n "$NEW_ERROR_ID" ]; then
              LAST_ERROR_ID="$NEW_ERROR_ID"
              LAST_ERROR_SUMMARY="$NEW_ERROR_SUMMARY"
            fi

            if [ "$ERRORS_IN_CYCLE" -gt 0 ]; then
              echo "  âš ï¸ ${ERRORS_IN_CYCLE}ä»¶ã®ã‚¨ãƒ©ãƒ¼æ¤œå‡ºã€${FIXES_IN_CYCLE}ä»¶ã®ä¿®å¾©è©¦è¡Œ"
            else
              echo "  âœ“ ã‚¨ãƒ©ãƒ¼ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
            fi

            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # [2/4] ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            echo ""
            echo "ğŸ“Š [2/4] ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."

            if npm test 2>&1 | tee test-output.log; then
              echo "âœ… ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸï¼"
              SUCCESS=true
              FINAL_STATUS="success"
              break
            else
              echo "âŒ ãƒ†ã‚¹ãƒˆãŒå¤±æ•—"
              grep -A 3 "FAIL\|âœ•" test-output.log | head -20 || true
            fi

            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # [3/4] ã‚³ãƒ¼ãƒ‰è‡ªå‹•ä¿®å¾©
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            echo ""
            echo "ğŸ”§ [3/4] ã‚³ãƒ¼ãƒ‰è‡ªå‹•ä¿®å¾©..."

            npm run lint:fix 2>&1 || true
            npm run format 2>&1 || true

            git add -A
            if ! git diff --cached --quiet; then
              echo "  âœ“ å¤‰æ›´ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°"
              TOTAL_FIXES=$((TOTAL_FIXES + 1))
            fi

            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # [4/4] å¾…æ©Ÿ
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if [ $ATTEMPT -lt $MAX_LOOPS ]; then
              echo ""
              echo "â³ [4/4] æ¬¡ã®ã‚µã‚¤ã‚¯ãƒ«ã¾ã§${LOOP_INTERVAL_SECONDS}ç§’å¾…æ©Ÿ..."
              sleep $LOOP_INTERVAL_SECONDS
            fi
          done

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # çµæœå‡ºåŠ›
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š ãƒ«ãƒ¼ãƒ—å®Œäº†çµ±è¨ˆ:"
          echo "   ç·ã‚µã‚¤ã‚¯ãƒ«æ•°: $ATTEMPT"
          echo "   æ¤œå‡ºã‚¨ãƒ©ãƒ¼æ•°: $TOTAL_ERRORS"
          echo "   ä¿®å¾©è©¦è¡Œæ•°: $TOTAL_FIXES"
          echo "   æœ€çµ‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $FINAL_STATUS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          echo "success=$SUCCESS" >> $GITHUB_OUTPUT
          echo "attempts=$ATTEMPT" >> $GITHUB_OUTPUT
          echo "final_status=$FINAL_STATUS" >> $GITHUB_OUTPUT
          echo "errors_detected=$TOTAL_ERRORS" >> $GITHUB_OUTPUT
          echo "fixes_attempted=$TOTAL_FIXES" >> $GITHUB_OUTPUT
          echo "last_error_id=$LAST_ERROR_ID" >> $GITHUB_OUTPUT
          echo "last_error_summary=$LAST_ERROR_SUMMARY" >> $GITHUB_OUTPUT

      #################################################################
      # ã‚¹ãƒ†ãƒƒãƒ—6: state.jsonæ›´æ–°ï¼ˆRuné–“é€£æºï¼‰
      #################################################################
      - name: ğŸ“ state.jsonæ›´æ–°
        if: always() && steps.cooldown-check.outputs.should_run == 'true'
        run: |
          NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          STATUS="${{ steps.auto-fix-loop.outputs.final_status }}"
          ATTEMPTS="${{ steps.auto-fix-loop.outputs.attempts }}"
          ERRORS="${{ steps.auto-fix-loop.outputs.errors_detected }}"
          FIXES="${{ steps.auto-fix-loop.outputs.fixes_attempted }}"
          ERROR_ID="${{ steps.auto-fix-loop.outputs.last_error_id }}"
          ERROR_SUMMARY="${{ steps.auto-fix-loop.outputs.last_error_summary }}"
          HEALTH="${{ steps.health-check.outputs.status }}"

          if [ ! -f "$STATE_FILE" ]; then
            echo "âš ï¸ state.json ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 0
          fi

          # çµ±è¨ˆæƒ…å ±æ›´æ–°
          TOTAL_RUNS=$(jq -r '.stats.total_runs // 0' $STATE_FILE)
          SUCCESSFUL_RUNS=$(jq -r '.stats.successful_runs // 0' $STATE_FILE)
          FAILED_RUNS=$(jq -r '.stats.failed_runs // 0' $STATE_FILE)
          PREV_ERRORS=$(jq -r '.stats.errors_detected // 0' $STATE_FILE)
          PREV_FIXES=$(jq -r '.stats.fixes_attempted // 0' $STATE_FILE)
          RUN_COUNT=$(jq -r '.run_count // 0' $STATE_FILE)

          TOTAL_RUNS=$((TOTAL_RUNS + 1))
          RUN_COUNT=$((RUN_COUNT + 1))

          if [ "$STATUS" = "success" ]; then
            SUCCESSFUL_RUNS=$((SUCCESSFUL_RUNS + 1))
            RETRY_REQUIRED="false"
            COOLDOWN_UNTIL="null"
          else
            FAILED_RUNS=$((FAILED_RUNS + 1))
            RETRY_REQUIRED="true"
            # å¤±æ•—æ™‚ã¯ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³è¨­å®šï¼ˆ5åˆ†å¾Œã«å†å®Ÿè¡Œå¯èƒ½ï¼‰
            COOLDOWN_UNTIL=$(date -u -d "+5 minutes" +"%Y-%m-%dT%H:%M:%SZ")
          fi

          NEW_ERRORS=$((PREV_ERRORS + ${ERRORS:-0}))
          NEW_FIXES=$((PREV_FIXES + ${FIXES:-0}))

          # state.jsonæ›´æ–°ï¼ˆä»•æ§˜æ›¸æº–æ‹ å½¢å¼ï¼‰
          jq --arg now "$NOW" \
             --arg status "$STATUS" \
             --argjson attempts "${ATTEMPTS:-0}" \
             --arg run_id "${{ github.run_id }}" \
             --argjson total_runs "$TOTAL_RUNS" \
             --argjson successful_runs "$SUCCESSFUL_RUNS" \
             --argjson failed_runs "$FAILED_RUNS" \
             --argjson errors "$NEW_ERRORS" \
             --argjson fixes "$NEW_FIXES" \
             --argjson run_count "$RUN_COUNT" \
             --argjson retry_required "$RETRY_REQUIRED" \
             --arg cooldown_until "$COOLDOWN_UNTIL" \
             --arg error_id "${ERROR_ID:-null}" \
             --arg error_summary "${ERROR_SUMMARY:-null}" \
             --arg health "$HEALTH" \
             '
             .last_attempt_at = $now |
             .retry_required = $retry_required |
             .run_count = $run_count |
             .last_error_id = (if $error_id == "" or $error_id == "null" then null else $error_id end) |
             .last_error_summary = (if $error_summary == "" or $error_summary == "null" then null else $error_summary end) |
             .cooldown_until = (if $cooldown_until == "null" then null else $cooldown_until end) |
             .stats.total_runs = $total_runs |
             .stats.successful_runs = $successful_runs |
             .stats.failed_runs = $failed_runs |
             .stats.errors_detected = $errors |
             .stats.fixes_attempted = $fixes |
             .last_run.run_id = $run_id |
             .last_run.status = $status |
             .last_run.attempts = $attempts |
             .last_run.health_status = $health
             ' $STATE_FILE > $STATE_FILE.tmp
          mv $STATE_FILE.tmp $STATE_FILE

          echo "âœ… state.json æ›´æ–°å®Œäº†"
          cat $STATE_FILE | jq .

      #################################################################
      # ã‚¹ãƒ†ãƒƒãƒ—7: ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
      #################################################################
      - name: ğŸ“Š ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        if: always() && steps.cooldown-check.outputs.should_run == 'true'
        run: |
          cat > auto-fix-report.md << EOF
          # ğŸ¤– è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ å®Ÿè¡Œãƒ¬ãƒãƒ¼ãƒˆ

          ## å®Ÿè¡Œæƒ…å ±

          | é …ç›® | å€¤ |
          |------|-----|
          | **å®Ÿè¡Œæ—¥æ™‚** | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |
          | **Run ID** | ${{ github.run_id }} |
          | **ã‚µã‚¤ã‚¯ãƒ«æ•°** | ${{ steps.auto-fix-loop.outputs.attempts }}/$MAX_LOOPS |
          | **æœ€çµ‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹** | ${{ steps.auto-fix-loop.outputs.final_status }} |
          | **ãƒ˜ãƒ«ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹** | ${{ steps.health-check.outputs.status }} |
          | **æ¤œå‡ºã‚¨ãƒ©ãƒ¼æ•°** | ${{ steps.auto-fix-loop.outputs.errors_detected }} |
          | **ä¿®å¾©è©¦è¡Œæ•°** | ${{ steps.auto-fix-loop.outputs.fixes_attempted }} |

          ## ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯çµæœ

          \`\`\`json
          $(cat health-check-result.json 2>/dev/null || echo "{}")
          \`\`\`

          ## ãƒ†ã‚¹ãƒˆå‡ºåŠ›ï¼ˆæœ€æ–°ï¼‰

          \`\`\`
          $(tail -n 100 test-output.log 2>/dev/null || echo "ãƒ†ã‚¹ãƒˆå‡ºåŠ›ãªã—")
          \`\`\`

          ---
          ğŸ“‹ **ãƒ«ãƒ¼ãƒ«éµå®ˆ**: CLAUDE.md ã«åŸºã¥ã„ã¦ä¿®å¾©
          ğŸ“– **ä»•æ§˜ä¿è­·**: README.md ã¯å¤‰æ›´ã•ã‚Œã¦ã„ã¾ã›ã‚“
          ğŸ’¾ **çŠ¶æ…‹ç®¡ç†**: state.json (ã‚¹ã‚­ãƒ¼ãƒv3.0)
          â° **å®Ÿè¡Œé–“éš”**: 5åˆ†
          ğŸ”„ **ãƒ«ãƒ¼ãƒ—å›æ•°**: $MAX_LOOPS å›
          EOF

      #################################################################
      # ã‚¹ãƒ†ãƒƒãƒ—8: Artifactä¿å­˜
      #################################################################
      - name: ğŸ“¦ Artifactä¿å­˜
        if: always() && steps.cooldown-check.outputs.should_run == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: auto-fix-report-${{ github.run_id }}
          path: |
            auto-fix-report.md
            health-check-result.json
            test-output.log
            backend/logs/*.log
          retention-days: 30

      #################################################################
      # ã‚¹ãƒ†ãƒƒãƒ—9: PRä½œæˆï¼ˆå¤‰æ›´ãŒã‚ã‚‹å ´åˆï¼‰
      #################################################################
      - name: ğŸ”€ PRä½œæˆ
        if: always() && steps.cooldown-check.outputs.should_run == 'true'
        env:
          HUSKY: '0'
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if git diff --cached --quiet && git diff --quiet; then
            echo "â­ï¸ å¤‰æ›´ãŒãªã„ãŸã‚PRã‚¹ã‚­ãƒƒãƒ—"
            exit 0
          fi

          BRANCH_NAME="auto-fix/continuous-${{ github.run_id }}"
          SUCCESS="${{ steps.auto-fix-loop.outputs.success }}"
          ATTEMPTS="${{ steps.auto-fix-loop.outputs.attempts }}"
          ERRORS="${{ steps.auto-fix-loop.outputs.errors_detected }}"
          FIXES="${{ steps.auto-fix-loop.outputs.fixes_attempted }}"

          git add -A
          git commit --no-verify -m "fix(auto): è‡ªå‹•ã‚¨ãƒ©ãƒ¼ä¿®å¾©

          - ã‚µã‚¤ã‚¯ãƒ«æ•°: ${ATTEMPTS:-1}å›
          - æ¤œå‡ºã‚¨ãƒ©ãƒ¼: ${ERRORS:-0}ä»¶
          - ä¿®å¾©è©¦è¡Œ: ${FIXES:-0}ä»¶
          - Run ID: ${{ github.run_id }}
          - çµæœ: $([ \"$SUCCESS\" = \"true\" ] && echo 'âœ… æˆåŠŸ' || echo 'âŒ å¤±æ•—')" || {
            echo "âš ï¸ ã‚³ãƒŸãƒƒãƒˆã™ã‚‹å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“"
            exit 0
          }

          git checkout -b "$BRANCH_NAME"
          git push --no-verify -u origin "$BRANCH_NAME" || {
            echo "âš ï¸ ãƒ—ãƒƒã‚·ãƒ¥å¤±æ•—"
            exit 0
          }

          LABEL=$([ "$SUCCESS" = "true" ] && echo "auto-fix,ready-for-review" || echo "auto-fix,needs-review")

          gh pr create \
            --title "ğŸ¤– è‡ªå‹•ã‚¨ãƒ©ãƒ¼ä¿®å¾© - Run #${{ github.run_id }}" \
            --body "## ğŸ¤– è‡ªå‹•ã‚¨ãƒ©ãƒ¼ä¿®å¾©ãƒ¬ãƒãƒ¼ãƒˆ

          ã“ã®PRã¯è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚Šç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚

          ### ğŸ“Š ä¿®å¾©çµ±è¨ˆ
          | é …ç›® | å€¤ |
          |------|-----|
          | **ã‚µã‚¤ã‚¯ãƒ«æ•°** | ${ATTEMPTS:-1}å› |
          | **æ¤œå‡ºã‚¨ãƒ©ãƒ¼** | ${ERRORS:-0}ä»¶ |
          | **ä¿®å¾©è©¦è¡Œ** | ${FIXES:-0}ä»¶ |
          | **çµæœ** | $([ \"$SUCCESS\" = \"true\" ] && echo 'âœ… æˆåŠŸ' || echo 'âŒ å¤±æ•—') |

          ---
          ğŸ“‹ **ãƒ«ãƒ¼ãƒ«éµå®ˆ**: CLAUDE.md ã«åŸºã¥ã„ã¦ä¿®å¾©
          ğŸ“Š **è©³ç´°**: [Workflowå®Ÿè¡Œå±¥æ­´](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" \
            --label "$LABEL" \
            --base main \
            --head "$BRANCH_NAME" || echo "âš ï¸ PRä½œæˆå¤±æ•—ï¼ˆæ—¢å­˜PRæœ‰ã®å¯èƒ½æ€§ï¼‰"

      #################################################################
      # ã‚¹ãƒ†ãƒƒãƒ—10: Issueä½œæˆï¼ˆå¤±æ•—æ™‚ï¼‰
      #################################################################
      - name: ğŸš¨ Issueä½œæˆ
        if: failure() && (github.event.inputs.create_issue == 'yes' || github.event_name == 'schedule') && steps.cooldown-check.outputs.should_run == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## ğŸš¨ è‡ªå‹•ã‚¨ãƒ©ãƒ¼ä¿®å¾©ãŒå¤±æ•—ã—ã¾ã—ãŸ

            ### å®Ÿè¡Œæƒ…å ±
            - Run ID: ${context.runId}
            - Timestamp: ${new Date().toISOString()}
            - ã‚µã‚¤ã‚¯ãƒ«æ•°: ${{ steps.auto-fix-loop.outputs.attempts }}å›
            - æ¤œå‡ºã‚¨ãƒ©ãƒ¼: ${{ steps.auto-fix-loop.outputs.errors_detected }}ä»¶
            - ä¿®å¾©è©¦è¡Œ: ${{ steps.auto-fix-loop.outputs.fixes_attempted }}ä»¶
            - ãƒ˜ãƒ«ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${{ steps.health-check.outputs.status }}

            ### æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
            **äººé–“ã«ã‚ˆã‚‹å¯¾å¿œãŒå¿…è¦ã§ã™**

            1. ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„
            2. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯çµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„
            3. æ ¹æœ¬åŸå› ã‚’ç‰¹å®šã—ã¦ãã ã•ã„
            4. æ‰‹å‹•ã§ä¿®æ­£ã—ã¦ãã ã•ã„

            ### å‚è€ƒãƒªãƒ³ã‚¯
            - [Workflowå®Ÿè¡Œå±¥æ­´](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            - [Artifactãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}#artifacts)

            â° **æ¬¡å›å®Ÿè¡Œ**: 5åˆ†å¾Œã«è‡ªå‹•å†å®Ÿè¡Œäºˆå®š`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ è‡ªå‹•ã‚¨ãƒ©ãƒ¼ä¿®å¾©å¤±æ•—',
              body: body,
              labels: ['auto-fix-failure', 'needs-review']
            });

      #################################################################
      # ã‚¹ãƒ†ãƒƒãƒ—11: å®Ÿè¡Œã‚µãƒãƒªãƒ¼
      #################################################################
      - name: ğŸ“Š å®Ÿè¡Œã‚µãƒãƒªãƒ¼
        if: always()
        run: |
          SHOULD_RUN="${{ steps.cooldown-check.outputs.should_run }}"
          SUCCESS="${{ steps.auto-fix-loop.outputs.success }}"
          ATTEMPTS="${{ steps.auto-fix-loop.outputs.attempts }}"
          HEALTH="${{ steps.health-check.outputs.status }}"
          ERRORS="${{ steps.auto-fix-loop.outputs.errors_detected }}"
          FIXES="${{ steps.auto-fix-loop.outputs.fixes_attempted }}"

          echo "## ğŸ¤– è‡ªå‹•ã‚¨ãƒ©ãƒ¼ä¿®å¾©å®Ÿè¡Œçµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$SHOULD_RUN" != "true" ]; then
            echo "### â³ ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ä¸­ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "æ¬¡å›å®Ÿè¡Œã¾ã§å¾…æ©Ÿä¸­ã§ã™ã€‚" >> $GITHUB_STEP_SUMMARY
          elif [ "$SUCCESS" = "true" ]; then
            echo "### âœ… ä¿®å¾©æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| é …ç›® | å€¤ |" >> $GITHUB_STEP_SUMMARY
            echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
            echo "| **ã‚µã‚¤ã‚¯ãƒ«æ•°** | $ATTEMPTS å› |" >> $GITHUB_STEP_SUMMARY
            echo "| **çµæœ** | ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸ |" >> $GITHUB_STEP_SUMMARY
            echo "| **ãƒ˜ãƒ«ã‚¹** | $HEALTH |" >> $GITHUB_STEP_SUMMARY
            echo "| **æ¤œå‡ºã‚¨ãƒ©ãƒ¼** | $ERRORS ä»¶ |" >> $GITHUB_STEP_SUMMARY
            echo "| **ä¿®å¾©è©¦è¡Œ** | $FIXES ä»¶ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ ä¿®å¾©å¤±æ•—ï¼ˆæœ€å¤§ã‚µã‚¤ã‚¯ãƒ«æ•°ã«åˆ°é”ï¼‰" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| é …ç›® | å€¤ |" >> $GITHUB_STEP_SUMMARY
            echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
            echo "| **ã‚µã‚¤ã‚¯ãƒ«æ•°** | $ATTEMPTS å›ï¼ˆæœ€å¤§ï¼‰|" >> $GITHUB_STEP_SUMMARY
            echo "| **ãƒ˜ãƒ«ã‚¹** | $HEALTH |" >> $GITHUB_STEP_SUMMARY
            echo "| **æ¤œå‡ºã‚¨ãƒ©ãƒ¼** | $ERRORS ä»¶ |" >> $GITHUB_STEP_SUMMARY
            echo "| **ä¿®å¾©è©¦è¡Œ** | $FIXES ä»¶ |" >> $GITHUB_STEP_SUMMARY
            echo "| **æ¬¡å›** | 5åˆ†å¾Œã«è‡ªå‹•å†å®Ÿè¡Œäºˆå®š |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“‹ **ãƒ«ãƒ¼ãƒ«éµå®ˆ**: CLAUDE.md ã«åŸºã¥ã„ã¦ä¿®å¾©" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“– **ä»•æ§˜ä¿è­·**: README.md ã¯å¤‰æ›´ã•ã‚Œã¦ã„ã¾ã›ã‚“" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ’¾ **çŠ¶æ…‹ç®¡ç†**: state.json (ã‚¹ã‚­ãƒ¼ãƒv3.0)" >> $GITHUB_STEP_SUMMARY
          echo "â° **å®Ÿè¡Œé–“éš”**: 5åˆ†" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”„ **ãƒ«ãƒ¼ãƒ—å›æ•°**: $MAX_LOOPS å›" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ“Š ç¾åœ¨ã®çŠ¶æ…‹ã‚’è¡¨ç¤º
        if: always()
        run: |
          if [ -f "$STATE_FILE" ]; then
            echo "ğŸ“Š ç¾åœ¨ã®state.json:"
            cat $STATE_FILE | jq .
          else
            echo "âš ï¸ state.json ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi
