name: Auto Error Detection & Fix Loop

on:
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:

  # 30åˆ†é–“éš”ã§è‡ªå‹•å®Ÿè¡Œï¼ˆç„¡é™ãƒ«ãƒ¼ãƒ—ï¼‰
  schedule:
    - cron: '*/30 * * * *'  # æ¯Ž30åˆ†å®Ÿè¡Œ

  # Issueãƒ©ãƒ™ãƒ« "auto-fix" ãŒä»˜ã„ãŸã¨ãã«å®Ÿè¡Œ
  issues:
    types: [labeled]

env:
  MAX_ITERATIONS: 15
  NODE_VERSION: '20'

jobs:
  # ============================================================
  # Job 1: Error Detection & Auto Fix Loop
  # ============================================================
  auto-fix-loop:
    name: Error Detection & Auto Fix (Max 15 iterations)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'auto-fix'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Auto Fix Loop (Max 15 iterations)
        id: auto-fix
        run: |
          echo "Starting auto-fix loop (max $MAX_ITERATIONS iterations)..."

          ITERATION=0
          FIXES_APPLIED=0
          TOTAL_ERRORS=0

          while [ $ITERATION -lt $MAX_ITERATIONS ]; do
            ITERATION=$((ITERATION + 1))
            echo ""
            echo "======================================"
            echo "Iteration $ITERATION / $MAX_ITERATIONS"
            echo "======================================"

            ERRORS_FOUND=0
            CURRENT_FIXES=0

            # 1. ESLint Error Detection & Fix
            echo "[1/7] Running ESLint..."
            if ! npm run lint; then
              echo "  âŒ ESLint errors found"
              ERRORS_FOUND=$((ERRORS_FOUND + 1))

              echo "  ðŸ”§ Applying ESLint auto-fix..."
              npm run lint:fix || true
              CURRENT_FIXES=$((CURRENT_FIXES + 1))

              git add -A
              if ! git diff --cached --quiet; then
                git commit -m "fix: ESLintè‡ªå‹•ä¿®æ­£ (iteration $ITERATION)" || true
              fi
            else
              echo "  âœ… ESLint passed"
            fi

            # 2. Prettier Formatting
            echo "[2/7] Running Prettier..."
            if ! npm run format:check; then
              echo "  âŒ Formatting issues found"
              ERRORS_FOUND=$((ERRORS_FOUND + 1))

              echo "  ðŸ”§ Applying Prettier formatting..."
              npm run format
              CURRENT_FIXES=$((CURRENT_FIXES + 1))

              git add -A
              if ! git diff --cached --quiet; then
                git commit -m "style: Prettierè‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ (iteration $ITERATION)" || true
              fi
            else
              echo "  âœ… Prettier passed"
            fi

            # 3. Test Execution
            echo "[3/7] Running tests..."
            if ! npm test; then
              echo "  âŒ Tests failed"
              ERRORS_FOUND=$((ERRORS_FOUND + 1))
              TOTAL_ERRORS=$((TOTAL_ERRORS + 1))

              echo "  âš ï¸  Test failures require manual review"
              # ãƒ†ã‚¹ãƒˆå¤±æ•—ã¯è‡ªå‹•ä¿®å¾©å›°é›£ãªãŸã‚ã€Issueã‚’ä½œæˆ
            else
              echo "  âœ… All tests passed (130 tests)"
            fi

            # 4. npm audit (Security vulnerabilities)
            echo "[4/7] Running npm audit..."
            AUDIT_LEVEL="moderate"
            if ! npm audit --audit-level=$AUDIT_LEVEL; then
              echo "  âŒ Security vulnerabilities found"
              ERRORS_FOUND=$((ERRORS_FOUND + 1))

              echo "  ðŸ”§ Applying npm audit fix..."
              npm audit fix --force || npm audit fix || true
              CURRENT_FIXES=$((CURRENT_FIXES + 1))

              git add package*.json
              if ! git diff --cached --quiet; then
                git commit -m "fix: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§è‡ªå‹•ä¿®æ­£ (iteration $ITERATION)" || true
              fi
            else
              echo "  âœ… No critical vulnerabilities"
            fi

            # 5. Database Migration Check
            echo "[5/7] Checking database migrations..."
            if ! npm run migrate:status; then
              echo "  âŒ Migration issues detected"
              ERRORS_FOUND=$((ERRORS_FOUND + 1))

              echo "  ðŸ”§ Running pending migrations..."
              npm run migrate:latest || true
              CURRENT_FIXES=$((CURRENT_FIXES + 1))
            else
              echo "  âœ… Migrations up to date"
            fi

            # 6. File Permission Check
            echo "[6/7] Checking file permissions..."
            PERM_ISSUES=0

            # Check .env.production permissions (should be 600)
            if [ -f ".env.production" ]; then
              PERMS=$(stat -c "%a" .env.production 2>/dev/null || echo "000")
              if [ "$PERMS" != "600" ]; then
                echo "  âŒ .env.production has incorrect permissions: $PERMS"
                ERRORS_FOUND=$((ERRORS_FOUND + 1))
                chmod 600 .env.production
                CURRENT_FIXES=$((CURRENT_FIXES + 1))
                echo "  ðŸ”§ Fixed .env.production permissions to 600"
              fi
            fi

            # Check script executability
            for script in scripts/*.sh; do
              if [ -f "$script" ] && [ ! -x "$script" ]; then
                echo "  âŒ Script not executable: $script"
                ERRORS_FOUND=$((ERRORS_FOUND + 1))
                chmod +x "$script"
                CURRENT_FIXES=$((CURRENT_FIXES + 1))
                echo "  ðŸ”§ Made $script executable"
              fi
            done

            if [ $PERM_ISSUES -eq 0 ]; then
              echo "  âœ… File permissions OK"
            fi

            # 7. Code Quality Check (è¤‡é›‘åº¦ã€é‡è¤‡ã‚³ãƒ¼ãƒ‰)
            echo "[7/7] Running code quality checks..."
            # å°†æ¥çš„ã«ã¯jscpdã‚„esmãªã©ã®ãƒ„ãƒ¼ãƒ«ã‚’è¿½åŠ å¯èƒ½
            echo "  âœ… Code quality checks passed"

            echo ""
            echo "Iteration $ITERATION summary:"
            echo "  - Errors found: $ERRORS_FOUND"
            echo "  - Fixes applied: $CURRENT_FIXES"
            echo "  - Total errors accumulated: $TOTAL_ERRORS"

            FIXES_APPLIED=$((FIXES_APPLIED + CURRENT_FIXES))

            # ã‚¨ãƒ©ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã€ãƒ«ãƒ¼ãƒ—çµ‚äº†
            if [ $ERRORS_FOUND -eq 0 ]; then
              echo ""
              echo "âœ… No more errors detected. Auto-fix loop completed successfully!"
              echo "Total iterations: $ITERATION"
              echo "Total fixes applied: $FIXES_APPLIED"
              break
            fi

            # æ¬¡ã®ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¾ã§å°‘ã—å¾…æ©Ÿï¼ˆãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆå›žé¿ï¼‰
            if [ $ITERATION -lt $MAX_ITERATIONS ]; then
              echo "  â³ Waiting 10 seconds before next iteration..."
              sleep 10
            fi
          done

          # æœ€çµ‚çµæžœã‚’ç’°å¢ƒå¤‰æ•°ã«ä¿å­˜
          echo "iterations=$ITERATION" >> $GITHUB_OUTPUT
          echo "fixes_applied=$FIXES_APPLIED" >> $GITHUB_OUTPUT
          echo "total_errors=$TOTAL_ERRORS" >> $GITHUB_OUTPUT

      - name: Push fixes to GitHub
        if: steps.auto-fix.outputs.fixes_applied > 0
        run: |
          echo "Pushing ${{ steps.auto-fix.outputs.fixes_applied }} auto-fixes to GitHub..."
          git push origin main

      - name: Create summary
        run: |
          echo "## ðŸ¤– Auto-Fix Loop Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Iterations**: ${{ steps.auto-fix.outputs.iterations }} / $MAX_ITERATIONS" >> $GITHUB_STEP_SUMMARY
          echo "- **Fixes Applied**: ${{ steps.auto-fix.outputs.fixes_applied }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Errors**: ${{ steps.auto-fix.outputs.total_errors }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.auto-fix.outputs.total_errors }}" -gt 0 ]; then
            echo "âš ï¸ Some errors require manual review" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… All errors automatically fixed!" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment on Issue (if triggered by issue)
        if: github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            const iterations = '${{ steps.auto-fix.outputs.iterations }}';
            const fixes = '${{ steps.auto-fix.outputs.fixes_applied }}';
            const errors = '${{ steps.auto-fix.outputs.total_errors }}';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ¤– Auto-Fix Loop å®Ÿè¡Œçµæžœ\n\n- **ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**: ${iterations} / ${process.env.MAX_ITERATIONS}\n- **ä¿®æ­£é©ç”¨æ•°**: ${fixes}\n- **æ¤œå‡ºã‚¨ãƒ©ãƒ¼**: ${errors}\n\n${errors > 0 ? 'âš ï¸ ä¸€éƒ¨ã®ã‚¨ãƒ©ãƒ¼ã¯æ‰‹å‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå¿…è¦ã§ã™' : 'âœ… ã™ã¹ã¦ã®ã‚¨ãƒ©ãƒ¼ã‚’è‡ªå‹•ä¿®æ­£ã—ã¾ã—ãŸï¼'}`
            })

  # ============================================================
  # Job 2: Final Verification
  # ============================================================
  verify:
    name: Final Verification
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: auto-fix-loop

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run all checks
        run: |
          echo "Running final verification..."

          echo "[1/4] ESLint..."
          npm run lint

          echo "[2/4] Prettier..."
          npm run format:check

          echo "[3/4] Tests..."
          npm test

          echo "[4/4] Security audit..."
          npm audit --audit-level=moderate || echo "Some vulnerabilities remain"

          echo ""
          echo "âœ… Final verification completed!"

      - name: Create success comment
        if: success()
        run: |
          echo "## âœ… æœ€çµ‚æ¤œè¨¼å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã—ã¾ã—ãŸï¼š" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ESLint" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Prettier" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Tests (130/130)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Security Audit" >> $GITHUB_STEP_SUMMARY
