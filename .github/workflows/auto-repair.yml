#####################################################################
# è‡ªå‹•ã‚¨ãƒ©ãƒ¼ä¿®å¾©ãƒ«ãƒ¼ãƒ—ï¼ˆClaudeCode + GitHub Actionsï¼‰
#
# ã‚¹ã‚­ãƒ¼ãƒãƒãƒ¼ã‚¸ãƒ§ãƒ³: state.json v1.0
#
# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ä»¥ä¸‹ã®åŸå‰‡ã«åŸºã¥ã„ã¦å‹•ä½œã—ã¾ã™ï¼š
#
# ã€GitHub Actions ã®å½¹å‰²ã€‘åˆ¶å¾¡ã‚¨ãƒ³ã‚¸ãƒ³
# - Workflow ã‚’èµ·å‹•ã™ã‚‹
# - ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹
# - æˆåŠŸ or å¤±æ•—ã‚’åˆ¤å®šã™ã‚‹
# - 1å›ã® Run ã§æœ€å¤§15å›ã®ä¿®å¾©ãƒ«ãƒ¼ãƒ—ã‚’å®Ÿè¡Œ
# - 15å›å¤±æ•—ã—ãŸå ´åˆã€çŠ¶æ…‹ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
# - 30åˆ†å¾Œã«å†å®Ÿè¡Œã™ã‚‹ã‹ã©ã†ã‹ã‚’åˆ¤æ–­
#
# ã€ClaudeCode ã®å½¹å‰²ã€‘ä¿®å¾©ã‚¨ãƒ³ã‚¸ãƒ³
# - ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼ã®å†…å®¹ã‚’èª­ã‚€
# - æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã®æ§‹é€ ã‚’ç†è§£ã™ã‚‹
# - CLAUDE.mdï¼ˆãƒ«ãƒ¼ãƒ«ãƒ»æ†²æ³•ï¼‰ã‚’å¿…ãšå®ˆã‚‹
# - README.mdï¼ˆä»•æ§˜æ›¸ï¼‰ã‚’å¤‰æ›´ã—ãªã„
# - ã‚¨ãƒ©ãƒ¼ã®åŸå› ã‚’ç‰¹å®šã—ã€å¿…è¦æœ€å°é™ã®ä¿®æ­£ã‚’è¡Œã†
#
#####################################################################

name: è‡ªå‹•ã‚¨ãƒ©ãƒ¼ä¿®å¾©ãƒ«ãƒ¼ãƒ—

on:
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      force_run:
        description: 'çŠ¶æ…‹ã«é–¢ã‚ã‚‰ãšå¼·åˆ¶å®Ÿè¡Œ'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

  # 30åˆ†é–“éš”ã§è‡ªå‹•å®Ÿè¡Œï¼ˆstate.json ã§åˆ¶å¾¡ï¼‰
  schedule:
    - cron: '*/30 * * * *'  # æ¯30åˆ†å®Ÿè¡Œï¼ˆUTCï¼‰

  # Issueãƒˆãƒªã‚¬ãƒ¼
  issues:
    types: [opened, labeled]

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  STATE_FILE: '.github/auto-repair/state.json'
  REPAIR_GUIDE: '.github/auto-repair/repair.md'
  NODE_VERSION: '20'
  JWT_SECRET: test-secret-key-for-auto-fix-workflow
  NODE_ENV: test
  DATABASE_PATH: ./backend/test_itsm.db

jobs:
  #####################################################################
  # Job 1: çŠ¶æ…‹ç¢ºèªãƒ»å®Ÿè¡Œåˆ¤æ–­
  #####################################################################
  check-state:
    name: çŠ¶æ…‹ç¢ºèªï¼ˆå®Ÿè¡Œåˆ¤æ–­ï¼‰
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      should_run: ${{ steps.decide.outputs.should_run }}
      need_retry: ${{ steps.load.outputs.need_retry }}
      current_run: ${{ steps.load.outputs.current_run }}
      max_runs: ${{ steps.load.outputs.max_runs }}

    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆæœŸåŒ–ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆï¼‰
        run: |
          if [ ! -f "$STATE_FILE" ]; then
            echo "ğŸ“ state.json ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€åˆæœŸåŒ–ã—ã¾ã™"
            mkdir -p .github/auto-repair
            cat << 'EOF' > $STATE_FILE
          {
            "schema_version": "1.0",
            "retry": {
              "need_retry": false,
              "current_run": 0,
              "max_runs": 10,
              "last_run_result": "none",
              "last_failure_type": null
            },
            "loop": {
              "max_attempts_per_run": 15,
              "attempts_used": 0
            },
            "timestamps": {
              "first_failed_at": null,
              "last_failed_at": null,
              "last_success_at": null
            },
            "meta": {
              "workflow": "auto-repair",
              "branch": "main",
              "note": "initialized"
            }
          }
          EOF
          fi

      - name: state.jsonã‚’èª­ã¿è¾¼ã¿
        id: load
        run: |
          echo "ğŸ“– state.json ã‚’èª­ã¿è¾¼ã¿ä¸­..."

          NEED_RETRY=$(jq -r '.retry.need_retry' $STATE_FILE)
          CURRENT_RUN=$(jq -r '.retry.current_run' $STATE_FILE)
          MAX_RUNS=$(jq -r '.retry.max_runs' $STATE_FILE)
          LAST_RESULT=$(jq -r '.retry.last_run_result' $STATE_FILE)

          echo "need_retry=$NEED_RETRY" >> $GITHUB_OUTPUT
          echo "current_run=$CURRENT_RUN" >> $GITHUB_OUTPUT
          echo "max_runs=$MAX_RUNS" >> $GITHUB_OUTPUT

          echo "ç¾åœ¨ã®çŠ¶æ…‹:"
          echo "  - need_retry: $NEED_RETRY"
          echo "  - current_run: $CURRENT_RUN / $MAX_RUNS"
          echo "  - last_result: $LAST_RESULT"

      - name: å®Ÿè¡Œå¯å¦ã‚’åˆ¤æ–­
        id: decide
        run: |
          NEED_RETRY="${{ steps.load.outputs.need_retry }}"
          CURRENT_RUN="${{ steps.load.outputs.current_run }}"
          MAX_RUNS="${{ steps.load.outputs.max_runs }}"
          FORCE_RUN="${{ github.event.inputs.force_run }}"

          SHOULD_RUN="false"

          # 1. max_runs ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€å„ªå…ˆï¼‰
          if [ "$CURRENT_RUN" -ge "$MAX_RUNS" ] && [ "$FORCE_RUN" != "true" ]; then
            echo "âŒ æœ€å¤§Runå›æ•°ï¼ˆ$MAX_RUNSï¼‰ã«åˆ°é”ã—ã¾ã—ãŸã€‚å®Ÿè¡Œã‚’ä¸­æ­¢ã—ã¾ã™ã€‚"
            echo "should_run=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # 2. æ‰‹å‹•å®Ÿè¡Œï¼ˆworkflow_dispatchï¼‰
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "âœ… æ‰‹å‹•å®Ÿè¡Œã®ãŸã‚ã€ä¿®å¾©ãƒ«ãƒ¼ãƒ—ã‚’å®Ÿè¡Œã—ã¾ã™"
            SHOULD_RUN="true"

          # 3. Issueãƒˆãƒªã‚¬ãƒ¼
          elif [ "${{ github.event_name }}" = "issues" ]; then
            if echo "${{ join(github.event.issue.labels.*.name, ' ') }}" | grep -q "auto-fix"; then
              echo "âœ… Issueãƒ©ãƒ™ãƒ« 'auto-fix' ãŒä»˜ã„ã¦ã„ã‚‹ãŸã‚ã€ä¿®å¾©ãƒ«ãƒ¼ãƒ—ã‚’å®Ÿè¡Œã—ã¾ã™"
              SHOULD_RUN="true"
            fi

          # 4. ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œï¼ˆstate.jsonã§åˆ¶å¾¡ï¼‰
          elif [ "${{ github.event_name }}" = "schedule" ]; then
            if [ "$NEED_RETRY" = "true" ]; then
              echo "âœ… need_retry=true ã®ãŸã‚ã€ä¿®å¾©ãƒ«ãƒ¼ãƒ—ã‚’å†å®Ÿè¡Œã—ã¾ã™"
              SHOULD_RUN="true"
            else
              echo "â­ï¸  need_retry=false ã®ãŸã‚ã€ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
              SHOULD_RUN="false"
            fi
          fi

          echo "should_run=$SHOULD_RUN" >> $GITHUB_OUTPUT
          echo "ğŸ“Š æœ€çµ‚åˆ¤æ–­: should_run=$SHOULD_RUN"

  #####################################################################
  # Job 2: è‡ªå‹•ä¿®å¾©ãƒ«ãƒ¼ãƒ—ï¼ˆæœ€å¤§15å›è©¦è¡Œï¼‰
  #####################################################################
  auto-repair:
    name: è‡ªå‹•ä¿®å¾©ãƒ«ãƒ¼ãƒ—ï¼ˆã‚¨ãƒ©ãƒ¼ä¿®å¾©å®Ÿè¡Œï¼‰
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: check-state
    if: needs.check-state.outputs.should_run == 'true'

    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Node.jsã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      - name: Gitã‚’è¨­å®š
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
        run: |
          echo "ğŸ“‹ å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª..."

          if [ ! -f "CLAUDE.md" ]; then
            echo "âŒ CLAUDE.md ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          echo "âœ… CLAUDE.md ç¢ºèª"

          if [ ! -f "$REPAIR_GUIDE" ]; then
            echo "âŒ repair.md ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          echo "âœ… repair.md ç¢ºèª"

          if [ ! -f "README.md" ]; then
            echo "âŒ README.md ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          echo "âœ… README.md ç¢ºèª"

      - name: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
        run: |
          echo "ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œä¸­..."
          npm run migrate:latest
          echo "âœ… ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†"

      - name: ä¿®å¾©ãƒ«ãƒ¼ãƒ—ã‚’å®Ÿè¡Œ
        id: repair-loop
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”„ è‡ªå‹•ä¿®å¾©ãƒ«ãƒ¼ãƒ—ã‚’é–‹å§‹ã—ã¾ã™"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # state.jsonã‹ã‚‰æœ€å¤§è©¦è¡Œå›æ•°ã‚’èª­ã¿å–ã‚‹
          MAX_ATTEMPTS=$(jq -r '.loop.max_attempts_per_run' $STATE_FILE)
          ATTEMPT=0
          SUCCESS=false
          LAST_ERROR=""

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ” è©¦è¡Œ $ATTEMPT / $MAX_ATTEMPTS"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            # ========================================
            # ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
            # ========================================
            echo "ğŸ“Š [1/3] ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."

            if npm test 2>&1 | tee test-output.log; then
              echo "âœ… ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼"
              SUCCESS=true

              # æˆåŠŸæ™‚ã®çŠ¶æ…‹æ›´æ–°
              NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
              jq --arg now "$NOW" \
                 --argjson attempts "$ATTEMPT" \
                 '.retry.need_retry = false |
                  .retry.last_run_result = "success" |
                  .retry.last_failure_type = null |
                  .loop.attempts_used = $attempts |
                  .timestamps.last_success_at = $now' \
                 $STATE_FILE > $STATE_FILE.tmp
              mv $STATE_FILE.tmp $STATE_FILE

              break
            else
              echo "âŒ ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ"

              # ã‚¨ãƒ©ãƒ¼å†…å®¹ã‚’æŠ½å‡º
              LAST_ERROR=$(tail -100 test-output.log | grep -E "(Error|FAIL|â—|âœ•)" | head -10)
              echo "ğŸ“‹ ã‚¨ãƒ©ãƒ¼å†…å®¹:"
              echo "$LAST_ERROR"
            fi

            # ========================================
            # ã‚¹ãƒ†ãƒƒãƒ—2: ClaudeCodeã§ä¿®å¾©
            # ========================================
            echo ""
            echo "ğŸ¤– [2/3] ClaudeCode ã«ã‚ˆã‚‹è‡ªå‹•ä¿®å¾©ã‚’å®Ÿè¡Œä¸­..."
            echo "ğŸ“‹ repair.md ãŠã‚ˆã³ CLAUDE.md ã®ãƒ«ãƒ¼ãƒ«ã«å¾“ã£ã¦ä¿®å¾©ã—ã¾ã™"

            # âš ï¸ æ³¨æ„: å®Ÿéš›ã®ClaudeCode CLIå‘¼ã³å‡ºã—ï¼ˆå°†æ¥å®Ÿè£…ï¼‰
            # claude run .github/auto-repair/repair.md --context test-output.log

            # ç¾æ™‚ç‚¹ã§ã¯ç°¡æ˜“çš„ãªè‡ªå‹•ä¿®æ­£
            echo "  ğŸ”§ ESLintè‡ªå‹•ä¿®æ­£..."
            npm run lint:fix 2>&1 || true

            echo "  ğŸ”§ Prettierè‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ..."
            npm run format 2>&1 || true

            # å¤‰æ›´ãŒã‚ã‚Œã°ã‚³ãƒŸãƒƒãƒˆ
            git add -A
            if ! git diff --cached --quiet; then
              git commit -m "fix(auto): è‡ªå‹•ä¿®å¾© (è©¦è¡Œ $ATTEMPT/$MAX_ATTEMPTS)" \
                         -m "ä¿®å¾©è©¦è¡Œç•ªå·: $ATTEMPT" \
                         -m "ã‚¨ãƒ©ãƒ¼æ¦‚è¦: $(echo "$LAST_ERROR" | head -1 | cut -c1-100)" \
                         -m "" \
                         -m "ğŸ¤– è‡ªå‹•ã‚¨ãƒ©ãƒ¼ä¿®å¾©ãƒ«ãƒ¼ãƒ—ã«ã‚ˆã‚Šç”Ÿæˆ" \
                         -m "ğŸ“‹ repair.md + CLAUDE.md ã«å¾“ã£ã¦ä¿®å¾©" || true
              echo "  âœ“ ä¿®æ­£ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¾ã—ãŸ"
            else
              echo "  âš ï¸  è‡ªå‹•ä¿®æ­£ã«ã‚ˆã‚‹å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
            fi

            # ========================================
            # ã‚¹ãƒ†ãƒƒãƒ—3: çŸ­ã„å¾…æ©Ÿ
            # ========================================
            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              echo "â³ æ¬¡ã®è©¦è¡Œã¾ã§5ç§’å¾…æ©Ÿ..."
              sleep 5
            fi
          done

          # ========================================
          # æœ€çµ‚çµæœã‚’å‡ºåŠ›å¤‰æ•°ã«è¨­å®š
          # ========================================
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          if [ "$SUCCESS" = "true" ]; then
            echo "âœ… ä¿®å¾©ãƒ«ãƒ¼ãƒ—æˆåŠŸï¼ˆè©¦è¡Œå›æ•°: $ATTEMPTï¼‰"
            echo "success=true" >> $GITHUB_OUTPUT
            echo "attempts=$ATTEMPT" >> $GITHUB_OUTPUT
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ ä¿®å¾©ãƒ«ãƒ¼ãƒ—å¤±æ•—ï¼ˆæœ€å¤§è©¦è¡Œå›æ•°ã«åˆ°é”ï¼‰"
            echo "success=false" >> $GITHUB_OUTPUT
            echo "attempts=$ATTEMPT" >> $GITHUB_OUTPUT
            echo "result=test_failed" >> $GITHUB_OUTPUT
            echo "error<<EOF" >> $GITHUB_OUTPUT
            echo "$LAST_ERROR" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

            # å¤±æ•—æ™‚ã®çŠ¶æ…‹æ›´æ–°
            NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            FIRST_FAILED=$(jq -r '.timestamps.first_failed_at' $STATE_FILE)
            if [ "$FIRST_FAILED" = "null" ]; then
              FIRST_FAILED="$NOW"
            fi

            jq --arg now "$NOW" \
               --arg first "$FIRST_FAILED" \
               --argjson attempts "$ATTEMPT" \
               --arg error "$(echo "$LAST_ERROR" | head -1 | cut -c1-200)" \
               '.retry.need_retry = true |
                .retry.last_run_result = "test_failed" |
                .retry.last_failure_type = "unit_test" |
                .loop.attempts_used = $attempts |
                .timestamps.first_failed_at = $first |
                .timestamps.last_failed_at = $now' \
               $STATE_FILE > $STATE_FILE.tmp
            mv $STATE_FILE.tmp $STATE_FILE
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Runå›æ•°ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
        if: always()
        run: |
          echo "ğŸ“Š Runå›æ•°ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆä¸­..."
          jq '.retry.current_run += 1' $STATE_FILE > $STATE_FILE.tmp
          mv $STATE_FILE.tmp $STATE_FILE

          NEW_RUN=$(jq -r '.retry.current_run' $STATE_FILE)
          echo "ç¾åœ¨ã®Runå›æ•°: $NEW_RUN"

      - name: ä¿®æ­£ã‚’ãƒ—ãƒƒã‚·ãƒ¥
        if: steps.repair-loop.outputs.success == 'true'
        run: |
          echo "ğŸ“¤ ä¿®æ­£ã‚’ãƒªãƒ¢ãƒ¼ãƒˆã«ãƒ—ãƒƒã‚·ãƒ¥ä¸­..."
          git push origin main || echo "âš ï¸ ãƒ—ãƒƒã‚·ãƒ¥ã«å¤±æ•—ï¼ˆç«¶åˆã®å¯èƒ½æ€§ï¼‰"

      - name: state.jsonã‚’ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒƒã‚·ãƒ¥
        if: always()
        run: |
          echo "ğŸ’¾ state.jsonã‚’æ›´æ–°ä¸­..."

          git add $STATE_FILE
          if ! git diff --cached --quiet; then
            RUN_NUM=$(jq -r '.retry.current_run' $STATE_FILE)
            RESULT=$(jq -r '.retry.last_run_result' $STATE_FILE)

            git commit -m "chore(auto): state.jsonæ›´æ–° (Run #$RUN_NUM, result: $RESULT)"
            git push origin main || echo "âš ï¸ state.jsonã®ãƒ—ãƒƒã‚·ãƒ¥ã«å¤±æ•—"

            echo "âœ… state.jsonã‚’æ›´æ–°ã—ã¦ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ"
          else
            echo "â„¹ï¸  state.jsonã«å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
          fi

      - name: å®Ÿè¡Œã‚µãƒãƒªãƒ¼ã‚’ä½œæˆ
        if: always()
        run: |
          SUCCESS="${{ steps.repair-loop.outputs.success }}"
          ATTEMPTS="${{ steps.repair-loop.outputs.attempts }}"
          RESULT="${{ steps.repair-loop.outputs.result }}"
          CURRENT_RUN=$(jq -r '.retry.current_run' $STATE_FILE)
          MAX_RUNS=$(jq -r '.retry.max_runs' $STATE_FILE)

          echo "## ğŸ¤– è‡ªå‹•ã‚¨ãƒ©ãƒ¼ä¿®å¾©ãƒ«ãƒ¼ãƒ— å®Ÿè¡Œçµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$SUCCESS" = "true" ]; then
            echo "### âœ… ä¿®å¾©æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **è©¦è¡Œå›æ•°**: $ATTEMPTS å›" >> $GITHUB_STEP_SUMMARY
            echo "- **Runç•ªå·**: #$CURRENT_RUN / $MAX_RUNS" >> $GITHUB_STEP_SUMMARY
            echo "- **çµæœ**: ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ ä¿®å¾©å¤±æ•—ï¼ˆæœ€å¤§è©¦è¡Œå›æ•°ã«åˆ°é”ï¼‰" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **è©¦è¡Œå›æ•°**: $ATTEMPTS å›ï¼ˆæœ€å¤§ï¼‰" >> $GITHUB_STEP_SUMMARY
            echo "- **Runç•ªå·**: #$CURRENT_RUN / $MAX_RUNS" >> $GITHUB_STEP_SUMMARY
            echo "- **æ¬¡å›**: 30åˆ†å¾Œã«è‡ªå‹•å†å®Ÿè¡Œäºˆå®š" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### æœ€å¾Œã®ã‚¨ãƒ©ãƒ¼:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.repair-loop.outputs.error }}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“‹ **ãƒ«ãƒ¼ãƒ«éµå®ˆ**: CLAUDE.md + repair.md ã«åŸºã¥ã„ã¦ä¿®å¾©" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“– **ä»•æ§˜ä¿è­·**: README.md ã¯å¤‰æ›´ã•ã‚Œã¦ã„ã¾ã›ã‚“" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ’¾ **çŠ¶æ…‹ç®¡ç†**: state.json v1.0" >> $GITHUB_STEP_SUMMARY

      - name: ç¾åœ¨ã®çŠ¶æ…‹ã‚’è¡¨ç¤º
        if: always()
        run: |
          echo "ğŸ“Š ç¾åœ¨ã®state.json:"
          cat $STATE_FILE | jq .

  #####################################################################
  # Job 3: æœ€çµ‚æ¤œè¨¼ï¼ˆæˆåŠŸæ™‚ã®ã¿ï¼‰
  #####################################################################
  final-verification:
    name: æœ€çµ‚æ¤œè¨¼ï¼ˆä¿®å¾©å†…å®¹ã®æ¤œè¨¼ï¼‰
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: auto-repair
    if: needs.auto-repair.result == 'success'

    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Node.jsã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      - name: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
        run: npm run migrate:latest

      - name: å…¨ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
        run: |
          echo "ğŸ” æœ€çµ‚æ¤œè¨¼ã‚’é–‹å§‹ã—ã¾ã™..."
          echo ""

          echo "[1/4] ESLintãƒã‚§ãƒƒã‚¯..."
          npm run lint
          echo "âœ… ESLint OK"
          echo ""

          echo "[2/4] Prettierãƒã‚§ãƒƒã‚¯..."
          npm run format:check
          echo "âœ… Prettier OK"
          echo ""

          echo "[3/4] å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ..."
          npm test
          echo "âœ… Tests OK"
          echo ""

          echo "[4/4] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯..."
          npm audit --audit-level=moderate || echo "âš ï¸ ä¸€éƒ¨ã®è„†å¼±æ€§ãŒæ®‹ã£ã¦ã„ã¾ã™"
          echo ""

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… ã™ã¹ã¦ã®æ¤œè¨¼ãŒæˆåŠŸã—ã¾ã—ãŸï¼"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: æ¤œè¨¼çµæœã‚’ã‚µãƒãƒªãƒ¼ã«è¿½åŠ 
        if: success()
        run: |
          echo "## âœ… æœ€çµ‚æ¤œè¨¼å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã—ã¾ã—ãŸï¼š" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ESLint" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Prettier" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Tests" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Security Audit" >> $GITHUB_STEP_SUMMARY
