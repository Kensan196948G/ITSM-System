#####################################################################
# è‡ªå‹•ã‚¨ãƒ©ãƒ¼ä¿®å¾©ãƒ«ãƒ¼ãƒ—ï¼ˆClaudeCode + GitHub Actionsï¼‰
#
# ã‚¹ã‚­ãƒ¼ãƒžãƒãƒ¼ã‚¸ãƒ§ãƒ³: state.json v1.1
# æ©Ÿèƒ½: åŒä¸€ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ + å¼·åˆ¶åœæ­¢é€šçŸ¥
#
# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ä»¥ä¸‹ã®åŽŸå‰‡ã«åŸºã¥ã„ã¦å‹•ä½œã—ã¾ã™ï¼š
#
# ã€GitHub Actions ã®å½¹å‰²ã€‘åˆ¶å¾¡ã‚¨ãƒ³ã‚¸ãƒ³
# - Workflow ã‚’èµ·å‹•ã™ã‚‹
# - ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹
# - æˆåŠŸ or å¤±æ•—ã‚’åˆ¤å®šã™ã‚‹
# - åŒä¸€ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ï¼ˆãƒãƒƒã‚·ãƒ¥æ¯”è¼ƒï¼‰
# - 1å›žã® Run ã§æœ€å¤§15å›žã®ä¿®å¾©ãƒ«ãƒ¼ãƒ—ã‚’å®Ÿè¡Œ
# - 15å›žå¤±æ•— or åŒä¸€ã‚¨ãƒ©ãƒ¼3å›žã§å¼·åˆ¶åœæ­¢
# - Issueé€šçŸ¥ï¼ˆäººé–“ã¸ã®ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
#
# ã€ClaudeCode ã®å½¹å‰²ã€‘ä¿®å¾©ã‚¨ãƒ³ã‚¸ãƒ³
# - ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼ã®å†…å®¹ã‚’èª­ã‚€
# - æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã®æ§‹é€ ã‚’ç†è§£ã™ã‚‹
# - CLAUDE.mdï¼ˆãƒ«ãƒ¼ãƒ«ãƒ»æ†²æ³•ï¼‰ã‚’å¿…ãšå®ˆã‚‹
# - README.mdï¼ˆä»•æ§˜æ›¸ï¼‰ã‚’å¤‰æ›´ã—ãªã„
# - ã‚¨ãƒ©ãƒ¼ã®åŽŸå› ã‚’ç‰¹å®šã—ã€å¿…è¦æœ€å°é™ã®ä¿®æ­£ã‚’è¡Œã†
#
#####################################################################

name: è‡ªå‹•ã‚¨ãƒ©ãƒ¼ä¿®å¾©ãƒ«ãƒ¼ãƒ—

on:
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      force_run:
        description: 'çŠ¶æ…‹ã«é–¢ã‚ã‚‰ãšå¼·åˆ¶å®Ÿè¡Œ'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

  # 30åˆ†é–“éš”ã§è‡ªå‹•å®Ÿè¡Œï¼ˆstate.json ã§åˆ¶å¾¡ï¼‰
  schedule:
    - cron: '*/30 * * * *'  # æ¯Ž30åˆ†å®Ÿè¡Œï¼ˆUTCï¼‰

  # Issueãƒˆãƒªã‚¬ãƒ¼
  issues:
    types: [opened, labeled]

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  STATE_FILE: '.github/auto-repair/state.json'
  REPAIR_GUIDE: '.github/auto-repair/repair.md'
  NODE_VERSION: '20'
  JWT_SECRET: ${{ secrets.JWT_SECRET_TEST }}
  NODE_ENV: test
  DATABASE_PATH: ./backend/test_itsm.db

jobs:
  #####################################################################
  # Job 1: çŠ¶æ…‹ç¢ºèªãƒ»å®Ÿè¡Œåˆ¤æ–­
  #####################################################################
  check-state:
    name: çŠ¶æ…‹ç¢ºèªï¼ˆå®Ÿè¡Œåˆ¤æ–­ï¼‰
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      should_run: ${{ steps.decide.outputs.should_run }}
      need_retry: ${{ steps.load.outputs.need_retry }}
      current_run: ${{ steps.load.outputs.current_run }}
      max_runs: ${{ steps.load.outputs.max_runs }}
      forced_stop: ${{ steps.load.outputs.forced_stop }}

    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆæœŸåŒ–ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆï¼‰
        run: |
          if [ ! -f "$STATE_FILE" ]; then
            echo "ðŸ“ state.json ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€åˆæœŸåŒ–ã—ã¾ã™"
            mkdir -p .github/auto-repair
            echo '{"schema_version":"1.1","retry":{"need_retry":false,"current_run":0,"max_runs":10,"last_run_result":"none","last_failure_type":null},"loop":{"max_attempts_per_run":15,"attempts_used":0},"error_tracking":{"last_error_hash":null,"same_error_count":0,"max_same_error":3},"stop":{"forced":false,"reason":null},"timestamps":{"first_failed_at":null,"last_failed_at":null,"last_success_at":null},"meta":{"workflow":"auto-repair","branch":"main","note":"initialized"}}' | jq . > $STATE_FILE
            echo "âœ… state.json ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ"
          fi

      - name: state.jsonã‚’èª­ã¿è¾¼ã¿
        id: load
        run: |
          echo "ðŸ“– state.json ã‚’èª­ã¿è¾¼ã¿ä¸­..."

          NEED_RETRY=$(jq -r '.retry.need_retry' $STATE_FILE)
          CURRENT_RUN=$(jq -r '.retry.current_run' $STATE_FILE)
          MAX_RUNS=$(jq -r '.retry.max_runs' $STATE_FILE)
          FORCED_STOP=$(jq -r '.stop.forced' $STATE_FILE)
          STOP_REASON=$(jq -r '.stop.reason' $STATE_FILE)

          echo "need_retry=$NEED_RETRY" >> $GITHUB_OUTPUT
          echo "current_run=$CURRENT_RUN" >> $GITHUB_OUTPUT
          echo "max_runs=$MAX_RUNS" >> $GITHUB_OUTPUT
          echo "forced_stop=$FORCED_STOP" >> $GITHUB_OUTPUT

          echo "ç¾åœ¨ã®çŠ¶æ…‹:"
          echo "  - need_retry: $NEED_RETRY"
          echo "  - current_run: $CURRENT_RUN / $MAX_RUNS"
          echo "  - forced_stop: $FORCED_STOP"
          if [ "$STOP_REASON" != "null" ]; then
            echo "  - stop_reason: $STOP_REASON"
          fi

      - name: å®Ÿè¡Œå¯å¦ã‚’åˆ¤æ–­
        id: decide
        run: |
          NEED_RETRY="${{ steps.load.outputs.need_retry }}"
          CURRENT_RUN="${{ steps.load.outputs.current_run }}"
          MAX_RUNS="${{ steps.load.outputs.max_runs }}"
          FORCED_STOP="${{ steps.load.outputs.forced_stop }}"
          FORCE_RUN="${{ github.event.inputs.force_run }}"

          SHOULD_RUN="false"

          # 0. å¼·åˆ¶åœæ­¢ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€å„ªå…ˆï¼‰
          if [ "$FORCED_STOP" = "true" ] && [ "$FORCE_RUN" != "true" ]; then
            echo "ðŸ›‘ å¼·åˆ¶åœæ­¢ãƒ•ãƒ©ã‚°ãŒç«‹ã£ã¦ã„ã¾ã™ã€‚å®Ÿè¡Œã‚’ä¸­æ­¢ã—ã¾ã™ã€‚"
            echo "   ç†ç”±: $(jq -r '.stop.reason' $STATE_FILE)"
            echo "   â€» æ‰‹å‹•å®Ÿè¡Œï¼ˆforce_run=trueï¼‰ã§å†é–‹å¯èƒ½ã§ã™"
            echo "should_run=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # 1. max_runs ãƒã‚§ãƒƒã‚¯
          if [ "$CURRENT_RUN" -ge "$MAX_RUNS" ] && [ "$FORCE_RUN" != "true" ]; then
            echo "âŒ æœ€å¤§Runå›žæ•°ï¼ˆ$MAX_RUNSï¼‰ã«åˆ°é”ã—ã¾ã—ãŸã€‚å®Ÿè¡Œã‚’ä¸­æ­¢ã—ã¾ã™ã€‚"
            echo "should_run=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # 2. æ‰‹å‹•å®Ÿè¡Œï¼ˆworkflow_dispatchï¼‰
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "âœ… æ‰‹å‹•å®Ÿè¡Œã®ãŸã‚ã€ä¿®å¾©ãƒ«ãƒ¼ãƒ—ã‚’å®Ÿè¡Œã—ã¾ã™"
            SHOULD_RUN="true"

          # 3. Issueãƒˆãƒªã‚¬ãƒ¼
          elif [ "${{ github.event_name }}" = "issues" ]; then
            if echo "${{ join(github.event.issue.labels.*.name, ' ') }}" | grep -q "auto-fix"; then
              echo "âœ… Issueãƒ©ãƒ™ãƒ« 'auto-fix' ãŒä»˜ã„ã¦ã„ã‚‹ãŸã‚ã€ä¿®å¾©ãƒ«ãƒ¼ãƒ—ã‚’å®Ÿè¡Œã—ã¾ã™"
              SHOULD_RUN="true"
            fi

          # 4. ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œï¼ˆstate.jsonã§åˆ¶å¾¡ï¼‰
          elif [ "${{ github.event_name }}" = "schedule" ]; then
            if [ "$NEED_RETRY" = "true" ]; then
              echo "âœ… need_retry=true ã®ãŸã‚ã€ä¿®å¾©ãƒ«ãƒ¼ãƒ—ã‚’å†å®Ÿè¡Œã—ã¾ã™"
              SHOULD_RUN="true"
            else
              echo "â­ï¸  need_retry=false ã®ãŸã‚ã€ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
              SHOULD_RUN="false"
            fi
          fi

          echo "should_run=$SHOULD_RUN" >> $GITHUB_OUTPUT
          echo "ðŸ“Š æœ€çµ‚åˆ¤æ–­: should_run=$SHOULD_RUN"

  #####################################################################
  # Job 2: è‡ªå‹•ä¿®å¾©ãƒ«ãƒ¼ãƒ—ï¼ˆåŒä¸€ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥æ©Ÿèƒ½ä»˜ãï¼‰
  #####################################################################
  auto-repair:
    name: è‡ªå‹•ä¿®å¾©ãƒ«ãƒ¼ãƒ—ï¼ˆã‚¨ãƒ©ãƒ¼ä¿®å¾©å®Ÿè¡Œï¼‰
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: check-state
    if: needs.check-state.outputs.should_run == 'true'

    outputs:
      success: ${{ steps.repair-loop.outputs.success }}
      attempts: ${{ steps.repair-loop.outputs.attempts }}
      forced_stop: ${{ steps.repair-loop.outputs.forced_stop }}
      stop_reason: ${{ steps.repair-loop.outputs.stop_reason }}

    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Node.jsã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      - name: Gitã‚’è¨­å®š
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
        run: |
          echo "ðŸ“‹ å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª..."

          if [ ! -f "CLAUDE.md" ]; then
            echo "âŒ CLAUDE.md ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          echo "âœ… CLAUDE.md ç¢ºèª"

          if [ ! -f "$REPAIR_GUIDE" ]; then
            echo "âŒ repair.md ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          echo "âœ… repair.md ç¢ºèª"

          if [ ! -f "README.md" ]; then
            echo "âŒ README.md ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          echo "âœ… README.md ç¢ºèª"

      - name: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
        run: |
          echo "ðŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œä¸­..."
          npm run migrate:latest
          echo "âœ… ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†"

      - name: ä¿®å¾©ãƒ«ãƒ¼ãƒ—ã‚’å®Ÿè¡Œï¼ˆåŒä¸€ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥æ©Ÿèƒ½ä»˜ãï¼‰
        id: repair-loop
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ”„ è‡ªå‹•ä¿®å¾©ãƒ«ãƒ¼ãƒ—ã‚’é–‹å§‹ã—ã¾ã™"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # state.jsonã‹ã‚‰è¨­å®šã‚’èª­ã¿å–ã‚‹
          MAX_ATTEMPTS=$(jq -r '.loop.max_attempts_per_run' $STATE_FILE)
          MAX_SAME_ERROR=$(jq -r '.error_tracking.max_same_error' $STATE_FILE)
          LAST_ERROR_HASH=$(jq -r '.error_tracking.last_error_hash' $STATE_FILE)

          ATTEMPT=0
          SUCCESS=false
          FORCED_STOP=false
          STOP_REASON=""
          SAME_ERROR_COUNT=0
          LAST_ERROR=""
          CURRENT_ERROR_HASH=""

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸ” è©¦è¡Œ $ATTEMPT / $MAX_ATTEMPTS"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            # ========================================
            # ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
            # ========================================
            echo "ðŸ“Š [1/4] ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."

            if npm test 2>&1 | tee test-output.log; then
              echo "âœ… ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼"
              SUCCESS=true

              # æˆåŠŸæ™‚ã®çŠ¶æ…‹æ›´æ–°
              NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
              jq --arg now "$NOW" \
                 --argjson attempts "$ATTEMPT" \
                 '.retry.need_retry = false |
                  .retry.last_run_result = "success" |
                  .retry.last_failure_type = null |
                  .loop.attempts_used = $attempts |
                  .error_tracking.last_error_hash = null |
                  .error_tracking.same_error_count = 0 |
                  .stop.forced = false |
                  .stop.reason = null |
                  .timestamps.last_success_at = $now' \
                 $STATE_FILE > $STATE_FILE.tmp
              mv $STATE_FILE.tmp $STATE_FILE

              break
            else
              echo "âŒ ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ"

              # ã‚¨ãƒ©ãƒ¼å†…å®¹ã‚’æŠ½å‡ºï¼ˆæ­£è¦åŒ–ï¼‰
              # è¡Œç•ªå·ãƒ»ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’é™¤å¤–ã—ã¦æœ¬è³ªçš„ãªã‚¨ãƒ©ãƒ¼ã®ã¿æŠ½å‡º
              LAST_ERROR=$(tail -100 test-output.log | \
                grep -E "(Error|FAIL|â—|âœ•|Expected)" | \
                sed 's/:[0-9]*:[0-9]*/:/g' | \
                sed 's/line [0-9]*/line X/g' | \
                head -5)

              echo "ðŸ“‹ ã‚¨ãƒ©ãƒ¼å†…å®¹ï¼ˆæ­£è¦åŒ–å¾Œï¼‰:"
              echo "$LAST_ERROR"

              # ========================================
              # ã‚¹ãƒ†ãƒƒãƒ—2: ã‚¨ãƒ©ãƒ¼ãƒãƒƒã‚·ãƒ¥ç”Ÿæˆï¼†åŒä¸€ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥
              # ========================================
              echo ""
              echo "ðŸ” [2/4] åŒä¸€ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ä¸­..."

              # ã‚¨ãƒ©ãƒ¼å†…å®¹ã®ãƒãƒƒã‚·ãƒ¥ã‚’ç”Ÿæˆï¼ˆSHA-256ï¼‰
              CURRENT_ERROR_HASH=$(echo "$LAST_ERROR" | sha256sum | awk '{print $1}')
              echo "ç¾åœ¨ã®ã‚¨ãƒ©ãƒ¼ãƒãƒƒã‚·ãƒ¥: ${CURRENT_ERROR_HASH:0:16}..."

              # å‰å›žã®ãƒãƒƒã‚·ãƒ¥ã¨æ¯”è¼ƒ
              if [ "$LAST_ERROR_HASH" != "null" ] && [ "$CURRENT_ERROR_HASH" = "$LAST_ERROR_HASH" ]; then
                SAME_ERROR_COUNT=$((SAME_ERROR_COUNT + 1))
                echo "âš ï¸  åŒä¸€ã‚¨ãƒ©ãƒ¼ãŒé€£ç¶šã—ã¦ã„ã¾ã™ï¼ˆ$SAME_ERROR_COUNT å›žç›®ï¼‰"

                # åŒä¸€ã‚¨ãƒ©ãƒ¼ãŒä¸Šé™ã«é”ã—ãŸã‚‰å¼·åˆ¶åœæ­¢
                if [ $SAME_ERROR_COUNT -ge $MAX_SAME_ERROR ]; then
                  echo "ðŸ›‘ åŒä¸€ã‚¨ãƒ©ãƒ¼ãŒ $MAX_SAME_ERROR å›žé€£ç¶šã§ç™ºç”Ÿã—ã¾ã—ãŸ"
                  echo "   è‡ªå‹•ä¿®å¾©ã‚’å¼·åˆ¶åœæ­¢ã—ã¾ã™"

                  FORCED_STOP=true
                  STOP_REASON="same_error_repeated_${SAME_ERROR_COUNT}_times"

                  # å¼·åˆ¶åœæ­¢ã®çŠ¶æ…‹ã‚’è¨˜éŒ²
                  NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
                  jq --arg hash "$CURRENT_ERROR_HASH" \
                     --argjson count "$SAME_ERROR_COUNT" \
                     --arg reason "$STOP_REASON" \
                     --arg now "$NOW" \
                     --argjson attempts "$ATTEMPT" \
                     '.retry.need_retry = false |
                      .retry.last_run_result = "forced_stop" |
                      .loop.attempts_used = $attempts |
                      .error_tracking.last_error_hash = $hash |
                      .error_tracking.same_error_count = $count |
                      .stop.forced = true |
                      .stop.reason = $reason |
                      .timestamps.last_failed_at = $now' \
                     $STATE_FILE > $STATE_FILE.tmp
                  mv $STATE_FILE.tmp $STATE_FILE

                  echo "forced_stop=true" >> $GITHUB_OUTPUT
                  echo "stop_reason=$STOP_REASON" >> $GITHUB_OUTPUT
                  echo "error_hash=$CURRENT_ERROR_HASH" >> $GITHUB_OUTPUT
                  echo "last_error<<EOF" >> $GITHUB_OUTPUT
                  echo "$LAST_ERROR" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT

                  break
                fi
              else
                echo "âœ“ æ–°ã—ã„ã‚¨ãƒ©ãƒ¼ã§ã™ï¼ˆå‰å›žã¨ç•°ãªã‚‹ï¼‰"
                SAME_ERROR_COUNT=0
              fi

              # ç¾åœ¨ã®ãƒãƒƒã‚·ãƒ¥ã‚’ä¿å­˜
              LAST_ERROR_HASH="$CURRENT_ERROR_HASH"
            fi

            # ========================================
            # ã‚¹ãƒ†ãƒƒãƒ—3: ClaudeCodeã§ä¿®å¾©
            # ========================================
            echo ""
            echo "ðŸ¤– [3/4] ClaudeCode ã«ã‚ˆã‚‹è‡ªå‹•ä¿®å¾©ã‚’å®Ÿè¡Œä¸­..."
            echo "ðŸ“‹ repair.md ãŠã‚ˆã³ CLAUDE.md ã®ãƒ«ãƒ¼ãƒ«ã«å¾“ã£ã¦ä¿®å¾©ã—ã¾ã™"

            # âš ï¸ æ³¨æ„: å®Ÿéš›ã®ClaudeCode CLIå‘¼ã³å‡ºã—ï¼ˆå°†æ¥å®Ÿè£…ï¼‰
            # export TEST_OUTPUT=test-output.log
            # export ATTEMPT_NUMBER=$ATTEMPT
            # export MAX_ATTEMPTS=$MAX_ATTEMPTS
            # claude run .github/auto-repair/repair.md

            # ç¾æ™‚ç‚¹ã§ã¯ç°¡æ˜“çš„ãªè‡ªå‹•ä¿®æ­£
            echo "  ðŸ”§ ESLintè‡ªå‹•ä¿®æ­£..."
            npm run lint:fix 2>&1 || true

            echo "  ðŸ”§ Prettierè‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ..."
            npm run format 2>&1 || true

            # å¤‰æ›´ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ï¼ˆã‚³ãƒŸãƒƒãƒˆã¯PRä½œæˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«ä»»ã›ã‚‹ï¼‰
            # âš ï¸ P0 #12å¯¾å¿œ: mainã¸ã®ç›´æŽ¥ã‚³ãƒŸãƒƒãƒˆã‚’å»ƒæ­¢
            # ã™ã¹ã¦ã®å¤‰æ›´ã¯ peter-evans/create-pull-request ã§
            # PRã¨ã—ã¦ä½œæˆã•ã‚Œã€ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾Œã«ãƒžãƒ¼ã‚¸ã•ã‚Œã‚‹
            git add -A
            if ! git diff --cached --quiet; then
              echo "  âœ“ å¤‰æ›´ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã—ã¾ã—ãŸ"
              echo "  ðŸ“‹ PRã§ä¸€æ‹¬ã‚³ãƒŸãƒƒãƒˆã•ã‚Œã¾ã™ï¼ˆç›´æŽ¥ãƒ—ãƒƒã‚·ãƒ¥ãªã—ï¼‰"
            else
              echo "  âš ï¸  è‡ªå‹•ä¿®æ­£ã«ã‚ˆã‚‹å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
            fi

            # ========================================
            # ã‚¹ãƒ†ãƒƒãƒ—4: çŸ­ã„å¾…æ©Ÿ
            # ========================================
            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              echo "â³ æ¬¡ã®è©¦è¡Œã¾ã§5ç§’å¾…æ©Ÿ..."
              sleep 5
            fi
          done

          # ========================================
          # æœ€çµ‚çµæžœã‚’å‡ºåŠ›å¤‰æ•°ã«è¨­å®š
          # ========================================
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if [ "$FORCED_STOP" = "true" ]; then
            echo "ðŸ›‘ å¼·åˆ¶åœæ­¢ï¼ˆåŒä¸€ã‚¨ãƒ©ãƒ¼é€£ç¶šæ¤œçŸ¥ï¼‰"
            echo "success=false" >> $GITHUB_OUTPUT
            echo "attempts=$ATTEMPT" >> $GITHUB_OUTPUT
            echo "forced_stop=true" >> $GITHUB_OUTPUT
            echo "stop_reason=$STOP_REASON" >> $GITHUB_OUTPUT

          elif [ "$SUCCESS" = "true" ]; then
            echo "âœ… ä¿®å¾©ãƒ«ãƒ¼ãƒ—æˆåŠŸï¼ˆè©¦è¡Œå›žæ•°: $ATTEMPTï¼‰"
            echo "success=true" >> $GITHUB_OUTPUT
            echo "attempts=$ATTEMPT" >> $GITHUB_OUTPUT
            echo "forced_stop=false" >> $GITHUB_OUTPUT

          else
            echo "âŒ ä¿®å¾©ãƒ«ãƒ¼ãƒ—å¤±æ•—ï¼ˆæœ€å¤§è©¦è¡Œå›žæ•°ã«åˆ°é”ï¼‰"
            echo "success=false" >> $GITHUB_OUTPUT
            echo "attempts=$ATTEMPT" >> $GITHUB_OUTPUT
            echo "forced_stop=false" >> $GITHUB_OUTPUT

            # é€šå¸¸å¤±æ•—æ™‚ã®çŠ¶æ…‹æ›´æ–°
            NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            FIRST_FAILED=$(jq -r '.timestamps.first_failed_at' $STATE_FILE)
            if [ "$FIRST_FAILED" = "null" ]; then
              FIRST_FAILED="$NOW"
            fi

            jq --arg now "$NOW" \
               --arg first "$FIRST_FAILED" \
               --argjson attempts "$ATTEMPT" \
               --arg hash "$CURRENT_ERROR_HASH" \
               --argjson same_count "$SAME_ERROR_COUNT" \
               '.retry.need_retry = true |
                .retry.last_run_result = "test_failed" |
                .retry.last_failure_type = "unit_test" |
                .loop.attempts_used = $attempts |
                .error_tracking.last_error_hash = $hash |
                .error_tracking.same_error_count = $same_count |
                .timestamps.first_failed_at = $first |
                .timestamps.last_failed_at = $now' \
               $STATE_FILE > $STATE_FILE.tmp
            mv $STATE_FILE.tmp $STATE_FILE
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Runå›žæ•°ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
        if: always()
        run: |
          echo "ðŸ“Š Runå›žæ•°ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆä¸­..."
          jq '.retry.current_run += 1' $STATE_FILE > $STATE_FILE.tmp
          mv $STATE_FILE.tmp $STATE_FILE

          NEW_RUN=$(jq -r '.retry.current_run' $STATE_FILE)
          echo "ç¾åœ¨ã®Runå›žæ•°: $NEW_RUN"

      - name: ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆï¼ˆä¿®æ­£å†…å®¹ + state.jsonï¼‰
        if: always()
        uses: peter-evans/create-pull-request@v5
        id: create_pr
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            fix(auto): è‡ªå‹•ä¿®å¾© (è©¦è¡Œ ${{ steps.repair-loop.outputs.attempts }})

            - ESLintè‡ªå‹•ä¿®æ­£
            - Prettierè‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ
            - state.jsonæ›´æ–°
          branch: auto-repair/fix-${{ github.run_id }}
          delete-branch: true
          title: 'ðŸ¤– è‡ªå‹•ä¿®å¾©: ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼ã®ä¿®æ­£ (Run #${{ needs.check-state.outputs.current_run }})'
          body: |
            ## ðŸ¤– è‡ªå‹•ä¿®å¾©ãƒ¬ãƒãƒ¼ãƒˆ

            ã“ã®PRã¯è‡ªå‹•ã‚¨ãƒ©ãƒ¼ä¿®å¾©ãƒ«ãƒ¼ãƒ—ã«ã‚ˆã‚Šç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚

            ### ä¿®å¾©å†…å®¹
            - **è©¦è¡Œå›žæ•°**: ${{ steps.repair-loop.outputs.attempts }}å›ž
            - **Run ID**: ${{ github.run_id }}
            - **Runç•ªå·**: #${{ needs.check-state.outputs.current_run }}
            - **çµæžœ**: ${{ steps.repair-loop.outputs.success == 'true' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }}
            - **å¼·åˆ¶åœæ­¢**: ${{ steps.repair-loop.outputs.forced_stop == 'true' && 'ðŸ›‘ ã¯ã„' || 'ã„ã„ãˆ' }}

            ### å¤‰æ›´å†…å®¹
            - ESLintè‡ªå‹•ä¿®æ­£
            - Prettierè‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ
            - state.jsonæ›´æ–°
            ${{ steps.repair-loop.outputs.success == 'true' && '- ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼å¯¾å¿œ' || '' }}

            ### æ¤œè¨¼çµæžœ
            ${{ steps.repair-loop.outputs.success == 'true' && '- âœ… ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸ' || '- âš ï¸ ãƒ†ã‚¹ãƒˆã¯å¼•ãç¶šãå¤±æ•—ã—ã¦ã„ã¾ã™' }}

            ### ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¾é ¼
            è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸä¿®æ­£å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
            ${{ steps.repair-loop.outputs.success == 'true' && 'å•é¡ŒãŒãªã‘ã‚Œã°ãƒžãƒ¼ã‚¸ã—ã¦ãã ã•ã„ã€‚' || 'state.jsonã®æ›´æ–°ã®ã¿ãŒå«ã¾ã‚Œã¾ã™ã€‚' }}

            ---
            ðŸ“‹ **ãƒ«ãƒ¼ãƒ«éµå®ˆ**: CLAUDE.md + repair.md ã«åŸºã¥ã„ã¦ä¿®å¾©
          labels: |
            auto-repair
            automated-pr
            ${{ steps.repair-loop.outputs.success == 'true' && 'ready-for-review' || 'needs-review' }}

      - name: å®Ÿè¡Œã‚µãƒžãƒªãƒ¼ã‚’ä½œæˆ
        if: always()
        run: |
          SUCCESS="${{ steps.repair-loop.outputs.success }}"
          FORCED_STOP="${{ steps.repair-loop.outputs.forced_stop }}"
          ATTEMPTS="${{ steps.repair-loop.outputs.attempts }}"
          CURRENT_RUN=$(jq -r '.retry.current_run' $STATE_FILE)
          MAX_RUNS=$(jq -r '.retry.max_runs' $STATE_FILE)

          echo "## ðŸ¤– è‡ªå‹•ã‚¨ãƒ©ãƒ¼ä¿®å¾©ãƒ«ãƒ¼ãƒ— å®Ÿè¡Œçµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$FORCED_STOP" = "true" ]; then
            echo "### ðŸ›‘ å¼·åˆ¶åœæ­¢ï¼ˆåŒä¸€ã‚¨ãƒ©ãƒ¼é€£ç¶šæ¤œçŸ¥ï¼‰" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **è©¦è¡Œå›žæ•°**: $ATTEMPTS å›ž" >> $GITHUB_STEP_SUMMARY
            echo "- **Runç•ªå·**: #$CURRENT_RUN / $MAX_RUNS" >> $GITHUB_STEP_SUMMARY
            echo "- **åœæ­¢ç†ç”±**: ${{ steps.repair-loop.outputs.stop_reason }}" >> $GITHUB_STEP_SUMMARY
            echo "- **çŠ¶æ…‹**: äººé–“ã«ã‚ˆã‚‹å¯¾å¿œãŒå¿…è¦ã§ã™" >> $GITHUB_STEP_SUMMARY

          elif [ "$SUCCESS" = "true" ]; then
            echo "### âœ… ä¿®å¾©æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **è©¦è¡Œå›žæ•°**: $ATTEMPTS å›ž" >> $GITHUB_STEP_SUMMARY
            echo "- **Runç•ªå·**: #$CURRENT_RUN / $MAX_RUNS" >> $GITHUB_STEP_SUMMARY
            echo "- **çµæžœ**: ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸ" >> $GITHUB_STEP_SUMMARY

          else
            echo "### âŒ ä¿®å¾©å¤±æ•—ï¼ˆæœ€å¤§è©¦è¡Œå›žæ•°ã«åˆ°é”ï¼‰" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **è©¦è¡Œå›žæ•°**: $ATTEMPTS å›žï¼ˆæœ€å¤§ï¼‰" >> $GITHUB_STEP_SUMMARY
            echo "- **Runç•ªå·**: #$CURRENT_RUN / $MAX_RUNS" >> $GITHUB_STEP_SUMMARY
            echo "- **æ¬¡å›ž**: 30åˆ†å¾Œã«è‡ªå‹•å†å®Ÿè¡Œäºˆå®š" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‹ **ãƒ«ãƒ¼ãƒ«éµå®ˆ**: CLAUDE.md + repair.md ã«åŸºã¥ã„ã¦ä¿®å¾©" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“– **ä»•æ§˜ä¿è­·**: README.md ã¯å¤‰æ›´ã•ã‚Œã¦ã„ã¾ã›ã‚“" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¾ **çŠ¶æ…‹ç®¡ç†**: state.json v1.1" >> $GITHUB_STEP_SUMMARY

      - name: ç¾åœ¨ã®çŠ¶æ…‹ã‚’è¡¨ç¤º
        if: always()
        run: |
          echo "ðŸ“Š ç¾åœ¨ã®state.json:"
          cat $STATE_FILE | jq .

  #####################################################################
  # Job 3: å¼·åˆ¶åœæ­¢æ™‚ã®Issueé€šçŸ¥
  #####################################################################
  notify-stop:
    name: å¼·åˆ¶åœæ­¢é€šçŸ¥ï¼ˆäººé–“ã¸ã®ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: auto-repair
    if: needs.auto-repair.outputs.forced_stop == 'true'

    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: state.jsonã‚’èª­ã¿è¾¼ã¿
        id: load_state
        run: |
          SAME_ERROR_COUNT=$(jq -r '.error_tracking.same_error_count' $STATE_FILE)
          STOP_REASON=$(jq -r '.stop.reason' $STATE_FILE)
          LAST_FAILED=$(jq -r '.timestamps.last_failed_at' $STATE_FILE)
          CURRENT_RUN=$(jq -r '.retry.current_run' $STATE_FILE)

          echo "same_error_count=$SAME_ERROR_COUNT" >> $GITHUB_OUTPUT
          echo "stop_reason=$STOP_REASON" >> $GITHUB_OUTPUT
          echo "last_failed=$LAST_FAILED" >> $GITHUB_OUTPUT
          echo "current_run=$CURRENT_RUN" >> $GITHUB_OUTPUT

      - name: Issueã‚’ä½œæˆã¾ãŸã¯æ—¢å­˜Issueã«ã‚³ãƒ¡ãƒ³ãƒˆ
        env:
          SAME_ERROR_COUNT: ${{ steps.load_state.outputs.same_error_count }}
          STOP_REASON: ${{ steps.load_state.outputs.stop_reason }}
          ATTEMPTS: ${{ needs.auto-repair.outputs.attempts }}
          CURRENT_RUN: ${{ steps.load_state.outputs.current_run }}
          LAST_FAILED: ${{ steps.load_state.outputs.last_failed }}
          RUN_ID: ${{ github.run_id }}
        uses: actions/github-script@v7
        with:
          script: |
            const sameErrorCount = process.env.SAME_ERROR_COUNT;
            const stopReason = process.env.STOP_REASON;
            const attempts = process.env.ATTEMPTS;
            const currentRun = process.env.CURRENT_RUN;
            const lastFailed = process.env.LAST_FAILED;
            const runId = process.env.RUN_ID;

            const body = '## ðŸš¨ è‡ªå‹•ä¿®å¾©ã‚’å¼·åˆ¶åœæ­¢ã—ã¾ã—ãŸ\n\n' +
              '### åœæ­¢ç†ç”±\n' +
              'åŒä¸€ã‚¨ãƒ©ãƒ¼ãŒ **' + sameErrorCount + 'å›ž** é€£ç¶šã§ç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\n' +
              '### è©³ç´°æƒ…å ±\n' +
              '- **Runç•ªå·**: #' + currentRun + '\n' +
              '- **è©¦è¡Œå›žæ•°**: ' + attempts + 'å›ž\n' +
              '- **åœæ­¢ç†ç”±ã‚³ãƒ¼ãƒ‰**: `' + stopReason + '`\n' +
              '- **ç™ºç”Ÿæ—¥æ™‚**: ' + lastFailed + '\n\n' +
              '### æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³\n' +
              '**äººé–“ã«ã‚ˆã‚‹å¯¾å¿œãŒå¿…è¦ã§ã™**\n\n' +
              '1. ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„\n' +
              '2. æ ¹æœ¬åŽŸå› ã‚’ç‰¹å®šã—ã¦ãã ã•ã„\n' +
              '3. æ‰‹å‹•ã§ä¿®æ­£ã—ã¦ãã ã•ã„\n' +
              '4. ä¿®æ­£å¾Œã€`state.json`ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„\n\n' +
              '### state.jsonãƒªã‚»ãƒƒãƒˆæ–¹æ³•\n' +
              '```bash\n' +
              '# å¼·åˆ¶åœæ­¢ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢\n' +
              'jq \'.stop.forced = false | .stop.reason = null | .error_tracking.same_error_count = 0\' \\\n' +
              '  .github/auto-repair/state.json > tmp.json\n' +
              'mv tmp.json .github/auto-repair/state.json\n' +
              'git add .github/auto-repair/state.json\n' +
              'git commit -m "chore: state.jsonã‚’ãƒªã‚»ãƒƒãƒˆ"\n' +
              'git push\n' +
              '```\n\n' +
              '### å‚è€ƒãƒªãƒ³ã‚¯\n' +
              '- [Workflowå®Ÿè¡Œå±¥æ­´](https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/actions/runs/' + runId + ')\n' +
              '- [state.json v1.1 ã‚¹ã‚­ãƒ¼ãƒž](https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/blob/main/Docs/state.json-schema-v1.0.md)\n\n' +
              '---\n' +
              'ðŸ¤– ã“ã®é€šçŸ¥ã¯è‡ªå‹•ã‚¨ãƒ©ãƒ¼ä¿®å¾©ãƒ«ãƒ¼ãƒ—ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ';

            // æ—¢å­˜ã®Issueã‚’æ¤œç´¢ï¼ˆauto-repair-stoppedãƒ©ãƒ™ãƒ«ä»˜ãï¼‰
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'auto-repair-stopped',
              state: 'open',
            });

            if (issues.data.length > 0) {
              // æ—¢å­˜Issueã«ã‚³ãƒ¡ãƒ³ãƒˆ
              const issue = issues.data[0];
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: body
              });
              console.log(`æ—¢å­˜Issue #${issue.number} ã«ã‚³ãƒ¡ãƒ³ãƒˆã—ã¾ã—ãŸ`);
            } else {
              // æ–°è¦Issueã‚’ä½œæˆ
              const newIssue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸš¨ è‡ªå‹•ä¿®å¾©ãŒå¼·åˆ¶åœæ­¢ã•ã‚Œã¾ã—ãŸï¼ˆåŒä¸€ã‚¨ãƒ©ãƒ¼é€£ç¶šæ¤œçŸ¥ï¼‰',
                body: body,
                labels: ['auto-repair-stopped', 'needs-human-review']
              });
              console.log(`æ–°è¦Issue #${newIssue.data.number} ã‚’ä½œæˆã—ã¾ã—ãŸ`);
            }

  #####################################################################
  # Job 4: æœ€çµ‚æ¤œè¨¼ï¼ˆæˆåŠŸæ™‚ã®ã¿ï¼‰
  #####################################################################
  final-verification:
    name: æœ€çµ‚æ¤œè¨¼ï¼ˆä¿®å¾©å†…å®¹ã®æ¤œè¨¼ï¼‰
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: auto-repair
    if: needs.auto-repair.outputs.success == 'true'

    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Node.jsã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      - name: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
        run: npm run migrate:latest

      - name: å…¨ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
        run: |
          echo "ðŸ” æœ€çµ‚æ¤œè¨¼ã‚’é–‹å§‹ã—ã¾ã™..."
          echo ""

          echo "[1/4] ESLintãƒã‚§ãƒƒã‚¯..."
          npm run lint
          echo "âœ… ESLint OK"
          echo ""

          echo "[2/4] Prettierãƒã‚§ãƒƒã‚¯..."
          npm run format:check
          echo "âœ… Prettier OK"
          echo ""

          echo "[3/4] å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ..."
          npm test
          echo "âœ… Tests OK"
          echo ""

          echo "[4/4] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯..."
          npm audit --audit-level=moderate || echo "âš ï¸ ä¸€éƒ¨ã®è„†å¼±æ€§ãŒæ®‹ã£ã¦ã„ã¾ã™"
          echo ""

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… ã™ã¹ã¦ã®æ¤œè¨¼ãŒæˆåŠŸã—ã¾ã—ãŸï¼"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: æ¤œè¨¼çµæžœã‚’ã‚µãƒžãƒªãƒ¼ã«è¿½åŠ 
        if: success()
        run: |
          echo "## âœ… æœ€çµ‚æ¤œè¨¼å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã—ã¾ã—ãŸï¼š" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ESLint" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Prettier" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Tests" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Security Audit" >> $GITHUB_STEP_SUMMARY
