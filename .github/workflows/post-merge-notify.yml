# å¾€å¾©é–‹ç™ºãƒ«ãƒ¼ãƒ— - ãƒãƒ¼ã‚¸å¾Œã® ClaudeCode ä½œæ¥­é€šçŸ¥
#
# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ã€PR ãŒ main ãƒ–ãƒ©ãƒ³ãƒã«ãƒãƒ¼ã‚¸ã•ã‚ŒãŸå¾Œã«è‡ªå‹•å®Ÿè¡Œã•ã‚Œã€
# ClaudeCode ã«ã‚ˆã‚‹ç²¾ç·»åŒ–ä½œæ¥­ç”¨ã® Issue ã‚’è‡ªå‹•ä½œæˆã—ã¾ã™ã€‚

name: ğŸ”„ å¾€å¾©é–‹ç™ºãƒ«ãƒ¼ãƒ— - ãƒãƒ¼ã‚¸å¾Œé€šçŸ¥

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PRç•ªå·ï¼ˆæ‰‹å‹•å®Ÿè¡Œæ™‚ï¼‰'
        required: false
        type: string

permissions:
  contents: read
  issues: write
  pull-requests: read

jobs:
  create-refinement-issue:
    name: ğŸ“‹ ç²¾ç·»åŒ–ä½œæ¥­ç”¨Issueä½œæˆ
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ğŸ” ãƒãƒ¼ã‚¸ã•ã‚ŒãŸPRæƒ…å ±ã‚’å–å¾—
        id: pr_info
        uses: actions/github-script@v7
        with:
          script: |
            let prNumber, prTitle, prAuthor, prUrl;

            if (context.eventName === 'workflow_dispatch' && context.payload.inputs.pr_number) {
              prNumber = context.payload.inputs.pr_number;
              const pr = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: parseInt(prNumber)
              });
              prTitle = pr.data.title;
              prAuthor = pr.data.user.login;
              prUrl = pr.data.html_url;
            } else {
              const commit = context.payload.head_commit;
              const commitMessage = commit.message;
              const prMatch = commitMessage.match(/#(\d+)/);

              if (!prMatch) {
                console.log('ãƒãƒ¼ã‚¸ã‚³ãƒŸãƒƒãƒˆã§ã¯ãªã„ãŸã‚ã‚¹ã‚­ãƒƒãƒ—');
                core.setOutput('skip', 'true');
                return;
              }

              prNumber = prMatch[1];
              const pr = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: parseInt(prNumber)
              });
              prTitle = pr.data.title;
              prAuthor = pr.data.user.login;
              prUrl = pr.data.html_url;
            }

            core.setOutput('pr_number', prNumber);
            core.setOutput('pr_title', prTitle);
            core.setOutput('pr_author', prAuthor);
            core.setOutput('pr_url', prUrl);
            core.setOutput('skip', 'false');

      - name: ğŸ“‚ å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’å–å¾—
        if: steps.pr_info.outputs.skip != 'true'
        id: changed_files
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr_info.outputs.pr_number }};
            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            const changedFiles = files.data.map(file => {
              const status = file.status === 'added' ? 'ğŸ†•' :
                            file.status === 'modified' ? 'âœï¸' :
                            file.status === 'removed' ? 'ğŸ—‘ï¸' : 'â“';
              return status + ' ' + file.filename + ' (+' + file.additions + '/-' + file.deletions + ')';
            }).join('\\n');

            core.setOutput('changed_files', changedFiles);

      - name: ğŸ“ ç²¾ç·»åŒ–ä½œæ¥­ç”¨Issueã‚’ä½œæˆ
        if: steps.pr_info.outputs.skip != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = '${{ steps.pr_info.outputs.pr_number }}';
            const prTitle = '${{ steps.pr_info.outputs.pr_title }}';
            const prAuthor = '${{ steps.pr_info.outputs.pr_author }}';
            const prUrl = '${{ steps.pr_info.outputs.pr_url }}';
            const changedFiles = '${{ steps.changed_files.outputs.changed_files }}';
            const mergeDate = new Date().toISOString().split('T')[0];

            const issueTitle = 'ğŸ”„ ç²¾ç·»åŒ–ä½œæ¥­: ' + prTitle + ' (PR #' + prNumber + ')';

            // Issue body ã‚’æ–‡å­—åˆ—é€£çµã§æ§‹ç¯‰
            let body = '## ğŸ“‹ å¾€å¾©é–‹ç™ºãƒ«ãƒ¼ãƒ— - ClaudeCode ç²¾ç·»åŒ–ä½œæ¥­\n\n';
            body += 'ã“ã®Issueã¯ã€PR #' + prNumber + ' ãŒ main ãƒ–ãƒ©ãƒ³ãƒã«ãƒãƒ¼ã‚¸ã•ã‚ŒãŸå¾Œã€å“è³ªã‚’ã•ã‚‰ã«å‘ä¸Šã•ã›ã‚‹ãŸã‚ã®ä½œæ¥­ãƒªã‚¹ãƒˆã§ã™ã€‚\n\n';
            body += '---\n\n';
            body += '### ğŸ“Œ å…ƒã®PRæƒ…å ±\n\n';
            body += '| é …ç›® | å†…å®¹ |\n|------|------|\n';
            body += '| **PRç•ªå·** | [#' + prNumber + '](' + prUrl + ') |\n';
            body += '| **ã‚¿ã‚¤ãƒˆãƒ«** | ' + prTitle + ' |\n';
            body += '| **ä½œæˆè€…** | @' + prAuthor + ' |\n';
            body += '| **ãƒãƒ¼ã‚¸æ—¥æ™‚** | ' + mergeDate + ' |\n\n';
            body += '---\n\n';
            body += '### ğŸ“‚ å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§\n\n';
            body += (changedFiles || 'ï¼ˆå¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ãªã—ï¼‰') + '\n\n';
            body += '---\n\n';
            body += '### âœ… ç²¾ç·»åŒ–ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ\n\n';
            body += '#### ãƒ•ã‚§ãƒ¼ã‚º1: åˆæœŸãƒ¬ãƒ“ãƒ¥ãƒ¼\n';
            body += '- [ ] ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼\n';
            body += '- [ ] ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ç¢ºèª\n\n';
            body += '#### ãƒ•ã‚§ãƒ¼ã‚º2: ãƒ†ã‚¹ãƒˆå¼·åŒ–\n';
            body += '- [ ] ã‚«ãƒãƒ¬ãƒƒã‚¸80%ä»¥ä¸Š\n\n';
            body += '#### ãƒ•ã‚§ãƒ¼ã‚º3: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼\n';
            body += '- [ ] å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³\n\n';
            body += '#### ãƒ•ã‚§ãƒ¼ã‚º4: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–\n';
            body += '- [ ] N+1ã‚¯ã‚¨ãƒªæ’é™¤\n\n';
            body += '#### ãƒ•ã‚§ãƒ¼ã‚º5: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™\n';
            body += '- [ ] ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ \n\n';
            body += '#### ãƒ•ã‚§ãƒ¼ã‚º6: ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°\n';
            body += '- [ ] DRYåŸå‰‡\n\n';
            body += '---\n\n';
            body += '### ğŸ›‘ åœæ­¢æ¡ä»¶\n\n';
            body += '- [ ] ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ 80%ä»¥ä¸Š\n';
            body += '- [ ] Lint ã‚¨ãƒ©ãƒ¼ 0ä»¶\n\n';
            body += '---\n\n';
            body += '**è‡ªå‹•ç”Ÿæˆ**: ' + new Date().toISOString();

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: body,
              labels: ['refinement', 'claude-code']
            });

            console.log('Issueä½œæˆå®Œäº†: ' + issue.data.html_url);
            core.setOutput('issue_url', issue.data.html_url);
