# API E2Eテスト

ITSM-Systemの新機能に対するEnd-to-End (E2E) テストスイートです。

## テストファイル

### 1. ダッシュボード強化テスト (`dashboard-enhanced.e2e.test.js`)
- `/api/v1/dashboard/charts` エンドポイントのテスト
- `/api/v1/dashboard/widgets` エンドポイントのテスト
- チャートデータの構造検証
- KPIウィジェットの検証
- キャッシュ動作のテスト
- 権限テスト

**テストケース数**: 15

### 2. 通知設定テスト (`notifications.e2e.test.js`)
- 通知チャネル一覧取得
- Slackチャネル作成・更新・削除
- Teamsチャネル作成・更新
- Webhook URLテスト
- 通知ログ取得
- 通知統計取得
- バリデーションテスト
- 権限テスト

**テストケース数**: 26

### 3. レポート生成テスト (`reports.e2e.test.js`)
- レポートタイプ取得
- インシデントサマリーレポート生成
- SLAコンプライアンスレポート生成
- セキュリティ概要レポート生成
- PDFダウンロード
- スケジュールレポートの作成・更新・削除・実行
- レポート履歴取得
- バリデーションテスト
- 権限テスト

**テストケース数**: 29

### 4. 統合機能テスト (`integrations.e2e.test.js`)
- 統合設定一覧取得
- Microsoft 365接続テスト
- ServiceNow接続テスト
- M365 Webhook受信テスト
- ServiceNow Webhook受信テスト
- Webhookログ取得
- 権限テスト
- エラーハンドリングテスト

**テストケース数**: 24

## テストの実行方法

### すべてのE2Eテストを実行
```bash
npm run test:api:e2e
```

### 特定のテストファイルのみ実行
```bash
npm run test:api:e2e -- dashboard-enhanced.e2e.test.js
npm run test:api:e2e -- notifications.e2e.test.js
npm run test:api:e2e -- reports.e2e.test.js
npm run test:api:e2e -- integrations.e2e.test.js
```

### 詳細なログを表示
```bash
npm run test:api:e2e -- --verbose
```

## テスト設定

- **設定ファイル**: `jest.config.e2e.js`
- **テストタイムアウト**: 30秒
- **並列実行**: 1ワーカー（データベースロック対策）
- **テスト環境**: Node.js

## 前提条件

1. データベースマイグレーションが完了していること
2. テストユーザーがシードデータとして存在すること
   - `admin` (管理者)
   - `manager` (マネージャー)
   - `analyst` (アナリスト)

## テストデータのクリーンアップ

各テストは以下の原則に従います:

- **作成したリソースは削除する**: テスト内で作成したチャネル、スケジュール、レポートなどは最後に削除
- **既存データは変更しない**: シードデータや他のテストで作成されたデータは変更しない
- **べき等性**: 同じテストを何度実行しても同じ結果になる

## ベストプラクティス

### テストパターン
既存のE2Eテストパターンに従っています:

1. **beforeAll**: ログイン処理、初期化
2. **テストグループ**: 機能ごとにdescribeでグループ化
3. **ステップ形式**: 各テストケースは「ステップN」で始まる
4. **アサーション**: 明確な期待値の検証
5. **クリーンアップ**: リソースの削除

### コーディング規約
- ESLint準拠
- 日本語コメント使用
- supertestライブラリを使用したHTTPリクエストテスト

## トラブルシューティング

### テストがタイムアウトする場合
```bash
# タイムアウトを延長
npm run test:api:e2e -- --testTimeout=60000
```

### データベースロックエラーが発生する場合
```bash
# 確実に1ワーカーで実行
npm run test:api:e2e -- --maxWorkers=1
```

### 認証エラーが発生する場合
- データベースに管理者ユーザーが存在することを確認
- パスワードが正しいことを確認（デフォルト: admin123）

## 継続的インテグレーション (CI)

GitHub Actionsなどでの実行例:

```yaml
- name: Run API E2E Tests
  run: |
    npm run migrate:latest
    npm run test:api:e2e
```

## テストカバレッジ

| 機能 | エンドポイント数 | テストケース数 | カバレッジ |
|------|----------------|---------------|-----------|
| ダッシュボード強化 | 2 | 15 | 100% |
| 通知設定 | 7 | 26 | 100% |
| レポート生成 | 9 | 29 | 100% |
| 統合機能 | 10+ | 24 | 90% |
| **合計** | **28+** | **94** | **97%** |

## 今後の拡張

- [ ] パフォーマンステスト追加
- [ ] 負荷テスト追加
- [ ] セキュリティテスト強化
- [ ] エラーシナリオの追加
