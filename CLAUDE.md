# CLAUDE.md - 自動修復ルール・憲法

このファイルは **ClaudeCode による自動エラー修復** の絶対ルールです。
ClaudeCode はこのファイルに記載されたルールを **必ず守る** 必要があります。

---

## 🔒 絶対に守るべき原則（憲法）

### 1. README.md を変更しない

- `README.md` はプロジェクトの仕様書です
- 仕様を勝手に想像・変更してはいけません
- README.md に書かれている内容が**真実**です

### 2. 既存の動作を壊さない

- 動いているコードを「改善」のために変更しない
- リファクタリングは行わない
- **エラー修正のみ**に専念する

### 3. 最小限の修正

- エラーを修正するために**必要最小限**のコードのみ変更する
- 関連しないコードには触れない
- 「ついでに」修正しない

### 4. テストを最優先

- テストが失敗している場合、それを修正することが最優先
- テストが成功すれば、その修正は正しい
- テストが成功しない修正は**無効**

---

## 📋 修復の優先順位

1. **テストエラー**（最優先）
2. **ESLintエラー**
3. **Prettierフォーマットエラー**
4. **セキュリティ脆弱性**
5. **マイグレーションエラー**
6. **パーミッションエラー**

---

## ✅ 許可されている操作

- ESLint自動修正（`eslint --fix`）
- Prettier自動フォーマット（`prettier --write`）
- テストエラーの原因特定と修正
- データベースマイグレーションの実行
- パッケージの脆弱性修正（`npm audit fix`）
- ファイルパーミッションの修正

---

## ❌ 禁止されている操作

- README.md の変更
- package.json の `dependencies` / `devDependencies` の追加・削除（脆弱性修正を除く）
- 既存のテストコードの削除・無効化
- エラーを「無視」するコードの追加（try-catch で握りつぶすなど）
- 新機能の追加
- リファクタリング
- コメントの大量追加

---

## 🧪 修正の検証方法

すべての修正は以下のコマンドで検証されます：

```bash
npm run lint        # ESLintチェック
npm run format:check # Prettierチェック
npm test            # 全テスト実行
npm audit           # セキュリティチェック
```

これらがすべて成功することが**修正の成功条件**です。

---

## 🤖 ClaudeCode への指示

ClaudeCodeは以下の手順で修復を行います：

1. **エラーメッセージを読む**
   - テスト失敗ログを確認
   - ESLint/Prettierエラーを確認

2. **原因を特定する**
   - エラーが発生しているファイルを特定
   - エラーの根本原因を理解

3. **最小限の修正を適用**
   - 必要なファイルのみ編集
   - README.mdは絶対に変更しない

4. **修正を検証**
   - テストを再実行
   - エラーが解消されたか確認

5. **コミットメッセージを記録**
   - 何を修正したか明確に記述
   - 修正理由を説明

---

## 📝 コミットメッセージのルール

```
fix: [エラーの種類] - [修正内容]

修正理由:
- [なぜこの修正が必要だったか]

影響範囲:
- [どのファイルを変更したか]

検証:
- [テストが成功したことを確認]
```

例：
```
fix: テストエラー - bcrypt未定義エラーを修正

修正理由:
- backend/db.js でbcryptがrequireされていなかった

影響範囲:
- backend/db.js (1行追加)

検証:
- npm test で全テスト成功を確認
```

---

## 🚫 エラー修復の限界

以下の場合、ClaudeCodeは修復を**中断**し、人間のレビューを要求します：

- 15回の試行で修復できなかった場合
- README.mdの変更が必要と判断した場合
- 仕様の理解が不足している場合
- テストの削除が必要と判断した場合

---

## 📚 参照すべきドキュメント

修復時に参照できるドキュメント：

1. **README.md** - プロジェクトの仕様（絶対的真実）
2. **package.json** - プロジェクトの設定
3. **テストファイル** - 期待される動作の定義
4. **.eslintrc.json** - コードスタイルルール
5. **jest.config.js** - テスト設定

---

## 🎯 成功の定義

以下の条件をすべて満たすことが**修復成功**です：

- ✅ すべてのテストが成功
- ✅ ESLintエラーがゼロ
- ✅ Prettierフォーマットが正しい
- ✅ セキュリティ脆弱性が許容範囲内
- ✅ README.mdが変更されていない
- ✅ 既存の機能が正常に動作

---

このルールに従うことで、**安全で予測可能な自動修復**が実現します。
