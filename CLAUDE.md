# CLAUDE.md - ITSM-Sec Nexus 開発ルール

## プロジェクト概要

ITSM-Sec Nexus は、ITサービス管理（ITSM）とセキュリティ管理を統合したWebアプリケーションです。
NIST Cybersecurity Framework (CSF) 2.0 に準拠した設計を採用しています。

## 技術スタック

- **Backend**: Node.js + Express.js
- **Database**: SQLite (better-sqlite3)
- **Frontend**: Vanilla JavaScript (SPA)
- **認証**: JWT + Refresh Token
- **API**: RESTful API (v1)

## ディレクトリ構成

```
ITSM-System/
├── backend/           # バックエンドソースコード
│   ├── routes/        # APIルート
│   ├── services/      # ビジネスロジック
│   ├── middleware/    # ミドルウェア
│   ├── migrations/    # DBマイグレーション
│   └── __tests__/     # テストコード
├── frontend/          # フロントエンドソースコード
├── Docs/              # ドキュメント
└── .github/           # GitHub Actions設定
```

## 開発ルール

### コーディング規約

1. **ESLint/Prettier**: コードは必ずフォーマットを適用
2. **命名規則**: camelCase（変数・関数）、PascalCase（クラス）
3. **コメント**: 複雑なロジックには日本語コメントを付与
4. **エラーハンドリング**: try-catchで適切にエラーを捕捉

### API設計

- **バージョニング**: `/api/v1/` プレフィックス必須
- **認証**: JWTトークンをAuthorizationヘッダーで送信
- **レスポンス形式**: JSON
- **エラーレスポンス**: `{ error: string, message: string }`

### セキュリティ

- **入力検証**: すべてのユーザー入力をバリデーション
- **SQLインジェクション防止**: プリペアドステートメント使用
- **XSS防止**: 出力のエスケープ処理
- **CSRF防止**: トークン検証

### テスト

- **ユニットテスト**: `backend/__tests__/unit/`
- **統合テスト**: `backend/__tests__/integration/`
- **E2Eテスト**: `backend/__tests__/e2e/`
- **カバレッジ目標**: 70%以上

## 禁止事項

1. **本番環境への直接デプロイ禁止**
2. **シークレット情報のハードコード禁止**
3. **未テストのコードのマージ禁止**
4. **README.mdの仕様に反する実装禁止**

## 動作モード

このプロジェクトでは、ClaudeCode の動作モードを以下の2つに明確に分けています。

### モード1: CI/CD自動修復モード

**目的**: GitHub Actions でテスト失敗時に自動的に修復する

**適用場面**:
- GitHub Actions の `auto-error-fix-continuous.yml` から起動
- テスト失敗、Lintエラー、セキュリティ脆弱性の自動修正
- 5分間隔の定期実行

**制約事項（厳守）**:
1. **仕様変更禁止**: README.mdに記載された仕様を変更しない
2. **最小限の修正**: テスト失敗に直接関係する箇所のみ修正
3. **新機能追加禁止**: バグ修正のみ許可
4. **依存関係追加禁止**: 新しいnpmパッケージを追加しない
5. **コミットメッセージ**: `fix(auto): [修正内容]` 形式

### モード2: 往復開発ループモード

**目的**: GitHub Copilot Agent の初期実装を ClaudeCode で精緻化し、品質を段階的に向上

**適用場面**:
- PR が main にマージされた後、`post-merge-notify.yml` により自動作成された Issue から起動
- 人間が手動で ClaudeCode を起動
- 品質向上、テスト強化、セキュリティ検証、パフォーマンス最適化、ドキュメント整備

**許可される作業（自動修復モードより広範囲）**:
1. ✅ **テスト追加・強化**: カバレッジ向上、エッジケース追加
2. ✅ **セキュリティ強化**: 脆弱性対策、入力検証強化
3. ✅ **パフォーマンス最適化**: N+1クエリ解消、キャッシュ導入
4. ✅ **ドキュメント整備**: コメント追加、README更新
5. ✅ **リファクタリング**: コードの可読性・保守性向上
6. ✅ **依存関係更新**: セキュリティパッチ適用（package.json更新可）

**制約事項（遵守）**:
1. **仕様変更禁止**: README.mdの仕様は変更しない（ドキュメント追記は可）
2. **既存機能の破壊禁止**: 既存のテストが通る状態を維持
3. **段階的改善**: 1回のPRで過剰な変更をしない（1フェーズずつ）
4. **コミットメッセージ**: Conventional Commits 形式
   - `feat:` 新機能追加
   - `fix:` バグ修正
   - `test:` テスト追加・修正
   - `refactor:` リファクタリング
   - `docs:` ドキュメント更新
   - `perf:` パフォーマンス改善
   - `chore:` その他の変更

**往復ループの流れ**:
1. **GitHub Copilot Agent** が初期実装 → PR作成
2. **GitHub Actions (CI)** で品質チェック
3. **人間** がレビュー・承認
4. **main へマージ**
5. **post-merge-notify.yml** が Issue 自動作成
6. **ClaudeCode（あなた）** が Issue のチェックリストに従い精緻化
7. 新しい PR 作成 → 2 へ戻る（必要に応じて繰り返し）

**停止条件（以下をすべて満たしたら完了）**:
- [ ] テストカバレッジ ≥ 80%
- [ ] Lint エラー 0件
- [ ] セキュリティ脆弱性 0件（高・中）
- [ ] パフォーマンス問題解決
- [ ] ドキュメント完備
- [ ] 新しい改善点が見つからない

→ この時点で Issue を「Close as completed」でクローズ

## 環境設定

- **開発環境**: ポート5443 (HTTPS)
- **本番環境**: ポート6443 (HTTPS)、ポート8080 (HTTP)
- **テスト環境**: NODE_ENV=test

### ポート構成（本番環境）

| プロトコル | ポート | 用途 |
|-----------|--------|------|
| HTTPS | 6443 | メインAPI（推奨） |
| HTTP | 8080 | 開発・デバッグ用 |

※ 本番環境ではHTTPS（6443）を使用してください。

## 更新履歴

### 2026-02-07
- 往復開発ループモード定義を追加
- 動作モードを明確化（CI/CD自動修復 vs 往復開発ループ）
- 停止条件の定義追加

### 2026-01-26
- 監査ログミドルウェアの`req.path`→`req.originalUrl`修正
- レースコンディション修正（`next()`の非同期対応）
- ユニットテストの非同期対応

## 連絡先

問題が発生した場合は、GitHubのIssueを作成してください。
