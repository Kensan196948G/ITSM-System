# Playwright導入前提 テストケース整理（ユーザー設定）

## 目的
- `webui-sample` のユーザー設定機能を Playwright で自動化する前提で、手動E2Eシナリオをテストケースへ分解する。
- UI機能・API永続化・バリデーション・監査ログ差分を網羅する。

## 前提条件
- `python3 api_server.py` が起動している
- 起動ログの自動割り当てIP（例: `http://192.168.0.185:8765`）にアクセス可能
- 初期データを既知状態へ戻す手段がある（`webui-sample/data/*.json` を初期化）
  - 推奨: `POST /api/test/reset` を利用

## テスト対象範囲
- ログイン（デモ）
- システム設定 > ユーザー設定
- ユーザー一覧（検索/フィルタ/ソート/ページネーション）
- ユーザーCRUD（新規/編集/削除）
- ロール権限マトリクス（scope + 権限チェック）
- 監査ログ（UI表示 + `before/after` 記録）

## 推奨テストデータ
- 作成用ユーザーID: `pw.qa.user`
- 更新用表示名: `PW QA User Updated`
- 更新後ロール: `SecOps`
- 不正メール: `badmail`
- 不正ユーザーID: `a*`

## テストケース一覧

### A. 画面遷移・初期表示
- A01: ログイン後に `システム設定` を開ける
- A02: ユーザー設定テーブル・フィルタ・ページネーションが表示される
- A03: ロール権限マトリクスに `閲覧範囲 (scope)` 編集UIが表示される

### B. 検索・フィルタ・ソート・ページネーション
- B01: 検索欄で `yamada` を入力すると対象行に絞り込まれる
- B02: ロールフィルタ変更で件数が変化する
- B03: 状態フィルタ変更で件数が変化する
- B04: 部署フィルタ変更で件数が変化する
- B05: `ID` 列ヘッダクリックで昇順/降順が切り替わる
- B06: `ユーザー` 列ヘッダクリックで昇順/降順が切り替わる
- B07: ページサイズ変更で1ページ件数が変わる
- B08: `次へ` / `前へ` / ページ番号でページ遷移できる

### C. ユーザー作成
- C01: 正常入力で新規ユーザーを作成できる
- C02: 作成後に一覧へ行追加される
- C03: `data/users.json` に新規データが保存される（API接続時）
- C04: 監査ログに `ユーザー作成` が追加される

### D. ユーザー編集
- D01: 既存ユーザーのロール/状態/表示名を編集できる
- D02: 一覧へ変更が反映される
- D03: `data/users.json` に更新内容が保存される
- D04: 監査ログに `ユーザー更新` が追加される
- D05: `data/audit.json` の `ユーザー更新` に `before` / `after` が含まれる

### E. ユーザー削除
- E01: 削除確認モーダルから削除を実行できる
- E02: 一覧から対象ユーザーが消える
- E03: `data/users.json` から対象ユーザーが削除される
- E04: 監査ログに `ユーザー削除` が追加され、`before` が記録される

### F. フォームバリデーション（インラインエラー）
- F01: 必須未入力でインラインエラーが表示される
- F02: 不正メール形式でインラインエラーが表示される
- F03: 不正ユーザーID形式でインラインエラーが表示される
- F04: エラー修正時に該当項目のインラインエラーが消える
- F05: 重複ユーザーID作成時にサーバー側エラーがインライン表示される

### G. ロール権限マトリクス
- G01: `scope` を変更して保存できる
- G02: 権限チェック（更新/承認/監査/管理者設定）を変更して保存できる
- G03: `data/roles.json` に変更が保存される
- G04: 監査ログに `ロール権限更新` が追加される
- G05: `data/audit.json` の `ロール権限更新` に `before` / `after` が含まれる

## Playwright実装メモ（推奨）
- セレクタ方針:
  - `data-action` 属性を優先利用
  - 入力項目は `id`（例: `#settings-user-search`, `#user-form-userId`）
  - テーブル見出しは `data-action="sort-users"` を利用
- テスト分離:
  - 各テスト前に `data/*.json` を初期化するスクリプトを用意
  - 作成ユーザーIDにユニークサフィックスを付けて衝突を回避
- 安定化:
  - トーストは補助確認に留め、主要アサーションはテーブル行/JSONファイル/API応答で確認
  - API保存反映は短いリトライを許容

## 未実装の自動化向け改善（任意）
- `data-testid` の追加（現在は `id` / `data-action` で代替可能）
- 初期データリセット用 API（`POST /api/test/reset`）
  - 実装済み
- 監査ログのイベント種別フィルタ API
