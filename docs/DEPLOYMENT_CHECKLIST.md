# ITSM-Sec Nexus - デプロイチェックリスト

## 📋 本番環境デプロイ前チェックリスト

デプロイ前に以下を確認してください。

---

## ✅ 開発環境でのテスト

### 機能テスト

- [ ] すべての新機能が正常に動作する
- [ ] 既存機能に影響がない（回帰テストパス）
- [ ] エラーハンドリングが適切
- [ ] ユーザー体験が良好

### データテスト

- [ ] データの作成が正常
- [ ] データの更新が正常
- [ ] データの削除が正常
- [ ] ペジネーションが正常

### セキュリティテスト

- [ ] 認証が正常に機能
- [ ] 権限チェックが機能
- [ ] SQLインジェクション対策済み
- [ ] XSS対策済み
- [ ] CSRF対策済み

### パフォーマンステスト

- [ ] ページ読み込み速度が許容範囲
- [ ] APIレスポンス時間が許容範囲（< 1秒）
- [ ] 大量データでも動作
- [ ] メモリリークがない

---

## ✅ コード品質

### コードレビュー

- [ ] コードレビュー完了
- [ ] コーディング規約に準拠
- [ ] コメントが適切
- [ ] 不要なconsole.logを削除

### ドキュメント

- [ ] APIドキュメント更新（openapi.yaml）
- [ ] README更新
- [ ] CHANGELOG更新
- [ ] コミットメッセージが明確

---

## ✅ データベース

### マイグレーション

- [ ] DBマイグレーションスクリプト作成済み
- [ ] 開発環境でマイグレーションテスト済み
- [ ] ロールバックスクリプト準備済み
- [ ] データ損失のリスクを評価済み

### バックアップ

- [ ] 本番DBの最新バックアップを取得
- [ ] バックアップの復元テスト済み
- [ ] バックアップの保存場所を確認

```bash
# 本番DBバックアップ
cp backend/itsm_nexus.db "backups/itsm_nexus_$(date +%Y%m%d_%H%M%S).db"
```

---

## ✅ 環境設定

### 環境変数

- [ ] .env.production が最新
- [ ] JWT_SECRETが本番用の強力なものに設定済み
- [ ] SMTP設定が正しい（メール通知を使用する場合）
- [ ] M365設定が正しい（M365統合を使用する場合）

### SSL証明書

- [ ] SSL証明書が有効
- [ ] 証明書の有効期限を確認（90日以上残っている）
- [ ] 秘密鍵のパーミッションが適切（600）

```bash
# 証明書の有効期限確認
openssl x509 -in ssl/server.crt -noout -dates
```

---

## ✅ サービス管理

### Systemd

- [ ] サービスが正常に起動
- [ ] 自動起動が有効化済み
- [ ] ログローテーション設定済み

```bash
# サービス状態確認
./manage-env.sh prod status

# 自動起動確認
systemctl is-enabled itsm-sec-nexus-prod
```

---

## ✅ モニタリング

### ログ設定

- [ ] ログレベルが適切（本番: info）
- [ ] ログファイルのパーミッション確認
- [ ] ディスク容量に余裕がある

### アラート

- [ ] エラーアラート設定済み
- [ ] メール通知設定済み（オプション）
- [ ] 監視ダッシュボード設定済み（オプション）

---

## ✅ デプロイ実行

### 直前確認

- [ ] 開発環境で最終テスト完了
- [ ] Gitにコミット済み
- [ ] チームメンバーに通知済み
- [ ] メンテナンス時間を確保（必要な場合）

### デプロイ手順

```bash
# 1. 本番DBバックアップ
cp backend/itsm_nexus.db "backups/itsm_nexus_$(date +%Y%m%d_%H%M%S).db"

# 2. 本番環境を再起動
sudo ./manage-env.sh prod restart

# 3. サービス状態確認
./manage-env.sh prod status

# 4. ヘルスチェック
curl -k https://192.168.0.187:6443/health

# 5. ログ監視
./manage-env.sh prod logs
```

---

## ✅ デプロイ後確認

### 動作確認（5分以内）

- [ ] ログインが正常
- [ ] 主要機能が動作
  - [ ] ダッシュボード表示
  - [ ] インシデント管理
  - [ ] SLA管理
  - [ ] セキュリティダッシュボード
- [ ] エラーログがない
- [ ] API応答が正常

### モニタリング（30分間）

- [ ] メモリ使用量が正常
- [ ] CPU使用率が正常
- [ ] エラーレートが正常
- [ ] ユーザーからの問い合わせなし

---

## ⚠️ 問題発生時の対応

### 即座にロールバック

```bash
# 1. 本番環境を停止
sudo ./manage-env.sh prod stop

# 2. 以前のバージョンに戻す
git checkout <previous-commit>

# 3. DBを復元
cp backups/itsm_nexus_<backup-date>.db backend/itsm_nexus.db

# 4. 本番環境を起動
sudo ./manage-env.sh prod start

# 5. 確認
./manage-env.sh prod status
```

---

## 📝 デプロイ記録

デプロイごとに記録を残しましょう：

```markdown
## 2026-01-16 12:00 - v2.1.1デプロイ

- **デプロイ内容**: インシデント管理のフィルター機能追加
- **影響範囲**: フロントエンド、APIエンドポイント
- **DBマイグレーション**: なし
- **ダウンタイム**: 30秒
- **デプロイ担当**: kensan
- **結果**: ✅ 成功
- **備考**: エラーなし、動作正常
```

---

## 🎯 デプロイ頻度の推奨

| 変更タイプ | 頻度 | タイミング |
|-----------|------|----------|
| **バグ修正（緊急）** | 即座 | 発見次第 |
| **バグ修正（軽微）** | 週1回 | 金曜日午後 |
| **新機能** | 月1-2回 | 第1・第3金曜日 |
| **セキュリティパッチ** | 即座 | 発見次第 |

---

## 📚 関連ドキュメント

- **開発ワークフロー**: `DEVELOPMENT_WORKFLOW.md`
- **環境セットアップ**: `ENVIRONMENT_SETUP.md`
- **運用ガイド**: `OPERATIONS.md`

---

**ITSM-Sec Nexus Team**
