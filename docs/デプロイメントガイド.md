# ITSM-Sec Nexus デプロイメントガイド

## 目次
1. [前提条件](#前提条件)
2. [初回デプロイ手順](#初回デプロイ手順)
3. [アップデート手順](#アップデート手順)
4. [ロールバック手順](#ロールバック手順)
5. [トラブルシューティング](#トラブルシューティング)
6. [本番環境チェックリスト](#本番環境チェックリスト)

---

## 前提条件

### サーバー要件
- **OS**: Ubuntu 20.04 LTS / 22.04 LTS、CentOS 8+、Debian 11+
- **CPU**: 2コア以上（推奨: 4コア）
- **メモリ**: 4GB以上（推奨: 8GB）
- **ディスク**: 50GB以上の空き容量
- **ネットワーク**: ポート 80/443 が外部から接続可能

### 必要なソフトウェア
- **Docker**: v24.0以上
- **Docker Compose**: v2.20以上
- **Git**: v2.25以上（リポジトリからクローンする場合）
- **OpenSSL**: SSL証明書生成用

### ドメイン設定
- DNSレコードが本番サーバーのIPアドレスを指していること
- ポート 80/443 がファイアウォールで開放されていること

---

## 初回デプロイ手順

### ステップ1: リポジトリのクローン

```bash
# プロジェクトディレクトリに移動
cd /opt

# リポジトリをクローン
git clone https://github.com/your-org/itsm-system.git
cd itsm-system
```

### ステップ2: 環境変数の設定

```bash
# 自動セットアップスクリプトを実行
./scripts/setup-env.sh

# 出力されたGrafana管理者パスワードをメモしておく
# 例: admin / xK8n2mP9qL5w
```

**手動設定する場合**:
```bash
# テンプレートをコピー
cp .env.production.example .env.production

# エディタで編集
nano .env.production

# 最低限以下を設定
# - DOMAIN: 本番ドメイン名
# - JWT_SECRET: openssl rand -base64 64 で生成
# - REDIS_PASSWORD: openssl rand -base64 32 で生成
# - GRAFANA_ADMIN_PASSWORD: 強力なパスワード
```

### ステップ3: SSL証明書の設定

```bash
# SSL証明書セットアップスクリプトを実行
./scripts/setup-ssl.sh

# 本番環境の場合は「2」を選択してLet's Encrypt証明書を取得
# ドメイン名とメールアドレスを入力
```

**自己署名証明書（開発環境用）**:
```bash
# スクリプトで「1」を選択、またはOpenSSLコマンド実行:
openssl genrsa -out nginx/ssl/key.pem 2048
openssl req -new -x509 -key nginx/ssl/key.pem -out nginx/ssl/cert.pem -days 365
cp nginx/ssl/cert.pem nginx/ssl/chain.pem
openssl dhparam -out nginx/ssl/dhparam.pem 2048
```

### ステップ4: 依存関係のインストール

```bash
# Node.js依存関係をインストール（マイグレーション用）
npm install
```

### ステップ5: データベースのマイグレーション

```bash
# マイグレーションを実行
npm run migrate:latest

# マイグレーション状態を確認
npm run migrate:status
```

### ステップ6: Dockerイメージのビルドと起動

```bash
# Dockerイメージをビルド
npm run docker:build

# サービスを起動
npm run docker:up

# ログを確認
npm run docker:logs
```

**個別コマンド**:
```bash
# ビルド
docker-compose build

# バックグラウンドで起動
docker-compose up -d

# サービス状態確認
docker-compose ps

# ログ確認（リアルタイム）
docker-compose logs -f
```

### ステップ7: デプロイ確認

```bash
# ヘルスチェック
curl http://localhost:5000/api/v1/health

# HTTPS経由でアクセス確認
curl -k https://your-domain.com/api/v1/health

# Webブラウザでアクセス
# https://your-domain.com
```

### ステップ8: Systemdサービス化（オプション）

```bash
# Systemdサービスとしてインストール
sudo ./scripts/install-systemd.sh

# サービス起動
sudo systemctl start itsm-system

# 自動起動有効化
sudo systemctl enable itsm-system

# ステータス確認
sudo systemctl status itsm-system
```

---

## アップデート手順

### ゼロダウンタイムアップデート

```bash
# 1. 最新コードを取得
git pull origin main

# 2. 環境変数の変更を確認（必要に応じて更新）
diff .env.production.example .env.production

# 3. データベースバックアップ（重要！）
./scripts/backup.sh

# 4. 新しい依存関係があればインストール
npm install

# 5. データベースマイグレーション
npm run migrate:latest

# 6. Dockerイメージを再ビルド
docker-compose build

# 7. サービスを再起動
docker-compose up -d

# 8. ヘルスチェック
curl http://localhost:5000/api/v1/health

# 9. ログ確認
docker-compose logs -f --tail=100
```

### ローリングアップデート（複数サーバー環境）

```bash
# サーバー1: メンテナンスモードに
# サーバー1: アップデート実行
# サーバー1: ヘルスチェック確認
# サーバー1: 本番トラフィック復帰

# サーバー2以降: 同様の手順を繰り返し
```

---

## ロールバック手順

### 緊急ロールバック（5分以内）

```bash
# 1. 前バージョンのDockerイメージに戻す
docker-compose down
git checkout <前回のコミットハッシュ>
docker-compose up -d

# 2. データベースをバックアップから復元（データ損失がある場合のみ）
./scripts/restore.sh /path/to/backup/itsm_nexus_YYYYMMDD_HHMMSS.db

# 3. ヘルスチェック
curl http://localhost:5000/api/v1/health

# 4. ログ確認
docker-compose logs -f
```

### データベースマイグレーションのロールバック

```bash
# 最新のマイグレーションを1つ戻す
npm run migrate:rollback

# マイグレーション状態確認
npm run migrate:status

# サービス再起動
docker-compose restart backend
```

---

## トラブルシューティング

### 1. サービスが起動しない

```bash
# サービス状態確認
docker-compose ps

# 詳細ログ確認
docker-compose logs backend
docker-compose logs nginx

# コンテナに入って調査
docker-compose exec backend sh
```

**よくある原因**:
- `.env.production`ファイルが存在しない → ステップ2を実行
- SSL証明書が見つからない → ステップ3を実行
- ポート競合 → `sudo lsof -i :5000` でポート使用状況確認

### 2. データベース接続エラー

```bash
# データベースファイルの権限確認
ls -la backend/itsm_nexus.db

# Dockerコンテナ内からDBアクセステスト
docker-compose exec backend sh
sqlite3 /app/backend/itsm_nexus.db ".tables"
```

### 3. nginxが起動しない

```bash
# nginx設定ファイルの構文チェック
docker-compose run --rm nginx nginx -t

# SSL証明書ファイルの確認
ls -la nginx/ssl/
```

### 4. パフォーマンス低下

```bash
# リソース使用状況確認
docker stats

# ログファイルサイズ確認
du -sh logs/*

# ログローテーション実行
sudo logrotate -f /etc/logrotate.d/itsm-system
```

### 5. Let's Encrypt証明書更新エラー

```bash
# 証明書の有効期限確認
openssl x509 -in nginx/ssl/cert.pem -noout -dates

# 手動更新
sudo certbot renew --force-renewal

# 証明書を再コピー
sudo cp /etc/letsencrypt/live/your-domain/fullchain.pem nginx/ssl/cert.pem
sudo cp /etc/letsencrypt/live/your-domain/privkey.pem nginx/ssl/key.pem
sudo chown $(whoami):$(whoami) nginx/ssl/*.pem

# nginx再起動
docker-compose restart nginx
```

---

## 本番環境チェックリスト

### セキュリティ

- [ ] `.env.production`にランダムなJWT_SECRETを設定
- [ ] `.env.production`のパーミッションが600
- [ ] Let's Encrypt証明書を使用（自己署名ではない）
- [ ] デフォルトパスワードを変更（admin/admin123など）
- [ ] ファイアウォールで不要なポートを閉鎖
- [ ] SSH鍵認証を使用（パスワード認証無効化）
- [ ] fail2banなどのブルートフォース対策

### 監視・バックアップ

- [ ] Prometheusメトリクス収集が動作
- [ ] Grafanaダッシュボードでアラート設定
- [ ] 日次バックアップcronジョブ設定
- [ ] バックアップのリモート保存設定
- [ ] ログローテーション設定

### パフォーマンス

- [ ] SQLite WALモード有効（knexfile.jsで設定済み）
- [ ] Redisキャッシング有効
- [ ] nginxのgzip圧縮有効
- [ ] 静的ファイルのキャッシュヘッダー設定

### ドキュメント

- [ ] 運用マニュアル更新
- [ ] インシデント対応フロー確認
- [ ] 緊急連絡先リスト作成

---

## 運用コマンド一覧

### Docker Compose

```bash
# サービス起動
docker-compose up -d

# サービス停止
docker-compose down

# サービス再起動
docker-compose restart

# ログ確認
docker-compose logs -f [サービス名]

# サービス状態確認
docker-compose ps
```

### Database

```bash
# マイグレーション実行
npm run migrate:latest

# マイグレーションロールバック
npm run migrate:rollback

# マイグレーション状態確認
npm run migrate:status

# 新しいマイグレーション作成
npm run migrate:make <マイグレーション名>
```

### バックアップ

```bash
# 手動バックアップ
./scripts/backup.sh

# バックアップから復元
./scripts/restore.sh <バックアップファイルパス>

# バックアップ一覧表示
ls -lh backend/backups/
```

### Systemd（サービス化した場合）

```bash
# サービス起動
sudo systemctl start itsm-system

# サービス停止
sudo systemctl stop itsm-system

# サービス再起動
sudo systemctl restart itsm-system

# サービス状態確認
sudo systemctl status itsm-system

# ログ確認
sudo journalctl -u itsm-system -f
```

---

## サポート

問題が解決しない場合は、以下の情報を含めて報告してください：

1. エラーメッセージ全文
2. `docker-compose logs`の出力
3. `docker-compose ps`の出力
4. OS環境情報（`uname -a`）
5. Dockerバージョン（`docker --version`、`docker-compose --version`）

**GitHub Issues**: https://github.com/your-org/itsm-system/issues
