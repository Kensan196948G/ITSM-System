# ITSM-Sec Nexus テスト計画書

## 目次

1. [テスト戦略](#1-テスト戦略)
2. [既存テストケース一覧](#2-既存テストケース一覧)
3. [新機能のテストケース](#3-新機能のテストケース)
4. [テストカバレッジ目標](#4-テストカバレッジ目標)
5. [テスト実行方法](#5-テスト実行方法)
6. [E2Eテストシナリオ](#6-e2eテストシナリオ)

---

## 1. テスト戦略

### 1.1 テストピラミッド

```
        ┌───────────┐
        │   E2E     │ ← 少数（重要フロー）
        │  Tests    │
        ├───────────┤
        │Integration│ ← 中程度（API統合）
        │  Tests    │
        ├───────────┤
        │   Unit    │ ← 多数（関数・ロジック）
        │  Tests    │
        └───────────┘
```

### 1.2 各層の役割

#### ユニットテスト（Unit Tests）

**目的**: 個別の関数・モジュールの動作検証

**対象**:
- ミドルウェア（認証、バリデーション）
- ユーティリティ関数
- データ変換ロジック

**ツール**:
- Jest
- モック: jest.fn()、jest.spyOn()

**実行頻度**: 毎回のコミット前（Huskyフック）

#### 統合テスト（Integration Tests）

**目的**: APIエンドポイントとデータベースの連携検証

**対象**:
- RESTful APIエンドポイント
- データベースCRUD操作
- 認証・認可フロー
- エラーハンドリング

**ツール**:
- Jest + Supertest
- インメモリSQLite

**実行頻度**: 毎回のプッシュ前、CI/CD

#### E2Eテスト（End-to-End Tests）

**目的**: ユーザーシナリオ全体の動作検証

**対象**:
- ログインからデータ操作までの完全フロー
- ロールベースアクセス制御
- UI/UX動作
- エラー処理の実際の動作

**ツール**:
- Playwright（将来実装）
- または手動テスト

**実行頻度**: リリース前、週次

---

## 2. 既存テストケース一覧

### 2.1 認証テスト（auth.test.js）

**ファイル**: `backend/__tests__/integration/auth.test.js`

| テストケース | 目的 | 期待結果 |
|------------|------|---------|
| ユーザー登録成功 | 新規ユーザー作成 | 201、トークン返却 |
| ユーザー登録失敗（重複） | バリデーション検証 | 400エラー |
| ログイン成功 | 既存ユーザー認証 | 200、JWTトークン |
| ログイン失敗（パスワード誤り） | 認証拒否 | 401エラー |
| 現在のユーザー情報取得 | JWT認証検証 | 200、ユーザー情報 |
| トークンなしでアクセス | 認証必須確認 | 401エラー |

**主要検証項目**:
- bcryptパスワードハッシング
- JWTトークン生成・検証
- 認証エラーハンドリング

### 2.2 インシデントテスト（incidents.test.js）

**ファイル**: `backend/__tests__/integration/incidents.test.js`

| テストケース | 目的 | 期待結果 |
|------------|------|---------|
| インシデント一覧取得 | 認証付きGET | 200、配列返却 |
| インシデント新規作成（analyst） | 権限確認 | 201、ID返却 |
| インシデント新規作成（viewer） | 権限拒否 | 403エラー |
| インシデント詳細取得 | 単一データ取得 | 200、オブジェクト |
| インシデント更新（manager） | 更新権限 | 200、成功 |
| インシデント削除（admin） | 削除権限 | 200、成功 |
| バリデーションエラー（空タイトル） | 入力検証 | 400エラー |
| バリデーションエラー（不正優先度） | enum検証 | 400エラー |

**主要検証項目**:
- RBAC（Role-Based Access Control）
- express-validatorバリデーション
- CRUD操作完全性

### 2.3 変更管理テスト（changes.test.js）

**ファイル**: `backend/__tests__/integration/changes.test.js`

| テストケース | 目的 | 期待結果 |
|------------|------|---------|
| RFC一覧取得 | 変更チケット取得 | 200、配列 |
| RFC新規作成（analyst） | 作成権限 | 201、ID |
| RFC承認（manager） | 承認権限 | 200、status: Approved |
| RFC拒否（manager） | 拒否権限 | 200、status: Rejected |
| RFC承認失敗（analyst） | 承認権限なし | 403エラー |
| 緊急変更フラグ設定 | Boolean検証 | 201、emergency: true |
| 実装予定日バリデーション | 日付検証 | 400エラー（不正形式） |

**主要検証項目**:
- ワークフロー制御（Draft → Pending → Approved/Rejected）
- 日付バリデーション
- 緊急変更フラグ処理

### 2.4 CRUD操作テスト（crud-operations.test.js）

**ファイル**: `backend/__tests__/integration/crud-operations.test.js`

| テストケース | 目的 | 期待結果 |
|------------|------|---------|
| 全テーブルCREATE | データ作成 | 201、ID返却 |
| 全テーブルREAD | データ取得 | 200、データ存在 |
| 全テーブルUPDATE | データ更新 | 200、変更反映 |
| 全テーブルDELETE | データ削除 | 200、削除成功 |
| 存在しないID取得 | エラーハンドリング | 404エラー |
| SQLインジェクション攻撃 | セキュリティ検証 | 攻撃無効化 |

**対象テーブル**:
- incident_tickets
- problem_tickets
- change_requests
- assets
- sla_targets
- vulnerabilities
- threat_intelligence
- audit_logs
- security_events
- compliance_frameworks
- users

**主要検証項目**:
- 全テーブルのCRUD完全性
- SQLインジェクション対策（パラメータ化クエリ）
- 外部キー制約

### 2.5 ミドルウェアテスト

#### 認証ミドルウェアテスト（unit/middleware/auth.test.js）

**ファイル**: `backend/__tests__/unit/middleware/auth.test.js`

| テストケース | 目的 | 期待結果 |
|------------|------|---------|
| authenticateToken: 有効トークン | JWT検証 | next()呼び出し |
| authenticateToken: トークンなし | 認証拒否 | 401エラー |
| authenticateToken: 無効トークン | 改ざん検出 | 403エラー |
| checkRole: admin権限 | ロール確認 | next()呼び出し |
| checkRole: 権限不足 | アクセス拒否 | 403エラー |

**主要検証項目**:
- JWTトークン検証ロジック
- ロール階層制御（admin > manager > analyst > viewer）

#### バリデーションミドルウェアテスト（unit/middleware/validation.test.js）

**ファイル**: `backend/__tests__/unit/middleware/validation.test.js`

| テストケース | 目的 | 期待結果 |
|------------|------|---------|
| インシデントバリデーション | 必須項目確認 | エラー配列 |
| 優先度enum検証 | 許可値確認 | Low/Medium/High/Criticalのみ |
| メールアドレス検証 | 形式確認 | 不正形式拒否 |
| 数値範囲検証 | 範囲確認 | 0-100のみ許可 |
| XSS攻撃パターン | サニタイズ | <script>タグ除去 |

**主要検証項目**:
- express-validatorルール
- カスタムバリデーター
- エラーメッセージ形式

### 2.6 E2Eテスト（user-journey.test.js）

**ファイル**: `backend/__tests__/e2e/user-journey.test.js`

| シナリオ | ステップ | 検証内容 |
|---------|---------|---------|
| 管理者ワークフロー | ログイン → インシデント作成 → 承認 | 全機能アクセス可 |
| アナリスト制限 | ログイン → ユーザー管理アクセス試行 | 403エラー |
| セキュリティインシデント | 脆弱性登録 → インシデント紐付け | データ整合性 |
| エラーハンドリング | 不正データ送信 → エラー表示 | 適切なエラー |

**主要検証項目**:
- 実際のユーザー操作フロー
- 複数API連携
- データ整合性

---

## 3. 新機能のテストケース

### 3.1 編集モーダルテスト

**優先度**: High

**テストケース**:

| ID | テスト項目 | 前提条件 | 操作 | 期待結果 |
|----|----------|---------|------|---------|
| E-001 | インシデント編集モーダル表示 | adminログイン | 編集ボタンクリック | モーダル表示、データプリセット |
| E-002 | インシデント編集保存 | モーダル表示中 | タイトル変更→保存 | 200、テーブル更新 |
| E-003 | 問題チケット編集保存 | モーダル表示中 | 重大度変更→保存 | 200、データ更新 |
| E-004 | RFC編集保存 | モーダル表示中 | 実装日変更→保存 | 200、日付更新 |
| E-005 | 編集キャンセル | モーダル表示中 | キャンセルボタン | 変更破棄、モーダル閉じる |
| E-006 | バリデーションエラー | モーダル表示中 | 空タイトル保存 | エラートースト表示 |

**実装コード例**:

```javascript
describe('Edit Modal Tests', () => {
  it('should update incident via modal', async () => {
    const updateData = { title: '更新タイトル' };
    const res = await request(app)
      .put('/api/v1/incidents/test-id')
      .set('Authorization', `Bearer ${adminToken}`)
      .send(updateData);

    expect(res.status).toBe(200);
    expect(res.body.success).toBe(true);
  });
});
```

### 3.2 削除機能テスト

**優先度**: High

**テストケース**:

| ID | テスト項目 | 前提条件 | 操作 | 期待結果 |
|----|----------|---------|------|---------|
| D-001 | インシデント削除（admin） | データ存在 | 削除API実行 | 200、データ削除 |
| D-002 | インシデント削除（analyst） | データ存在 | 削除API実行 | 403エラー |
| D-003 | 問題チケット削除 | データ存在 | DELETEリクエスト | 200、削除成功 |
| D-004 | RFC削除 | Pending状態 | 削除API実行 | 200、削除成功 |
| D-005 | RFC削除拒否 | Approved状態 | 削除API実行 | 400エラー（承認済み削除不可） |
| D-006 | 存在しないデータ削除 | - | 削除API実行 | 404エラー |

**実装コード例**:

```javascript
describe('Delete Functionality', () => {
  it('should delete incident (admin)', async () => {
    const res = await request(app)
      .delete('/api/v1/incidents/test-id')
      .set('Authorization', `Bearer ${adminToken}`);

    expect(res.status).toBe(200);
  });

  it('should reject delete (analyst)', async () => {
    const res = await request(app)
      .delete('/api/v1/incidents/test-id')
      .set('Authorization', `Bearer ${analystToken}`);

    expect(res.status).toBe(403);
  });
});
```

### 3.3 テーブル機能テスト

**優先度**: Medium

#### ページネーションテスト

| ID | テスト項目 | 前提条件 | 操作 | 期待結果 |
|----|----------|---------|------|---------|
| P-001 | ページネーション（10件/ページ） | 30件データ存在 | ページ1取得 | 10件返却 |
| P-002 | ページネーション（ページ2） | 30件データ存在 | ページ2取得 | 11-20件目返却 |
| P-003 | 最終ページ | 25件データ存在 | ページ3取得 | 21-25件目返却 |

#### ソートテスト

| ID | テスト項目 | 前提条件 | 操作 | 期待結果 |
|----|----------|---------|------|---------|
| S-001 | 日付昇順ソート | - | created_at ASC | 古い順 |
| S-002 | 優先度降順ソート | - | priority DESC | Critical→High→Medium→Low |
| S-003 | タイトルソート | - | title ASC | アルファベット順 |

#### 検索テスト

| ID | テスト項目 | 前提条件 | 操作 | 期待結果 |
|----|----------|---------|------|---------|
| F-001 | タイトル検索 | - | search=サーバー | タイトルに「サーバー」含む |
| F-002 | ステータス検索 | - | status=Open | Open状態のみ |
| F-003 | 複合検索 | - | status=Open&priority=High | Open+High |

#### エクスポートテスト

| ID | テスト項目 | 前提条件 | 操作 | 期待結果 |
|----|----------|---------|------|---------|
| X-001 | CSV/Excelエクスポート | データ存在 | エクスポートボタン | ファイルダウンロード |
| X-002 | エクスポートデータ整合性 | - | エクスポート実行 | 全列データ含む |

**実装コード例**:

```javascript
describe('Table Features', () => {
  it('should paginate results', async () => {
    const res = await request(app)
      .get('/api/v1/incidents?page=1&limit=10')
      .set('Authorization', `Bearer ${token}`);

    expect(res.body.data.length).toBeLessThanOrEqual(10);
    expect(res.body.pagination).toHaveProperty('total');
  });

  it('should sort by priority DESC', async () => {
    const res = await request(app)
      .get('/api/v1/incidents?sort=priority&order=DESC')
      .set('Authorization', `Bearer ${token}`);

    const priorities = res.body.data.map(i => i.priority);
    expect(priorities[0]).toBe('Critical');
  });

  it('should search by title', async () => {
    const res = await request(app)
      .get('/api/v1/incidents?search=サーバー')
      .set('Authorization', `Bearer ${token}`);

    res.body.data.forEach(item => {
      expect(item.title).toContain('サーバー');
    });
  });
});
```

### 3.4 ユーザー管理テスト

**優先度**: High

**テストケース**:

| ID | テスト項目 | 前提条件 | 操作 | 期待結果 |
|----|----------|---------|------|---------|
| U-001 | ユーザー一覧取得（admin） | - | GET /users | 200、全ユーザー |
| U-002 | ユーザー一覧取得（analyst） | - | GET /users | 403エラー |
| U-003 | ユーザー作成（admin） | - | POST /users | 201、作成成功 |
| U-004 | ユーザーロール変更 | - | PUT /users/:id | 200、ロール更新 |
| U-005 | ユーザー削除 | - | DELETE /users/:id | 200、削除成功 |
| U-006 | パスワードリセット | - | POST /users/:id/reset | 200、新パスワード |

**実装コード例**:

```javascript
describe('User Management', () => {
  it('should get all users (admin)', async () => {
    const res = await request(app)
      .get('/api/v1/users')
      .set('Authorization', `Bearer ${adminToken}`);

    expect(res.status).toBe(200);
    expect(Array.isArray(res.body.data)).toBe(true);
  });

  it('should reject user list (analyst)', async () => {
    const res = await request(app)
      .get('/api/v1/users')
      .set('Authorization', `Bearer ${analystToken}`);

    expect(res.status).toBe(403);
  });
});
```

---

## 4. テストカバレッジ目標

### 4.1 現在の状況

**テスト実行結果**（2025-12-28時点）:
```
Test Suites: 5 passed, 5 total
Tests:       130 passed, 130 total
Snapshots:   0 total
Time:        15.234 s
```

**カバレッジ現状**:
- Statements: 75%
- Branches: 68%
- Functions: 72%
- Lines: 76%

### 4.2 カバレッジ目標

| カテゴリ | 現状 | 目標 | 期限 |
|---------|-----|------|------|
| **Statements** | 75% | 85% | Phase A-5 |
| **Branches** | 68% | 80% | Phase A-5 |
| **Functions** | 72% | 85% | Phase A-5 |
| **Lines** | 76% | 85% | Phase A-5 |

### 4.3 未カバー領域

**優先度High（カバレッジ向上必要）**:
- エラーハンドリング分岐（try-catch）
- 認証失敗パターン（トークン改ざん）
- バリデーション失敗パターン（境界値）
- データベーストランザクション失敗

**優先度Medium**:
- ロギング処理
- Swagger仕様生成
- ヘルスチェックエンドポイント

### 4.4 カバレッジ向上施策

```bash
# カバレッジレポート生成
npm run test:coverage

# HTMLレポート確認
open coverage/lcov-report/index.html

# 未カバー箇所特定
grep -A 5 "uncovered" coverage/coverage-summary.json
```

---

## 5. テスト実行方法

### 5.1 基本コマンド

```bash
# 全テスト実行
npm test

# ウォッチモード（開発中）
npm run test:watch

# カバレッジレポート生成
npm run test:coverage

# ユニットテストのみ
npm run test:unit

# 統合テストのみ
npm run test:integration
```

### 5.2 個別テスト実行

```bash
# 特定ファイルのみ
npx jest backend/__tests__/integration/auth.test.js

# 特定テストケースのみ（describeブロック名で指定）
npx jest -t "Authentication API"

# 特定テストケースのみ（itブロック名で指定）
npx jest -t "should login successfully"

# 詳細出力
npx jest --verbose

# デバッグモード
node --inspect-brk node_modules/.bin/jest --runInBand
```

### 5.3 CI/CD統合

**GitHub Actions設定例（.github/workflows/test.yml）**:

```yaml
name: Run Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Run tests
        run: npm test
      - name: Generate coverage
        run: npm run test:coverage
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
```

### 5.4 前提条件

```bash
# 環境変数設定（テスト用）
export NODE_ENV=test
export JWT_SECRET=test-secret-key

# テスト用データベース初期化（自動）
# Jest setup: jest.config.js → setupFilesAfterEnv

# 依存関係確認
npm list --depth=0
```

---

## 6. E2Eテストシナリオ

### 6.1 管理者ワークフロー

**シナリオ**: 管理者が新規インシデントを登録し、承認するまで

**ステップ**:

| # | アクション | API | 期待結果 |
|---|----------|-----|---------|
| 1 | ログイン | POST /api/v1/auth/login | 200、JWT取得 |
| 2 | ダッシュボード表示 | GET /api/v1/dashboard/kpi | 200、KPI表示 |
| 3 | インシデント一覧 | GET /api/v1/incidents | 200、リスト取得 |
| 4 | 新規インシデント作成 | POST /api/v1/incidents | 201、ID取得 |
| 5 | インシデント詳細表示 | GET /api/v1/incidents/:id | 200、詳細表示 |
| 6 | ステータス更新（In Progress） | PUT /api/v1/incidents/:id | 200、更新成功 |
| 7 | 解決済みに変更 | PUT /api/v1/incidents/:id | 200、Resolved |

**実装例**:

```javascript
describe('Admin Workflow E2E', () => {
  let token, incidentId;

  it('Step 1: Login as admin', async () => {
    const res = await request(app)
      .post('/api/v1/auth/login')
      .send({ username: 'admin', password: 'admin123' });

    expect(res.status).toBe(200);
    token = res.body.token;
  });

  it('Step 2: Get dashboard KPI', async () => {
    const res = await request(app)
      .get('/api/v1/dashboard/kpi')
      .set('Authorization', `Bearer ${token}`);

    expect(res.status).toBe(200);
    expect(res.body).toHaveProperty('totalIncidents');
  });

  it('Step 3: Create incident', async () => {
    const res = await request(app)
      .post('/api/v1/incidents')
      .set('Authorization', `Bearer ${token}`)
      .send({
        title: 'サーバーダウン',
        description: 'Webサーバー応答なし',
        priority: 'High',
        status: 'Open'
      });

    expect(res.status).toBe(201);
    incidentId = res.body.id;
  });

  it('Step 4: Update status to Resolved', async () => {
    const res = await request(app)
      .put(`/api/v1/incidents/${incidentId}`)
      .set('Authorization', `Bearer ${token}`)
      .send({ status: 'Resolved' });

    expect(res.status).toBe(200);
    expect(res.body.status).toBe('Resolved');
  });
});
```

### 6.2 アナリスト権限制御

**シナリオ**: アナリストが閲覧・作成のみ可能で、削除・管理者機能はアクセス不可

**ステップ**:

| # | アクション | API | 期待結果 |
|---|----------|-----|---------|
| 1 | ログイン（analyst） | POST /api/v1/auth/login | 200、JWT取得 |
| 2 | インシデント一覧閲覧 | GET /api/v1/incidents | 200、OK |
| 3 | インシデント作成 | POST /api/v1/incidents | 201、OK |
| 4 | ユーザー管理アクセス | GET /api/v1/users | 403、拒否 |
| 5 | インシデント削除試行 | DELETE /api/v1/incidents/:id | 403、拒否 |
| 6 | RFC承認試行 | PUT /api/v1/changes/:id/approve | 403、拒否 |

**実装例**:

```javascript
describe('Analyst Permission Control E2E', () => {
  let analystToken;

  beforeAll(async () => {
    const res = await request(app)
      .post('/api/v1/auth/login')
      .send({ username: 'analyst', password: 'analyst123' });
    analystToken = res.body.token;
  });

  it('should allow viewing incidents', async () => {
    const res = await request(app)
      .get('/api/v1/incidents')
      .set('Authorization', `Bearer ${analystToken}`);

    expect(res.status).toBe(200);
  });

  it('should allow creating incidents', async () => {
    const res = await request(app)
      .post('/api/v1/incidents')
      .set('Authorization', `Bearer ${analystToken}`)
      .send({ title: 'Test', priority: 'Low' });

    expect(res.status).toBe(201);
  });

  it('should reject user management', async () => {
    const res = await request(app)
      .get('/api/v1/users')
      .set('Authorization', `Bearer ${analystToken}`);

    expect(res.status).toBe(403);
  });

  it('should reject incident deletion', async () => {
    const res = await request(app)
      .delete('/api/v1/incidents/some-id')
      .set('Authorization', `Bearer ${analystToken}`);

    expect(res.status).toBe(403);
  });
});
```

### 6.3 セキュリティインシデント処理

**シナリオ**: 脆弱性発見からインシデント登録、対応完了まで

**ステップ**:

| # | アクション | API | 期待結果 |
|---|----------|-----|---------|
| 1 | ログイン | POST /api/v1/auth/login | 200、JWT取得 |
| 2 | 脆弱性スキャン結果登録 | POST /api/v1/vulnerabilities | 201、脆弱性ID取得 |
| 3 | セキュリティインシデント作成 | POST /api/v1/incidents | 201、インシデントID取得 |
| 4 | インシデントに脆弱性紐付け | PUT /api/v1/incidents/:id | 200、関連付け成功 |
| 5 | 修正RFC作成 | POST /api/v1/changes | 201、RFC ID取得 |
| 6 | RFC承認（manager） | PUT /api/v1/changes/:id/approve | 200、承認成功 |
| 7 | インシデントクローズ | PUT /api/v1/incidents/:id | 200、Resolved |

**実装例**:

```javascript
describe('Security Incident Workflow E2E', () => {
  let token, vulnId, incidentId, rfcId;

  it('Step 1: Register vulnerability', async () => {
    const res = await request(app)
      .post('/api/v1/vulnerabilities')
      .set('Authorization', `Bearer ${token}`)
      .send({
        cve_id: 'CVE-2024-12345',
        severity: 'High',
        description: 'SQLインジェクション脆弱性'
      });

    expect(res.status).toBe(201);
    vulnId = res.body.id;
  });

  it('Step 2: Create security incident', async () => {
    const res = await request(app)
      .post('/api/v1/incidents')
      .set('Authorization', `Bearer ${token}`)
      .send({
        title: 'セキュリティ脆弱性対応',
        category: 'Security Incident',
        priority: 'Critical',
        vulnerability_id: vulnId
      });

    expect(res.status).toBe(201);
    incidentId = res.body.id;
  });

  it('Step 3: Create fix RFC', async () => {
    const res = await request(app)
      .post('/api/v1/changes')
      .set('Authorization', `Bearer ${token}`)
      .send({
        title: 'SQLインジェクション修正',
        change_type: 'Emergency',
        emergency: true
      });

    expect(res.status).toBe(201);
    rfcId = res.body.id;
  });

  it('Step 4: Close incident', async () => {
    const res = await request(app)
      .put(`/api/v1/incidents/${incidentId}`)
      .set('Authorization', `Bearer ${token}`)
      .send({ status: 'Resolved' });

    expect(res.status).toBe(200);
  });
});
```

### 6.4 エラーハンドリング

**シナリオ**: 不正なデータ送信時の適切なエラー処理

**ステップ**:

| # | アクション | 不正データ | 期待エラー |
|---|----------|----------|----------|
| 1 | 空タイトル送信 | { title: '' } | 400、バリデーションエラー |
| 2 | 不正優先度 | { priority: 'Invalid' } | 400、enum違反 |
| 3 | SQLインジェクション | { title: "'; DROP TABLE--" } | 200、無害化 |
| 4 | XSSスクリプト | { description: '<script>alert(1)</script>' } | 200、エスケープ |
| 5 | 存在しないID更新 | PUT /incidents/invalid-id | 404、Not Found |
| 6 | 認証なしアクセス | Authorization: なし | 401、Unauthorized |

**実装例**:

```javascript
describe('Error Handling E2E', () => {
  it('should reject empty title', async () => {
    const res = await request(app)
      .post('/api/v1/incidents')
      .set('Authorization', `Bearer ${token}`)
      .send({ title: '', priority: 'Low' });

    expect(res.status).toBe(400);
    expect(res.body.errors).toBeDefined();
  });

  it('should sanitize SQL injection', async () => {
    const res = await request(app)
      .post('/api/v1/incidents')
      .set('Authorization', `Bearer ${token}`)
      .send({ title: "'; DROP TABLE users--", priority: 'Low' });

    expect(res.status).toBe(201);
    // データベースは無事
  });

  it('should return 404 for invalid ID', async () => {
    const res = await request(app)
      .get('/api/v1/incidents/invalid-id-12345')
      .set('Authorization', `Bearer ${token}`);

    expect(res.status).toBe(404);
  });
});
```

---

## 付録

### A. テストデータ準備

**ファクトリー関数**:

```javascript
// testHelpers.js
function createTestIncident(overrides = {}) {
  return {
    title: 'テストインシデント',
    description: 'テスト説明',
    priority: 'Medium',
    status: 'Open',
    category: 'Infrastructure',
    ...overrides
  };
}

function createTestUser(overrides = {}) {
  return {
    username: 'testuser',
    password: 'Test123!',
    email: 'test@example.com',
    role: 'analyst',
    ...overrides
  };
}

module.exports = { createTestIncident, createTestUser };
```

### B. テストカバレッジ除外設定

**jest.config.js**:

```javascript
module.exports = {
  collectCoverageFrom: [
    'backend/**/*.js',
    '!backend/__tests__/**',
    '!backend/node_modules/**',
    '!backend/coverage/**'
  ],
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 85,
      lines: 85,
      statements: 85
    }
  }
};
```

### C. モック設定

**データベースモック**:

```javascript
jest.mock('../db', () => ({
  run: jest.fn((sql, params, callback) => callback(null)),
  get: jest.fn((sql, params, callback) => callback(null, { id: 1 })),
  all: jest.fn((sql, params, callback) => callback(null, []))
}));
```

---

**最終更新**: 2025-12-28
**バージョン**: 1.0.0
**テスト総数**: 130 passed
**目標カバレッジ**: 85%
