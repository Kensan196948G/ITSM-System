# Phase 9.1: バックアップ・リストア機能 - プロジェクト概要

**作成日**: 2026-01-31
**フェーズ**: Phase 9.1（運用機能強化）
**優先度**: P0 (Critical)
**担当**: spec-planner SubAgent

---

## 📋 プロジェクト概要

### 🎯 目的

ITSM-Sec Nexusのデータ保護とディザスタリカバリ能力を強化し、ISO 20000およびNIST CSF 2.0の要件に完全準拠したバックアップ・リストア機能を実装する。

### 🔍 背景と課題

#### 現状
- package.jsonに`backup`/`restore`コマンドが定義されているが、実体スクリプトが未実装
- 運用マニュアルにバックアップ手順は記載されているが、手動運用のみ
- 自動バックアップ機構が存在しない
- バックアップの整合性チェックが体系化されていない
- リストアプロセスが未検証

#### 課題
1. **データ損失リスク**: システム障害時のデータ復旧手段が不十分
2. **手動運用の限界**: オペレーションミスのリスクが高い
3. **監査要件未達**: ISO 20000のバックアップ要件に未対応
4. **RPO/RTO未定義**: 復旧目標が明確でない

### 📊 スコープ

#### 実装対象（In Scope）

1. **自動バックアップ機能**
   - 定期実行（日次/週次/月次）
   - フルバックアップ + 差分バックアップ
   - SQLiteデータベース
   - 添付ファイル（将来対応）
   - ログファイル（ローテーション含む）

2. **手動バックアップ機能**
   - REST API経由のトリガー
   - 管理画面からのワンクリック実行
   - CLI スクリプト（運用者向け）

3. **リストア機能**
   - ポイントインタイムリカバリ（PITR）
   - バックアップ一覧表示
   - リストア実行UI
   - ロールバック機能

4. **バックアップ管理**
   - 保存期間管理（デフォルト30日）
   - 古いバックアップの自動削除
   - 整合性チェック（PRAGMA integrity_check）
   - バックアップサイズ監視

5. **監視・通知**
   - バックアップ成功/失敗の通知
   - ディスク容量アラート
   - 監査ログ記録

#### 実装対象外（Out of Scope）

- クラウドストレージ連携（Phase 9.2以降）
- マルチサイトレプリケーション（Phase 9.3以降）
- データベースのオンラインバックアップ（WALモード対応は将来検討）

---

## 🎯 KGI/KPI

### KGI（Key Goal Indicator）

| 指標 | 目標 | 測定方法 |
|------|------|---------|
| **データ損失ゼロ** | 障害発生時の損失データ: 0件 | インシデント報告 |
| **ISO 20000準拠** | バックアップ要件100%達成 | 監査チェックリスト |
| **NIST CSF 2.0準拠** | PR.IP-4（データ保護）100%達成 | コンプライアンススコア |

### KPI（Key Performance Indicator）

| 指標 | 目標値 | 現状 | 測定方法 |
|------|--------|------|---------|
| **RPO（Recovery Point Objective）** | ≤ 1時間 | 未定義 | バックアップ間隔 |
| **RTO（Recovery Time Objective）** | ≤ 15分 | 未定義 | リストア実行時間 |
| **バックアップ成功率** | ≥ 99% | 0% (未実装) | 成功回数/総実行回数 |
| **自動バックアップ実行率** | 100% | 0% (手動のみ) | スケジューラー実行履歴 |
| **バックアップ整合性** | 100% | 未検証 | integrity_check成功率 |
| **ディスク使用効率** | バックアップ容量 ≤ DB容量×7 | 未測定 | ストレージ使用量 |
| **リストア成功率（テスト）** | 100% | 未テスト | 週次リストアテスト結果 |

---

## 🏗️ アーキテクチャ概要

### システム構成

```
┌─────────────────────────────────────────────────────────────┐
│                     ITSM-Sec Nexus                          │
│                                                             │
│  ┌────────────────┐         ┌────────────────┐             │
│  │  管理画面       │  REST   │  Backup API    │             │
│  │  (Frontend)    ├────────>│  (Express.js)  │             │
│  └────────────────┘   API   └────────┬───────┘             │
│                                       │                      │
│  ┌────────────────┐                  │                      │
│  │  CLI Scripts   │                  │                      │
│  │  backup.sh     ├──────────────────┘                      │
│  │  restore.sh    │                                         │
│  └────────────────┘                                         │
│                           ┌───────────────────┐             │
│  ┌────────────────┐       │ BackupService     │             │
│  │  Scheduler     │       │  (Node.js)        │             │
│  │  (node-cron)   ├──────>│ - createBackup()  │             │
│  │                │       │ - listBackups()   │             │
│  │ 日次: 2:00 AM  │       │ - restoreBackup() │             │
│  │ 週次: 日曜      │       │ - deleteOld()     │             │
│  └────────────────┘       └─────────┬─────────┘             │
│                                     │                        │
│                           ┌─────────▼─────────┐             │
│                           │  SQLite Database  │             │
│                           │  (itsm_nexus.db)  │             │
│                           └─────────┬─────────┘             │
│                                     │                        │
│                           ┌─────────▼─────────┐             │
│                           │  Backup Storage   │             │
│                           │  /backups/        │             │
│                           │  ├── daily/       │             │
│                           │  ├── weekly/      │             │
│                           │  └── monthly/     │             │
│                           └───────────────────┘             │
└─────────────────────────────────────────────────────────────┘
```

### データフロー

**バックアップフロー:**
1. トリガー（スケジューラー/API/CLI）
2. BackupServiceがデータベースをロック
3. SQLiteの.backup() APIでバックアップ作成
4. 整合性チェック（PRAGMA integrity_check）
5. 圧縮（gzip）
6. ストレージに保存
7. メタデータをDBに記録
8. 通知送信（成功/失敗）

**リストアフロー:**
1. UI/CLIからリストア要求
2. BackupServiceが現在のDBを退避
3. バックアップファイルを展開
4. 整合性チェック
5. DBファイルを置き換え
6. サービス再起動
7. 検証クエリ実行
8. 通知送信（成功/失敗）

---

## 🔒 セキュリティ要件

### 1. アクセス制御

| 機能 | 必要権限 | 監査ログ |
|------|---------|---------|
| バックアップ作成 | Admin | 必須 |
| バックアップ一覧表示 | Admin | 必須 |
| リストア実行 | Admin | 必須 |
| バックアップ削除 | Admin | 必須 |
| CLI スクリプト実行 | sudoers | OS監査ログ |

### 2. データ保護

- **暗号化**: バックアップファイルをAES-256で暗号化（Phase 9.2で実装予定）
- **アクセス権限**: バックアップディレクトリは`chmod 700`（root/adminのみ）
- **完全性**: SHA-256ハッシュで改ざん検知

### 3. 監査要件

すべてのバックアップ/リストア操作を監査ログに記録：
- 操作者（user_id）
- 操作種別（create/restore/delete）
- タイムスタンプ
- 操作結果（success/failure）
- エラーメッセージ（存在する場合）

---

## 📅 成功基準（Definition of Done）

### Phase 9.1完了条件

- [ ] **機能実装完了**
  - [ ] バックアップ自動実行（日次2:00 AM）
  - [ ] REST API実装（4エンドポイント）
  - [ ] CLI スクリプト実装（backup.sh/restore.sh）
  - [ ] 管理画面実装（バックアップ管理ページ）

- [ ] **テスト完了**
  - [ ] ユニットテスト（カバレッジ85%以上）
  - [ ] 統合テスト（APIテスト）
  - [ ] E2Eテスト（UI操作テスト）
  - [ ] ディザスタリカバリテスト（データ完全消失からの復旧）

- [ ] **パフォーマンス要件達成**
  - [ ] バックアップ時間: 10MB DBで ≤ 5秒
  - [ ] リストア時間: ≤ 15分（RTO達成）
  - [ ] ディスク使用量: ≤ DB容量×7

- [ ] **セキュリティ要件達成**
  - [ ] RBAC統合（Admin権限のみ）
  - [ ] 監査ログ記録100%
  - [ ] ファイル権限設定（700）

- [ ] **ドキュメント整備完了**
  - [ ] 運用ガイド作成
  - [ ] 技術仕様書作成
  - [ ] Runbook作成（ディザスタリカバリ）
  - [ ] README更新

- [ ] **コンプライアンス**
  - [ ] ISO 20000 バックアップ要件100%達成
  - [ ] NIST CSF PR.IP-4（データ保護）達成

---

## 📆 スケジュール

### Phase 9.1 タイムライン（推定2週間）

| 週 | タスク | 成果物 | 担当SubAgent |
|----|--------|--------|-------------|
| **Week 1** | | | |
| Day 1-2 | 仕様策定・設計 | 仕様書、設計書 | spec-planner, arch-reviewer |
| Day 3-5 | Backend実装 | BackupService, API | code-implementer |
| Day 5 | コードレビュー | レビューレポート | code-reviewer |
| **Week 2** | | | |
| Day 6-7 | Frontend実装 | 管理画面 | code-implementer |
| Day 8-9 | テスト設計・実装 | テストコード | test-designer |
| Day 10 | テストレビュー | テストレポート | test-reviewer |
| Day 11-12 | ドキュメント整備 | 運用ガイド、Runbook | spec-planner |
| Day 13 | CI/CD統合 | GitHub Actions | ci-specialist |
| Day 14 | 最終検証・デプロイ | リリースノート | 全員 |

---

## 🎓 参考資料

### 標準・規格
- ISO/IEC 20000-1:2018 - 6.2（サービス継続性・可用性管理）
- NIST CSF 2.0 - PR.IP-4（Backups of information are conducted, maintained, and tested）
- ITIL 4 - Service Design（Service Continuity Management）

### 技術ドキュメント
- [SQLite Backup API](https://www.sqlite.org/backup.html)
- [better-sqlite3 .backup()](https://github.com/WiseLibs/better-sqlite3/blob/master/docs/api.md#backupdestination-options---promise)
- [node-cron Documentation](https://github.com/node-cron/node-cron)

---

## 📞 連絡先

| 役割 | 担当 | 連絡先 |
|------|------|--------|
| プロジェクトリーダー | Claude Sonnet 4.5 | - |
| 仕様策定 | spec-planner | - |
| アーキテクチャレビュー | arch-reviewer | - |
| 実装 | code-implementer | - |
| テスト | test-designer/test-reviewer | - |
| CI/CD | ci-specialist | - |

---

**承認履歴**:
- 2026-01-31: 初版作成（spec-planner）
- 承認待ち

**次のステップ**: アーキテクチャ設計書の作成（arch-reviewer）
