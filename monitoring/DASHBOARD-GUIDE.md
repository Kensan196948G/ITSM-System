# ITSM Nexus Grafanaダッシュボードガイド

このドキュメントでは、ITSM Nexusシステム向けのGrafanaダッシュボードの構成と使用方法を説明します。

## ダッシュボード概要

**ダッシュボード名**: ITSM Nexus システムダッシュボード

**目的**: ITSM Nexusシステムの包括的なパフォーマンス監視と可視化

**更新間隔**: 10秒（カスタマイズ可能）

**タイムゾーン**: Asia/Tokyo

## パネル構成

ダッシュボードは以下のセクションに分かれています：

---

## 1. システム概要

システム全体の健全性を一目で把握できるセクションです。

### パネル一覧

#### 総リクエスト数（5分間）
- **タイプ**: Stat（数値）
- **説明**: 過去5分間の合計HTTPリクエスト数
- **閾値**:
  - 緑: 0-1000リクエスト
  - 黄: 1000-5000リクエスト
  - 赤: 5000以上
- **用途**: トラフィックのスパイクを検知

#### 平均レスポンスタイム（P95）
- **タイプ**: Stat（数値）
- **説明**: 95パーセンタイルのレスポンスタイム
- **閾値**:
  - 緑: 0-0.5秒
  - 黄: 0.5-1秒
  - 赤: 1秒以上
- **用途**: ユーザー体験の品質監視

#### アクティブユーザー数
- **タイプ**: Stat（数値）
- **説明**: 現在アクティブなユーザーの総数
- **用途**: 同時接続数の監視

#### エラー率
- **タイプ**: Gauge（ゲージ）
- **説明**: 4xx/5xxエラーの割合
- **閾値**:
  - 緑: 0-1%
  - 黄: 1-5%
  - 赤: 5%以上
- **用途**: システムエラーの早期検知

#### CPU使用率
- **タイプ**: Gauge（ゲージ）
- **説明**: アプリケーションのCPU使用率
- **閾値**:
  - 緑: 0-60%
  - 黄: 60-80%
  - 赤: 80%以上
- **用途**: リソース不足の検知

#### メモリ使用量
- **タイプ**: Stat（数値）
- **説明**: アプリケーションのメモリ使用量（バイト）
- **閾値**:
  - 緑: 0-500MB
  - 黄: 500MB-1GB
  - 赤: 1GB以上
- **用途**: メモリリークの検知

#### HTTPリクエスト数（メソッド別）
- **タイプ**: Time Series（時系列グラフ）
- **説明**: GET、POST、PUT、DELETEなどメソッド別のリクエスト数推移
- **用途**: APIエンドポイント利用パターンの分析

#### レスポンスタイム（パーセンタイル）
- **タイプ**: Time Series（時系列グラフ）
- **説明**: P50、P95、P99のレスポンスタイム推移
- **用途**: パフォーマンス劣化の傾向分析

---

## 2. インシデント管理

インシデントの状況を監視するセクションです。

### パネル一覧

#### インシデント数（優先度別）
- **タイプ**: Pie Chart（円グラフ）
- **説明**: Critical、High、Medium、Lowの優先度別インシデント分布
- **色分け**:
  - Critical: 赤
  - High: オレンジ
  - Medium: 黄
  - Low: 緑
- **用途**: インシデント優先度の全体像把握

#### オープンインシデント数（優先度別）
- **タイプ**: Time Series（時系列グラフ、積み上げ）
- **説明**: 現在オープン中のインシデント数の推移
- **用途**: 未解決インシデントの蓄積状況監視

#### インシデントタイプ分布
- **タイプ**: Pie Chart（円グラフ）
- **説明**: セキュリティインシデントと通常インシデントの比率
- **用途**: セキュリティ問題の頻度分析

---

## 3. SLAメトリクス

サービスレベル達成状況を監視するセクションです。

### パネル一覧

#### SLA達成率（サービス別）
- **タイプ**: Bar Gauge（バーゲージ）
- **説明**: 各サービスのSLA達成率（パーセント）
- **閾値**:
  - 赤: 0-95%
  - 黄: 95-99%
  - 緑: 99%以上
- **用途**: SLA違反の早期検知

#### SLA達成率推移
- **タイプ**: Time Series（時系列グラフ）
- **説明**: SLA達成率の時系列推移
- **閾値ライン**: 95%（赤線）
- **用途**: SLA達成率の傾向分析

---

## 4. キャッシュパフォーマンス

キャッシュの効率を監視するセクションです。

### パネル一覧

#### キャッシュヒット率
- **タイプ**: Gauge（ゲージ）
- **説明**: キャッシュヒット率（パーセント）
- **閾値**:
  - 赤: 0-50%
  - 黄: 50-80%
  - 緑: 80%以上
- **用途**: キャッシュ効率の監視

#### キャッシュメモリ使用量
- **タイプ**: Stat（数値）
- **説明**: キャッシュが使用しているメモリ量
- **閾値**:
  - 緑: 0-10MB
  - 黄: 10-50MB
  - 赤: 50MB以上
- **用途**: キャッシュメモリ使用量の監視

#### キャッシュキー数
- **タイプ**: Stat（数値）
- **説明**: キャッシュに保存されているキーの総数
- **用途**: キャッシュサイズの監視

#### キャッシュエビクション率
- **タイプ**: Time Series（時系列グラフ）
- **説明**: キャッシュからエビクトされたキーの数（毎秒）
- **用途**: キャッシュ容量不足の検知

#### キャッシュヒット/ミス（エンドポイント別）
- **タイプ**: Time Series（時系列グラフ、積み上げ）
- **説明**: エンドポイント別のキャッシュヒット/ミス数
- **用途**: エンドポイント別のキャッシュ効率分析

#### キャッシュヒット率推移
- **タイプ**: Time Series（時系列グラフ）
- **説明**: キャッシュヒット率の時系列推移
- **閾値ライン**: 50%（赤線）
- **用途**: キャッシュパフォーマンスの傾向分析

---

## 5. データベースパフォーマンス

データベースクエリの状況を監視するセクションです。

### パネル一覧

#### データベースクエリ数（操作別）
- **タイプ**: Time Series（時系列グラフ）
- **説明**: SELECT、INSERT、UPDATE、DELETE操作別のクエリ数推移
- **用途**: データベース負荷の分析

#### データベースクエリ数（テーブル別）
- **タイプ**: Time Series（時系列グラフ）
- **説明**: テーブル別のクエリ数推移
- **用途**: 特定テーブルへの負荷分析

---

## 6. 認証・セキュリティ

認証とセキュリティ関連のメトリクスを監視するセクションです。

### パネル一覧

#### 認証エラー数
- **タイプ**: Time Series（時系列グラフ、積み上げ）
- **説明**: Unauthorized (401)、Forbidden (403)などのエラー数推移
- **用途**: 不正アクセス試行の検知

#### HTTPステータスコード分布
- **タイプ**: Time Series（時系列グラフ、割合表示）
- **説明**: 200、400、500番台のステータスコード分布
- **用途**: HTTPエラーパターンの分析

---

## 使用方法

### 基本操作

#### 時間範囲の変更
- ダッシュボード右上の時間セレクターをクリック
- プリセット（直近6時間、24時間、7日間など）を選択
- またはカスタム範囲を指定

#### 自動更新の設定
- 右上の更新間隔ドロップダウンから選択
- 5秒、10秒、30秒、1分、5分など

#### パネルの拡大表示
- パネルタイトルをクリック
- **View** を選択

#### データのエクスポート
- パネルタイトルをクリック
- **Inspect** > **Data** > **Download CSV**

### アラートの確認

ダッシュボード上部のベルアイコンで、発火中のアラートを確認できます。

### ダッシュボードの編集

1. 右上の **Settings** アイコンをクリック
2. パネルを追加、削除、移動
3. **Save dashboard** で保存

---

## トラブルシューティング

### データが表示されない

**原因**: Prometheusがメトリクスを収集できていない

**解決策**:
1. Prometheus UIで `http://localhost:9090/targets` を確認
2. ITSM Nexusバックエンドが稼働しているか確認
3. データソース設定を確認（Configuration > Data Sources）

### "N/A" と表示される

**原因**: 該当する時間範囲にデータが存在しない

**解決策**:
1. 時間範囲を直近に変更
2. ITSM Nexusシステムにアクティビティがあるか確認

### パネルのクエリエラー

**原因**: PromQLクエリが正しくない、またはメトリクス名が変更された

**解決策**:
1. パネルを編集モードで開く
2. クエリをPrometheus UIで直接テスト
3. メトリクス名を確認（`/api/metrics` エンドポイント）

---

## カスタマイズ

### 新しいパネルの追加

1. **Add panel** をクリック
2. PromQLクエリを入力
   ```promql
   # 例: 特定エンドポイントのリクエスト数
   sum(rate(itsm_http_requests_total{route="/api/incidents"}[5m]))
   ```
3. 可視化タイプを選択（Time Series、Stat、Gaugeなど）
4. パネル設定（タイトル、説明、閾値など）を調整
5. **Apply** をクリック

### 閾値の変更

1. パネルを編集モードで開く
2. 右側のパネルで **Thresholds** を選択
3. 値と色を調整

### アラートの追加

1. パネルを編集モードで開く
2. **Alert** タブを選択
3. **Create alert rule from this panel** をクリック
4. 条件と通知先を設定

---

## PromQLクエリ例

### リクエスト率
```promql
# 毎秒のリクエスト数
rate(itsm_http_requests_total[5m])

# メソッド別の合計リクエスト数
sum(rate(itsm_http_requests_total[5m])) by (method)
```

### エラー率
```promql
# 5xxエラー率（パーセント）
100 * sum(rate(itsm_http_requests_total{status_code=~"5.."}[5m]))
/ sum(rate(itsm_http_requests_total[5m]))
```

### レスポンスタイム
```promql
# P95レスポンスタイム
histogram_quantile(0.95,
  sum(rate(itsm_http_request_duration_seconds_bucket[5m])) by (le)
)
```

### キャッシュヒット率
```promql
# キャッシュヒット率の計算
100 * sum(rate(itsm_cache_hits_total[5m]))
/ (sum(rate(itsm_cache_hits_total[5m])) + sum(rate(itsm_cache_misses_total[5m])))
```

---

## ベストプラクティス

1. **定期的な監視**: 毎日ダッシュボードを確認し、異常な傾向を早期に発見
2. **アラート設定**: 重要なメトリクスにアラートを設定し、自動通知を受け取る
3. **長期傾向の分析**: 週次・月次でメトリクスを比較し、容量計画に活用
4. **カスタマイズ**: 組織のニーズに合わせてパネルを追加・調整
5. **バックアップ**: ダッシュボードのJSONをエクスポートして定期的にバックアップ

---

## 参考リンク

- [Grafana公式ドキュメント](https://grafana.com/docs/grafana/latest/)
- [PromQLチートシート](https://promlabs.com/promql-cheat-sheet/)
- [Grafanaダッシュボードベストプラクティス](https://grafana.com/docs/grafana/latest/best-practices/)

---

**バージョン**: 1.0.0
**最終更新**: 2025年1月7日
